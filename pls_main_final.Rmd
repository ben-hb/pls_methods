---
title: "Suicidality PLS Analysis"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

# LOAD PACKAGES
```{r Call packages}
library(assertive)
library(broom)
library(bmem)
library(car)
library(caret)
library(caTools)
library(clipr)
library(corrplot)
library(dgof)
library(effectsize)
library(emmeans)
library(emulator)
library(expss)
library(FactoMineR)
library(factoextra)
library(fastDummies)
library(graphics)
library(gvlma)
library(haven)
library(Hmisc)
library(knitr)
library(janitor)
library(lavaan)
library(lattice)
library(leaps)
library(magrittr)
library(MBESS)
library(mediation)
library(medmod)
library(missMDA)
library(multilevel) 
library(MVN)
library(mvord)
library(plspm)
library(pscl)
library(psych)
library(rcompanion)
library(readxl)
library(reshape2)
library(rockchalk)
library(rosetta)
library(rstatix)
library(semTools)
library(stargazer) 
library(stats)
library(stringr)
library(sure)
library(tidyverse)
library(tseries)
library(validate)
library(writexl)
```

# PREPARING FILES

```{r Filter sample, cache = TRUE}

#IMPORT file
 #data.raw <- read_excel("~/Desktop/Desktop_Home/UTAH/Stats_I/R_Studio/Dissertation_files/Sisler_dissertation_HMS1819_audit.xlsx",
   #                      range=cell_cols(1:1820), col_types = "text")
  
 #save("data.raw", file="~/Desktop/Desktop_Home/UTAH/Stats_I/R_Studio/Dissertation_files/Sisler_dissertation_HMS1819_audit.RData")
 load("~/Desktop/Desktop_Home/UTAH/Stats_I/R_Studio/Dissertation_files/Sisler_dissertation_HMS1819_audit.RData")
 #source("dissertation_fx.R")
```


``` {r data select}
data.v1 <- data.raw %>%
  mutate(age = as.numeric(age)) %>%
  filter(age < 26 & age >= 18) %>%   # exclusion criteria. Filter out under 18s, and over 26s
  select(-c(                         # narrowing columns numbers to reduce output matrices

    # demographic info
    educ_par1_rel, educ_par2_rel, timeclass, timestud, educ_par1, educ_par2, age_US, langpast, 
    langcur, age18:age41pl, educ_par, eductemp, educ_1:educ_4, age18_22, age31pl,
    # relationship info
    relship, relship_text, rel_sing:rel_divw,
    #  HMS-based
    SweepsIncentiveContact, endmessageSuicide, UniversityofSouthernCalifornia1a, consentFollowup1, excl_pers_oth_TEXT, 
    exp_rude,exp_accuse, exp_othersafraid, exp_ideaignore, exp_offendjoke, exp_stupid, exp_notserious, exp_superficial,
    exp_re_prof, exp_re_fear, exp_re_speakall,
    #  religious affiliations
    relig_aff_ag:relig_aff_oth, relig_aff_other_text, relig_1:relig_5,
    #  residence
    res_dorm:res_oth, residenc_text, deport_worry,
    #  degree categories
    degree_ass:degree_other_text, enroll_text, deg_ass:deg_nd,
    #  major/field choices
    field_hum:field_other, field_other_text,
    #  unused scales
    phq2_1, phq2_2,
    #  sex abuse/assault:
    ##  type
    assault_sex_stranger:assault_sex_dontknow, abuse_recent_perpet, sa_exp_touch:sa_exp_pen, 
    sa_suc_phyforc_1, sa_att_phyforc, sa_drunk_1, sa_suc_phyforc_2_1:sa_suc_phyforc_2_6, 
    sa_suc_phyforc_2_6_text, 
    ##  reporting
    sa_tell_1:sa_tell_12, sa_tell_12_text, sa_nodiscl_1:sa_nodiscl_24, sa_nodiscl_24_text,
    ##  person
    sa_who_1:sa_who_12, sa_who_12_text, sa_who_stud, sa_who_employ, sa_who_gender, sa_who_gender_text,
    ##  location/context
    sa_loc_on, sa_op_substance_1:sa_op_substance_5, sa_frighten, sa_loc_off, sa_perc_1:sa_perc_12, 
    sa_train_pol, sa_train_prev,
    #  sleep variables
    sleep_wk1, sleep_wd1, sleep_wk2, sleep_wd2, sleep_np1, sleep_np2,
    #  stress variables
    stress1:compet_field,
    #  D/O SUBTYPES:
    ##  mood
    dx_dk, dx_dep_1:dx_bip_4, dep_maj, dep_oth, dx_bip_bi1:dx_bip_oth, dep_imp1:dep_imp4,
    ##  anxiety
    dx_ax_1:dx_ax_7_new, dx_ax_6_text_new, dx_ax_ga:dx_ax_so,
    ##  OCD
    dx_ocd_1:dx_ocd_6, dx_ocd_6_text, dx_ocd_o:dx_ocd_oth,
    ##  trauma
    dx_trauma_1:dx_trauma_4, dx_trauma_4_text, dx_trauma_ptsd:dx_trauma_oth,
    ##  eating disorder
    dx_ea_1:dx_ea_4_text, ed_thin, weight_ideal, diet, ea_fast, purge_1:purge_4, ed_peer, 
    body_con_change, fresh15, weigh_freq, weight_ideal_text, dx_ea_an:dx_ea_av,
    ##  psychosis
    dx_psy_1:dx_psy_8, dx_psy_7_text, dx_psy_sa:dx_psy_sp,
    ##  substance-related
    dx_sa_1, dx_sa_2, dx_sa_3, dx_sa_2_text, sa_drunk_2_1:sa_drunk_2_7, 
    sa_drunk_2_6_text, sa_drunk_3:sa_drunk_6, alc_prob, sub_cig1:sub_cig5, sa_train_use:sa_sch_help,
    ##  personality d/o
    dx_perso_1:dx_perso_12, dx_perso_11_text,
    ##  SIBs
    sib_fre1:sub_cig,
    #  provider-related questions:  
    ther_helped_me, prov_1:prov_3, prov_7:prov_10, prov_9_text, anyprovi,
    #  insurance specifics
    ins_2:ins_10, ins_pare:ins_unce, ins_yesb, ins_mh1:ins_mh5, ins_ina_1:ins_ina_8_text,
    #  diet-related
    eatprac_1:eatprac_3, eatprac_frveg, eat_change, eat_change_how_1:eat_change_how_15, eat_change_how_15_text,
    #  SES
    fin_comp2, pay_worry, pay_fam, pay_self, pay_other, pay_grant, pay_loan, fincur_1:finpas_5,
    #  CCAPS
    CCAPS_1:CCAPS_34,
    #  CCMH:  
    sib_ccmh_1:suic_ccmh_6, cons_viol_ccmh_number, caus_viol_ccmh_number, exp_har_ccmh_number, 
    exp_trauma_ccmh_number, cons_viol_ccmh_recent, caus_viol_ccmh_recent, exp_har_ccmh_recent, 
    exp_trauma_ccmh_recent, trauma_ccmh_text, traumevent_ccmh_1, traumevent_ccmh_2, traumevent_ccmh_3, 
    traumevent_ccmh_4, traumevent_ccmh_5, traumevent_ccmh_6, traumevent_ccmh_7, traumevent_ccmh_8, 
    traumevent_ccmh_9, traumevent_ccmh_10, traumevent_ccmh_11, traumevent_ccmh_12, traumevent_ccmh_13, traumevent_ccmh_14, 
    traumevent_ccmh_15, traumevent_ccmh_16, traumevent_ccmh_15_text, binge_fr_ccmh,
    #  HMS-CCMH
    dep_CCMH_score_temp, dep_CCMH_score, dep_CCMH_elevated, dep_CCMH_mild, dep_CCMH_none, genanx_CCMH_score_temp,
    genanx_CCMH_score, genanx_CCMH_elevated, genanx_CCMH_mild, genanx_CCMH_none, socanx_CCMH_score_temp, 
    socanx_CCMH_score, socanx_CCMH_elevated, socanx_CCMH_mild, socanx_CCMH_none, eatconcerns_CCMH_score_temp,
    eatconcerns_CCMH_score, eatconcerns_CCMH_elevated, eatconcerns_CCMH_mild, eatconcerns_CCMH_none, dep_or_anx_CCMH,
    sib_ccmh_11:sib_ccmh_15, sib_ccmh_lifetime_any, sib_ccmh_pastyear,
    #  Qnum:  
    Q2_11, Q2_12, Q3_8, Q3_9, Q3_10_2, Q3_10_1, Q3_11_1, Q3_12_1:Q3_12_5, Q2_10_152:Q2_10_155, Q4_21_11, 
    Q9_19, Q9_20,
    #  health knowledge: 
    know_sp, dep_tx_know_1:dep_tx_know_4, dep_sx_know_1:dep_sx_know_4, anx_help_know_1:anx_help_know_4,
    ea_sx_know_1:ea_sx_know_6,
    #  therapy-related
    why_tx_1:why_tx_9_text, ther_lifetime, ther_lifetime2, ther_any, talk1_any, talk1_8_text, ther_any2, 
    knowwher1:knowwher6, bar_any:bar_plan, ther_help_me1:ther_help_me4, meds_help_me1:meds_help_me4, 
    talksup1:talksup4, talk2pro:talk2noo,
    #  SAT-related
    sat_hours_1, sat_loc_1, sat_qual_1, sat_priv_1, sat_sched_1, sat_hours_2, sat_loc_2, sat_qual_2, sat_priv_2, sat_sched_2, 
    sat_hours_3, sat_loc_3, sat_qual_3, sat_priv_3, sat_sched_3, sat_hours_4, sat_loc_4, sat_qual_4, sat_priv_4, sat_sched_4, 
    sat_hours_5, sat_loc_5, sat_qual_5, sat_priv_5, sat_sched_5, sat_hours_6, sat_loc_6, sat_qual_6, sat_priv_6, sat_sched_6, 
    sat_hours_7, sat_loc_7, sat_qual_7, sat_priv_7, sat_sched_7, sat_hours_8, sat_loc_8, sat_qual_8, sat_priv_8, sat_sched_8, 
    sat_hours_9, sat_loc_9, sat_qual_9, sat_priv_9, sat_sched_9, sat_hours_1_1:sat_hours_1_6, sat_loc_1_1:sat_loc_1_6, 
    sat_qual_1_1:sat_qual_1_6, sat_priv_1_1:sat_priv_1_6, sat_sched_1_1:sat_sched_1_6, sat_hours_2_1:sat_hours_2_6, 
    sat_loc_2_1:sat_loc_2_6, sat_qual_2_1:sat_qual_2_6, sat_priv_2_1:sat_priv_2_6, sat_sched_2_1:sat_sched_2_6, 
    sat_hours_3_1:sat_hours_3_6, sat_loc_3_1:sat_loc_3_6, sat_qual_3_1:sat_qual_3_6, sat_priv_3_1:sat_priv_3_6, 
    sat_sched_3_1:sat_sched_3_6, sat_hours_7_1:sat_hours_7_6, sat_loc_7_1:sat_loc_7_6, sat_qual_7_1:sat_qual_7_6, 
    sat_priv_7_1:sat_priv_7_6, sat_sched_7_1:sat_sched_7_6, sat_hours_8_1:sat_hours_8_6, sat_loc_8_1:sat_loc_8_6, 
    sat_qual_8_1:sat_qual_8_6, sat_priv_8_1:sat_priv_8_6, sat_sched_8_1:sat_sched_8_6,
    #  peer-related
    peer_alc_1, peer_alc_3, peer_alc_4, peer_mar_est, peer_alc_est, peer_cig_est, inf_7_text, risk_cig:risk_presc,
    #  pregnancy-related
    sex_partner, sex_partner_f, sex_partner_m, sex_partner_t, sex_30, sex_30_oral, sex_30_vag, sex_30_anal, 
    birthcontrol_1:birthcontrol_12, birthcontrol_10_text, birthcontrol_always, preg_no, preg_yes_u,preg_yes_in, 
    preg_dk, preg_cur,
    #  medication details
    meds_reason_1:meds_reason_5, meds_reason_5_text, meds_dis, meds_w_1:meds_w_5, meds_w_3_text, meds_cur_1:meds_cur_9, 
    meds_cur_7_text, meds_time_1:meds_time_7, med_help, meds_helped_me, meds_w_g:meds_di5,
    #  up/bystanding:
    inter_hy_dr, inter_hy_sa, inter_hy_hl, inter_y_1:inter_y_7, inter_y_6_text, inter_help, inter_n_1:inter_n_7, 
    inter_n_6_text, inter_n_why_1:inter_n_why_9, inter_n_why_9_text, witness_1:witness_7, witness_6_text, 
    inf_any:inf_oth,
    #  hypothetical:
    ther_help, talk2_1:talk2_7, talk2_7_text, talksup, percneed1:percneed_cur6, stig_t_I:stig_t_I6,
    #  misc:  
    bar_hs_1:bar_ns_8_text, smok_freq, sib_other_text, activ_other_text, knowwher_temp, exerc_changed, 
    exerc_changed_how, exerc_changed_how_text, height_ft, height_in, wgt_lbs, prov_A, prov_B, prov_C,  
    prov_loc, prov_olo, prov_oth, prov_dk, adjust_aca_1, adjust_aca_2,  s_c_1_1:s_c_5_6, 
    s_n_1_1:s_n_5_6))
```

# Call functions
```{r Functions}
# delogodd -- de-logs odds ratio when needed
delogodd <- function(x) {
  oddsratio <- exp(x)
  p <- oddsratio / (1 + oddsratio)
  return(p)
}

# NA_preproc -- helps format dataframes with NAs
NA_preproc <- function (dat) {
  for (j in 1:ncol(dat)) {
    x <- dat[[j]]
    if (is.factor(x) && anyNA(x)) dat[[j]] <- base::addNA(x)
    if (is.character(x)) dat[[j]] <- factor(x, exclude = NULL)
  }
  dat
}

# SEM visualization
plot_matrix <- function(matrix_toplot){
corrplot::corrplot(matrix_toplot, is.corr = FALSE,
               type = 'lower',
               order = "original",
               tl.col='black', tl.cex=.75)
  }
```


# OUTCOME VARIABLE

SUICIDAL IDEATION (si_type)
Creates indicator variable 'si_type' using the subtypes of suicidal ideation using sui_idea, sui_plan, sui_attempt, where: 
  0/0/0 = no SI
  1/0/0 = passive SI
  1/1/0 = active SI
  1/1/1 = volitional
+/- 'phq9_9' and 'sui_idea' into one variable -- suic_idea. Will run the end model twice.


```{r si_type}
data.v2 <- data.v1 %>%

# create si_type var
  mutate(si_type = case_when(sui_idea == 1 ~ 1,    # SI present
                             sui_idea == 0 ~ 0)) %>%  # no SI reported
  mutate(si_activ = case_when((sui_idea == 1 & sui_plan == 1) ~ 1,
                              (sui_idea == 1 & sui_plan == 0) ~ 0,
                              sui_idea == 0 ~ 0)) %>%
  filter(!is.na(si_type)) %>%  # filter for SI variable -- then rowwise deletion
  filter(!is.na(si_activ))  # filter for SI variable -- then rowwise deletion
  
data.v2$si_type <- as.logical(data.v2$si_type)  
data.v2$si_activ <- as.logical(data.v2$si_activ)  
  # tabulate and check output

table(data.v2$si_type, useNA = "always")
table(data.v2$si_activ, useNA = "always")
```



# PREMOTIVATION VARIABLES


```{r Diathesis frame}
data.v2 <- data.v2
```

## Age
```{r age}
data.v2$age <- as.numeric(data.v2$age)
hist(data.v2$age)

table(data.v2$age, useNA = "always")
jarque.bera.test(data.v2$age)

data.v2 <- data.v2 %>%
  mutate(undercls = case_when(age == 18 ~ 1, 
                              age == 19 ~ 1,
                              age == 20 ~ 0, 
                              age == 21 ~ 0, 
                              age == 22 ~ 0, 
                              age == 23 ~ 0, 
                              age == 24 ~ 0, 
                              age == 25 ~ 0))
data.v2$undercls <- as.logical(data.v2$undercls)
table(data.v2$undercls, useNA = "always")  
```

## Gender identity
```{r gender}
data.v3 <- data.v2 %>% 
  # Create 'gender' subtypes into one category
  mutate(gender = case_when((gender == 3 | gender == 4) ~ 3,     # transgender
                            (gender == 5 | gender == 6) ~ 2,     # gender diverse
                            (gender == 1 | gender == 2) ~ 1,     # cis-gender
                            FALSE ~ 4))                          # sets up non-answers
table(data.v3$gender)
  
  # transform into cisgender and non-cisgender
data.v3 <- data.v3 %>%  
  mutate(gender_tgd = case_when(gender == 2 ~ 1,
                                gender == 3 ~ 1,
                                gender == 1 ~ 0)) %>%
  filter(!is.na(gender))
data.v3$gender_tgd <- as.logical(data.v3$gender_tgd)
table(data.v3$gender_tgd, useNA = "always")
```

### Reconcile 'gender_text' 
```{r gender_text}
  # gender-diverse
data.v3$gender[str_detect(data.v3$gender_text, "[D|d]emi")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[B|b]inary")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[N|n]eutral")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[Q|q]ueer")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[F|f]luid")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[A|a]gender")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[A|a]ndrogynous")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[P|p]angender")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[B|b]igender")] <- 1
data.v3$gender[data.v3$gender_text %in% c("she/they", "Closeted genderfluid (female presenting)", "Pan-gender",
                                          "female / infinite star being / gender non conforming","He or they",
                                          "Not sure, nonbinary I guess", "Non-binary trans maculine", "No preference", 
                                          "Somewhere between GNC and transfemme", "She/they",
                                          "Non-binary leaning towards trans man")] <- 1

 #transgender
data.v3$gender[data.v3$gender_text %in% c("Transmasculine", "Trans-masculine person", "Trans Masculine", 
                                          "gender non-conforming trans man")] <- 1

  # male
data.v3$gender[str_detect(data.v3$gender_text, "[D|d]ude")] <- 0
data.v3$gender[str_detect(data.v3$gender_text, "[M|m]ale")] <- 0
data.v3$gender[str_detect(data.v3$gender_text, "[B|b]oy")] <- 0
data.v3$gender[data.v3$gender_text %in% c("Male: there are only 2 genders", "if you have a penis you're a male", 
                                          "Cisgender man", "Male motherfucker. stop making up gender shit.", "He-male",
                                          "I have male parts so therefore I am a MALE and there are only TWO genders!!!!!!!!!!!!!!!!!",
                                          "SATSYG (Savage about to steal yo girl", "My sex is male", 
                                          "I say male, but I think gender is fluid", "Theres only two genders, I'm male",
                                          "Probably heterosexual, but so commitment-phobic that I can't actually tell if I'm asexual.",
                                          "I'm a male. Born a male, always will be a male. There should only be two choices.")] <- 0

  # female
data.v3$gender[str_detect(data.v3$gender_text, "[F|f]emale")] <- 0
data.v3$gender[str_detect(data.v3$gender_text, "[W|w]oman")]  <- 0
data.v3$gender[str_detect(data.v3$gender_text, "[G|g]irl")]  <- 0
data.v3$gender[data.v3$gender_text %in% c("Male and Female are not genders, they are sexes. I identify as a woman.", 
                                          "Female, but currently going through a gender identity crisis!")] <- 0

  # questioning/other
data.v3$gender[str_detect(data.v3$gender_text, "[Q|q]uestioning")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[U|u]nsure")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "[I|i]dk")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "Hermaphrodite")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "Questioning")] <- 1
data.v3$gender[str_detect(data.v3$gender_text, "Undecided")] <- 1
data.v3$gender[data.v3$gender_text %in% c("Literally no clue as of late", "Kynigender", "Adrogynous", "Hermaphrodite", 
                                          "idk yet", "Questioning", "Questioning; female", "Still questioning", "Not sure",
                                          "not female/questioning", "Questioning (unsure)", "Girl ? Idk", "not sure", 
                                          "Not Sure???", "I don't know, still trying to purse it out", "Undecided")] <- 1

  # non-answers jokesters
data.v3$gender[str_detect(data.v3$gender_text, "[H|h]elicopter")] <- 4
data.v3$gender[str_detect(data.v3$gender_text, "[C|c]hinook")] <- 4
data.v3$gender[str_detect(data.v3$gender_text, "[A|a]pache")] <- 4
data.v3$gender[str_detect(data.v3$gender_text, "[U|u]nicorn")] <- 4
data.v3$gender[data.v3$gender_text %in% c("Albino stingray", "Karate Chop Action", "Flying Spaghetti Monster", "Pio Nono",
                                          "God", "None", "Baseball bat", "Mountain lion", "Oil Platform", "Chair", "Pizza", 
                                          "M1A1 Main Battle Tank", "Deppressed", "Fire hydrant/hockey puck", "Microwave",
                                          "This doesn't matter and you're an idiot for thinking it does.","REZZBIAN",
                                          "Baguette", "fairy", "a 5 year old girl", "tree", "unicorn", "His Majesty", 
                                          "Call of Duty: Modern Warfare 2", "Attack hellcopter", "Meme God", "AH-64D", 
                                          "Stainless Steel Toaster", "God himself", "baseball bat", "Mountain","Trans Former", 
                                          "Potato", "I will literally give you $100 to h*ck off", "Indian tape worm", 
                                          "Metallic Hyper-Entity", "2X4 treated lumber", "pizza", "sPecIaL SNowFlAkE", 
                                          "eh", "George Michael", "Metaknight Main", "Sea turtle", "I identify as a fruit cup",
                                          "The Senate", "1941 Nihon Giagun Yamato-Class Battleship", "Attack Hellicopter", 
                                          "penguin wearing a sombrero and sunglasses")] <- 4

  # non-answers, decline to answer
data.v3$gender[str_detect(data.v3$gender_text, "[D|d]ecline")] <- "non-answers"
data.v3$gender[data.v3$gender_text %in% c("I am me. A human.", "I'm not yet sure where I identify", "Human-being", "genders", 
                                          "okay", "guess", "none", "Just my name.", "the above options are sex, not genders", 
                                          "the above options are sex, not genders", "its difficult", "any", "?", 
                                          "Biological male who identifies as a lesbian female.", "Prefer not to answer",
                                          "The universe conscious of itself",  "no",  "I only try to use gender when it's useful", 
                                          "fuck gender", "Gender and sex are the same", "gender is a lie", "#love", "No",
                                          "it's weird to separate out trans male and trans female if you're also asking for birth assignment.", 
                                          "2 genders", "I don't understand the question.", "Prefer not to specifiy",
                                          "'Male' and 'female' are not gender identities.",
                                          "I don't have one because it's not a legitimate concept.", 
                                          "Gender is a construct which serves no purpose.")] <- 4

data.v3 <- data.v3 %>%
  filter(!is.na(gender_tgd))

table(data.v3$gender_tgd, useNA = "always")   # check output
```

### Interaction effects for gender
``` {r gender_interxn}

## Interaction effect for transgender
#data.v3 <- data.v3 %>%   # fix directionality
#  mutate(cli_TQ  = case_when(cli_TQ  == 1 ~ 5,   # welcoming
#                             cli_TQ  == 2 ~ 4,
#                             cli_TQ  == 3 ~ 3,
#                             cli_TQ  == 4 ~ 2,
#                             cli_TQ  == 5 ~ 1))  # hostile
#table(data.v3$cli_TQ, useNA = "always")
table(data.v3$discrim, useNA = "always")

## interaction effect for women
#data.v3 <- data.v3 %>%   # fix directionality
#  mutate(cli_women = case_when(cli_women  == 1 ~ 5,   # welcoming
#                                   cli_women  == 2 ~ 4,
#                                   cli_women  == 3 ~ 3,
#                                   cli_women  == 4 ~ 2,
#                                   cli_women  == 5 ~ 1))  # hostile
#table(data.v3$cli_women)
```

## Sexual Identity
```{r sexual}
data.v4 <- data.v3 %>%
  # aggregates all 'sexual' answers into one var
  mutate(
    sexual = case_when(sexual_queer == 1 ~ 1,        # queer
                       sexual_bi == 1 ~ 1,           # bisexual
                       sexual_l == 1 ~ 1,            # lesbian 
                       sexual_g == 1 ~ 1,            # gay
                       sexual_quest == 1 ~ 1,        # questioning
                       sexual_h == 1 ~ 0,            # heterosexual
                       sexual_other == 1 ~ 1)        # other
) 
data.v4$sexual <- as.logical(data.v4$sexual)
table(data.v4$sexual, useNA = "always") # tabulate and check outputs
```

### Reconcile sexual_text
```{r sexual_text}
# identifying non-answers
  ## jokesters
data.v4$sexual[str_detect(data.v4$sexual_text, "[H|h]elicopter")] <- NA
data.v4$sexual[data.v4$sexual_text %in% c("Yes", "i identify as a lamp", "I only like baseballs", "helisexual", "Autosexual",
                                          "now", "Miguel Garcia", "toasteroven", "must have gills", "Potsexual", "Bobcats",
                                          "Tailpipes turn me on", "Tyrannosaurus rex", "Traps are not gay", "Toaster sexual",
                                          "Crooked", "Pantsexual", "FREE", "Frozen Foods", "Giraffe", 
                                          "I'm sexually attracted to fire",  "Attracted to Vehicles", "sPecIaL SNowFlAkE",
                                          "Attracted to other self-identifying flying spaghetti monsters",  
                                          "Demiqueer quasiflux asexual foxkin", "I sleep around. Also into bestiality",  
                                          "Sexually attracted to kitchen appliances", "Elitistual. I'm into elitists",
                                          "sexually attracted to fictional characters and men twice my age")] <- NA
  ## declined to answer
  data.v4$sexual[str_detect(data.v4$sexual_text, "identi[t|f]y")] <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "label")] <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "matter")]  <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "[W|w]hatever")]  <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "box myself")]  <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "[D|d]ecline")] <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "[N|n]ormal")]  <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "[D|d]isclose")]  <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "[N|n]one")]  <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "[U|u]nknown")]  <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "[N|n]/[A|a]")]  <- NA
  data.v4$sexual[str_detect(data.v4$sexual_text, "[I|i] like")]  <- NA
  data.v4$sexual[data.v4$sexual_text %in% c("dating a trans male", "Attracted to personalities, not genders", "non",
                                            "irrelevant", "i like people", "Fuck sexuality", "personality based", 
                                            "Don't think about it too much", "Anyone that I like", "leave me alone",
                                            "define", "This is more bullshit", "No", "Me", "I am who I am", "Just there",
                                            "Don't care", "no label", "No Label", "No labels", "No", "Me",
                                            "Questions like this are the reason we are even having this debate.", 
                                            "i like who i like", "prefer not", "I do not understand why this is necessary",
                                            "Just there", "non", "Normal", "Human Being", "human being", "Closeted at home", 
                                            "It doesn't matter my question is why is this an actual question", 
                                            "I hate this PC bs", "FUCK YOU BIG TIME", "Polyamorous", "gay leaning bi",
                                            "Sexuality shouldn't matter", "No preference", "i like boys.", 
                                            "other", "Prefer not to specify", "i fall in love with a human being",
                                            "everyone's a little gay", "I prefer men, but have had women before", 
                                            "Traps are not gay", "Unknown", "#love", "Whatever I feel like at the time",
                                            "Situational",  "No one right now", "sometimes i dabble", "People", "Prefer not",
                                            "I am", "Whatever Happens", "Crooked", "love is love", "Open", "Autistic",
                                            "Human", "No one right now", "Situational", "I don't", "?", "Undefined", 
                                            "The universe conscious of itself", "Aromantic", "Repressed", "Never had sex",
                                            "Not dealing with men or women at the moment", "not sure", "Not sure",
                                            "None?", "neutral",  "no sexual orientation", "No idea, but I'm not straight",
                                            "Unlabeled", "Curious", "Anyone that I like", "Disinterested", "Do not define",
                                            "Fake Gay", "irrelevant", "People", "no particular sexual identity", 
                                            "No preference", "love is love", "there is no such thing", 
                                            "Sometimes gender doesn't matter and I don't have time to learn about these things life gets too busy",
                                            "Prefer not to answer", "just sexual (need no prefix!)", "It's complicated", 
                                            "Sexuality shouldn't matter", 
                                            "I'm just me and I love who I love. I don't like these labels.",
                                            "I'm not a fucking part of lgbtqrstuxyz bullshit association")]  <- NA
  
    # identifying queer  individuals:
data.v4$sexual[str_detect(data.v4$sexual_text, "[Q|q]ueer")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[F|f]luid")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[O|o]pen")] <- 1
data.v4$sexual[data.v4$sexual_text %in% c("potentially interested", "somewhere between", "homoflexible", "heteroflexible",
                                          "fluid", "Only other trans people", "non-binary", "so I guess I could check queer",
                                          "Androsexual", "Not straight", "Polysexual", "Joto", "Non-binary", "nonbinary",
                                          "Attracted to masculinity and androgony", "Androsexual")] <- 1

  # identifying questioning
data.v4$sexual[str_detect(data.v4$sexual_text, "[Q|q]uestion")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[P|p]robably")] <- 1
data.v4$sexual[data.v4$sexual_text %in% c("possibly", "curious", "Unknown", "potentially interested", "don't know", "Unknown", 
                                          "don't know", "not sure", "still figuring it out", "idk", "Idk",  "don't know", 
                                          "I have a girlfriend but i am not attracted to any other females. I am attracted to males", 
                                          "Sometimes gender doesn't matter and I don't have time to learn about these things life gets too busy",
                                          "Not sure. Working on it.")] <- 1

  # identifying  pansexual write-ins
data.v4$sexual[str_detect(data.v4$sexual_text, "[P|p]an")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[S|s]apiosexual")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[S|s]apiosexual")] <- 1
data.v4$sexual[data.v4$sexual_text %in% c("all", "Polyamorous Pansexual", "Pan Sexual", "Pan-sexual", 
                                          "any but ive only had relationships with men")] <- 1

  # identifying asexual / demisexual write-ins:  
data.v4$sexual[str_detect(data.v4$sexual_text, "[G|g]r[a|e]y")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[N|n]onsexual")] <-1
data.v4$sexual[str_detect(data.v4$sexual_text, "[C|c]elibate")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[D|d]emi")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[A|a]sex")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[C|c]elibate")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[A|a]ce")] <- 1
data.v4$sexual[data.v4$sexual_text %in% c("Mostly asexual", "Most likely asexual", "Masexual", "Tridium Vykon Jace 8000", 
                                          "Demi-romantic", "asexual lesbian", "Ase", "Bi-demisexual", "A sexual",
                                          "Hetroromantic Asexual", "Demiqueer quasiflux asexual foxkin", "DemiAsexual",
                                          "a-sexual", "no sexual attraction", "a sexual", "Homoromantic Demisexual",
                                          "Gay-ish, I am Demi-sexual which means I don't pay attention to sex/gender", 
                                          "experience no sexual attraction but do experience a small amount of romantic attraction", 
                                          "lithromantic", "Pan-Quoiromantic Asexual", "demiromantic asexual")] <- 1

  # identifying heterosexual individuals
data.v4$sexual[str_detect(data.v4$sexual_text, "[H|h]etero")] <- 0
data.v4$sexual[str_detect(data.v4$sexual_text, "[S|s]traight")] <- 0
data.v4$sexual[str_detect(data.v4$sexual_text, "[H|h]etrosex")] <- 0
data.v4$sexual[data.v4$sexual_text %in% c("Kinsey scale 1", "I would put myself as a 1-1.5 on the kinsey scale", "Staight", 
                                          "Stragiht", "strait", "Str8!!!!", "Changing from gay to heterosexual",
                                          "Gynophilic", "Into females", "I fuck bitches.", "1 on the Kinsey Scale",
                                          "Gynophilic", "gynosexual", "Changing from gay to heterosexual", "100% Hetro")] <- 0

  # identified as gay or lesbian
data.v4$sexual[str_detect(data.v4$sexual_text, "[G|g]ay")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[H|h]omoflexible")] <- 1
data.v4$sexual[data.v4$sexual_text %in% c("Mostly gay", "soooooo gay", "Romantically straight and sexually gay")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[L|l]esbian")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[D|d]yke")] <- 1

  # identifying bisexual individuals
data.v4$sexual[str_detect(data.v4$sexual_text, "[B|b]isex")] <- 1
data.v4$sexual[str_detect(data.v4$sexual_text, "[B|b]icurious")] <- 1
data.v4$sexual[data.v4$sexual_text %in% c("I'm straight but I like girls too sexually, not emotionally.", "Half bisexual", 
                                          "straight but DTF sexy females", "bicurious but i like girls more", 
                                          "hetero with occasional bi tendencies", "gay leaning bi", "Bi-curious", 
                                          "Herero-romantic bisexual", "Bi with a stronger attraction to same sex",
                                          "I'm like halfway to bisexual. Never had a crush on another girl but I'm still interested. Idk.",
                                          "No boundaries in place - though probably bisexual")] <- 1

table(data.v4$sexual)   # tabulate and check outputs
```

### 'Sexual' transformed 
sexual identity: (1) heterosexual; (2) lesbian/gay/bisexual; (3) queer/pan/asex/other, and (4) non-answers
```{r sexual regroup}
data.v5 <- data.v4 %>%
  # aggregates all 'sexual' answers into one var
  mutate(sexual = ifelse(sexual == 1, 1, 0)) %>%
  filter(!is.na(sexual))

data.v5$sexual <- as.logical(data.v5$sexual)

table(data.v5$sexual, useNA = "always") # tabulate and check outputs
```

### Interaction effects for sexual identity
``` {r sex_interxn}
# interaction effect for LCB
data.v5 <- data.v5 %>%   # fix directionality
  mutate(cli_LGB  = case_when(cli_LGB  == 1 ~ 5,   # welcoming
                             cli_LGB  == 2 ~ 4,
                             cli_LGB  == 3 ~ 3,
                             cli_LGB  == 4 ~ 2,
                             cli_LGB  == 5 ~ 1))  # hostile

table(data.v5$cli_LGB, useNA = "always")
table(data.v5$social_sexid, useNA = "always")
```

## hours of work/wk
```{r paid_work}
#table(data.v5$hours_work_paid)
data.v5$hours_work_paid <- as.integer(data.v5$hours_work_paid)

data.v5 <- data.v5 %>%
  mutate(
    days_work_paid = case_when(hours_work_paid == 0 ~ 0,        # no paid work
                                hours_work_paid < 0 ~ 7,        # nonsense answer
                                hours_work_paid > 60 ~ 7,       # nonsense answer
                                hours_work_paid < 9 ~ 1,        # 1-8 hrs/wk
                                hours_work_paid < 19 ~ 2,       # 9-18 hrs/wk
                                hours_work_paid < 25 ~ 3,       # 19-24 hrs/wk
                                hours_work_paid < 33 ~ 4,       # 25-32 hrs/wk
                                hours_work_paid < 41 ~ 5,       # 33-40 hrs/wk
                                hours_work_paid > 40 ~ 6)) %>%  # > 40 hrs/wk
  filter(!is.na(hours_work_paid))

table(data.v5$days_work_paid, useNA = "always") # tabulate and check output
```

## Child dependents
```{r children}
data.v5 <- data.v5 %>%
  mutate(children_dep = ifelse(children_dep > 1, 1, 0))  %>%  # make a logical variable
  filter(!is.na(children_dep))

table(data.v5$children_dep, useNA = "always") # tabulate and check output

```

## Subjective weight and body image
```{r body_sr}
data.v5$body_sr <- as.numeric(data.v5$body_sr)

data.v5 <- data.v5 %>%
  filter(!is.na(body_sr))

table(data.v5$body_sr, useNA = "always") # tabulate and check output
```

## Race
```{r race}  
data.v6 <- data.v5 %>% 
# 'race' subtypes combined into one variable
  mutate(race = case_when(race_bla == 1 ~ 2,
                          race_ame == 1 ~ 5,
                          race_asi == 1 ~ 4,
                          race_his == 1 ~ 3,
                          race_pac == 1 ~ 5,
                          race_ara == 1 ~ 5,
                          race_whi == 1 ~ 1,
                          race_oth == 1 ~ 5,
                          FALSE ~ 5))  %>%  
  filter(!is.na(race))    # filter out NAs for complete data

table(data.v6$race, useNA = "always")  # double check NA output
```

### Race write-in reconcilation
```{r race reconciliation}
  #decline to answer
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]merica")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[H|h]uman")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[N|n]one")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]erson")] <- 5
data.v6$race[data.v6$race_other_text %in% c("prefer not to say", "Prefer not to answer.", "Prefer not to specify", 
                                            "Prefer not to answer :)", "FUCK YOU", "Caramel American", "Why", "irrelevant",
                                            "Prefer not to state", "Prefer no to say", "Brown", "No thx", "Texan", 
                                            "Race is a problematic social construct", "Race is a socual construct", 
                                            "Transcendent", "Race/ethnicity should not matter", "Prefer not to answer", 
                                            "why is this a thing", "White passing, ethnically other", "unfortunately", 
                                            "While I understand the socio-economic conditions that surround race, race also is a construct which serves no purpose.",
                                            "Wakanda Forever", "whatever I can use to be a victim in the given situation", 
                                            "We need to get rid of these color things",  "Me", "I do Not identify racially", 
                                            "Why is there always a race question? Can't we all just be one race? The Human Race.",  
                                            "Will not disclose",  "Race/ethnicity should not matter", "N/a", "N/A", 
                                            "There is only one human race: Homo sapien", "Citizen of the World",
                                            "don't know due to uncertainity of lineage", "I choose not to answer",
                                            "This doesn't matter and you're an idiot for thinking it does.",  
                                            "POC because now my opinion will matter in the US", 
                                            "Color doesn't mean anything right? Why do so many surveys ask it",
                                             "My skin is lighter than others, and darker than some", 
                                            "I am not a racial identifying person. I am American. My DNA says something about Korean heritage.",
                                             "I do not identify as a race in order to promote social equality for all races",
                                            "I don't think race is all that important.", 
                                            "I do not think that this information should or does make a difference ,so, I chose to not state", 
                                            "A White, Cherokee, European, Irish man who would be preferred to be called else but white",
                                            "I won't allow my race to be used in this study for potential insidious usage")]  <- 5

  # Jokesters
data.v6$race[data.v6$race_other_text %in% c("Volvo", "Vulcan", "Snowman", "tree", "General Electric", "Cat", "Earthling", 
                                            "I have rainbow skin.", "jedi", "Light skinned potato", "I'm stainless steel.", 
                                            "7-foot tall Chinese woman", "A little tan.", "Apache helicopter", "Aptenodytes",
                                            "Wood", "moon man", "Black hawk", "Aviation Heritage", "Ewok", "Aptenodytes",
                                            "Desert Camoflauge",  "Attack helicopter", "Ethnic Kekistani")] <- 5

  # white
data.v6$race[str_detect(data.v6$race_other_text, "[J|j]ew")] <- 1  # if Israeli, could be White, Asian, or ME (e.g. Palestine)
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]shkenazi")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[C|c]aucasian")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[E|e]uropean")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[G|g]reek")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[I|i]rish")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[I|i]talian")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]lbania")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]em[e|i]tic")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[R|r]ussian")] <- 1 # could be Asian depending on region
data.v6$race[str_detect(data.v6$race_other_text, "[R|r]oma")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[T|t]urkish")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]lavic")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[M|m]etis")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[B|b]asque")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]icilian")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]olish")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]candinavian")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[F|f]innish")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[C|c]eltic")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]cottish")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[C|c]anad")] <- 1
data.v6$race[str_detect(data.v6$race_other_text, "[M|m]editerranean")] <- 1
data.v6$race[data.v6$race_other_text %in% c("please refer to me as Caucasian; it's extremely offensive to refer to every race-- excluding Caucasians-- in their politically correct form",
                                            "Not sure if I'm Hispanic, as I am Portuguese and Spanish (from my mother's side) . I identify as white as I am of European descent.",
                                            "Portugese", "Cape Verdean", "Capeverdean", "Bulgarian-American", "Ginger", 
                                            "Anglo Saxon", "anglo/white", "Balkan for ethnicity", "Ulster-scots", 
                                            "I'm white, but I do have some Native American in me but it's not the dominant visible ethnicity.", 
                                            "White (Jewish/Jamaican-Chinese/Irish)", "ARMENIAN")] <- 1
  # Identifies as American Indian or other indigenous descent
data.v6$race[str_detect(data.v6$race_other_text, "[N|n]ative [A|a]merican")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[I|i]ndigenous")] <- 5
data.v6$race[data.v6$race_other_text %in% c("I look white but im also status native", "Indigenous/Mestizo", 
                                            "american indian that isn'y legally claimed")] <- 5
  # Identifies as Asian
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]sian")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[C|c]hinese")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[J|j]apanese")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[I|i]ndian")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[B|b]anglades")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[F|f]ilipino")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[G|g]uyanese")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[M|m]ongolia")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[C|c]hina")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]outheast")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]outh [A|a]sian")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]unjabi")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]iberia")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[I|i]ndonesia")] <- 4
data.v6$race[str_detect(data.v6$race_other_text, "[W|w]est [I|i]ndian")] <- 4
data.v6$race[data.v6$race_other_text %in% c("Sri Lankan", "Sri-Lankan", "Malays", "Chinese Ethinicy-Nuosu", "Austronesian",
                                            "third culture kid, born and raised in asia until 18yo", "Central Asian",  
                                            "Indian, UAE native", "Indian/Subcontinental", "Indians arent on the list.....", 
                                            "American Texan of Indian (South asia) Descent", "Okinawan", "Asian/Chinese",
                                            "Japanese American and Native Hawaiian Culture", "Asian. International.", 
                                            "Australian/Indian","Indo-Caribbean",  "Atlantic Islander", 
                                            "Telugu-speaking Tamil-ethnicity Indian")] <- 4
  # Identifies as Black
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]frican")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]fro")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[K|k]enya")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[B|b]lack")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[C|c]arribean")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[B|b]ahamian")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[H|h]aitian")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[H|h]aitian")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[J|j]amaica")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[Z|z]imbabwea")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[G|g]hana")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[E|e]thiopia")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[T|t]rinidad")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[E|e]ritrean")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[W|w]akanda")] <- 2
data.v6$race[str_detect(data.v6$race_other_text, "[N|n]igerian")] <- 2
data.v6$race[data.v6$race_other_text %in% c("Cameroonian American", "Creole", "Jamacian American", "North Africa")] <- 2

  # Identifies as Hispanic
data.v6$race[str_detect(data.v6$race_other_text, "[M|m]exican")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[X|x]ican[o|a]")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[L|l]atin[o|a]")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]uerto [R|r]ican")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[S|s]panish")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[C|c]hican[o|a]")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[I|i]berian")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[M|m]estiz[o|a]")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]ortuguese")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[B|b]razil")] <- 3
data.v6$race[str_detect(data.v6$race_other_text, "[C|c]uba")] <- 3
data.v6$race[data.v6$race_other_text %in% c("Costa Rican", "Central American Native", "Andean")] <- 3

  # Identifies as Middle Eastern or of Arab descent
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]rmenia")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]akistani")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]rab")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]ersian")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]alestin")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[I|i]srael")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]fghan")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[N|n]orth [A|a]frica")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[H|h]azara")] <- 5
data.v6$race[data.v6$race_other_text %in% c("Northern African; Moroccan; Israeli", "Arab Mix", "Berber/North African", 
                                            "Coptic Egyptian (non-Arab)", "Kekistani")] <- 5

  # Identifies all other data or mixed ethicity
data.v6$race[str_detect(data.v6$race_other_text, "[B|b]iracial")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[B|b]i-racial")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[M|m]ix")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[H|h]alf")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[I|i]ndo-[C|c]arribean")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[M|m]ulti")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[M|m]ulatto")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[P|p]anda")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[O|o]ther")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[U|u]nkown")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]mbiguous")] <- 5
data.v6$race[str_detect(data.v6$race_other_text, "[A|a]mbiguous")] <- 5
data.v6$race[data.v6$race_other_text %in% c("Sub Asian/East African", "two or more races", "Moroccan Mexican",
                                            "Transracial", "Adopted", "Part Thetan", "Taiwanese-Greek-Cypriot American",
                                            "East Indian, Caribbean", "50/50", "Korean Ecuadorian", "Brazilian, Luso,
                                            Native American", "Central American/ Caribbean", "Asian/Indian",
                                            "Mut (more than 3)",  "mexican,filipino, italian", "Black Hispanic",
                                            "Middle Eastern, Filipino and Spanish",  "East Indian, Caribbean",
                                            "Indo-Portugesse (Fijian/Portugesse) Canadian Born", "Multiple",
                                            "White and American Indian (Choctaw)", "White, Black, and Hispanic",
                                            "White, black, Native American",  "French Lebanese", "Mixed Race", 
                                            "Lebanese, German, French", "Black/Asian", "Mixed", "Portuguese/Thai", 
                                            "An American Mutt- a bit of everything somewhere in there", 
                                            "Black and native", "Black/cuban",  "Filipino and Portuguese", "mixed race",
                                            "Eastern Indian/white", "white middle eastern", "Transracial",
                                            "German, Chinese, Arabic, Melanesian", "Hispanic and Middle Eastern",
                                            "mulatto", "mixed & south american",  "international", "Biracial",
                                            "Multiracial",  "Korean Ecuadorian", "Central American/ Caribbean",
                                            "An American Mutt- a bit of everything somewhere in there")] <- 5
  # Identifies as black and white as 'Other/Mixed'
data.v6$race[data.v6$race_other_text %in% c("Black/White","White/African American", "White/African American")] <- 5
  # Identifies as Asian and White as 'Other/Mixed'
data.v6$race[str_detect(data.v6$race_other_text, "[E|e]urasian")] <- 5
data.v6$race[data.v6$race_other_text %in% c("Japanese, Chinese, French, British, Greek", "Asian/White",
                                            "Asian/European", "Asian and White", "asian and white",  
                                            "White (Caucasian) and Indian (S. Asia)", "Chinese/White",
                                            "American/Asian African/American White", "3/4 White, 1/4 Japanese", 
                                            "White & Asian", "Chinese and White")] <- 5
  # Identifies as Hispanic and White as 'Other/Mixed'
data.v6$race[data.v6$race_other_text %in% c("I am 1/4th Hispanic 3/4 German",  "Honduran, Irish", "White hispanic",
                                            "White, and Hispanic", "Hispanic/Jewish", "White and Hispanic", "White Hispanic",
                                            "French and spanish", "LATINA/WHITE", "white/hispanic",
                                            "If I identify as puerto rican does that mean i get more scholarship money?")] <- 5
	 # Identifies as MR and White as 'Other/Mixed'
data.v6$race[data.v6$race_other_text %in% c("Half Middle Eastern half white", 
                                            "Half my family is white and the other middle eastern")] <- 5

# tabulate and check outputs
table(data.v6$race, useNA = "always")

hist(data.v6$race)  # visualize distribution and skew

```

## Possible interaction effects for race
``` {r race_intrxn}
# possible interaction effect
data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_nonwhite  = case_when(cli_nonwhite  == 1 ~ 5,   # welcoming
                                   cli_nonwhite  == 2 ~ 4,
                                   cli_nonwhite  == 3 ~ 3,
                                   cli_nonwhite  == 4 ~ 2,
                                   cli_nonwhite  == 5 ~ 1))  # hostile

data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_black  = case_when(cli_black  == 1 ~ 5,   # welcoming
                                   cli_black  == 2 ~ 4,
                                   cli_black  == 3 ~ 3,
                                   cli_black  == 4 ~ 2,
                                   cli_black  == 5 ~ 1))  # hostile

data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_ainaan  = case_when(cli_ainaan  == 1 ~ 5,   # welcoming
                                   cli_ainaan  == 2 ~ 4,
                                   cli_ainaan  == 3 ~ 3,
                                   cli_ainaan  == 4 ~ 2,
                                   cli_ainaan  == 5 ~ 1))  # hostile

data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_asian  = case_when(cli_asian  == 1 ~ 5,   # welcoming
                                   cli_asian  == 2 ~ 4,
                                   cli_asian  == 3 ~ 3,
                                   cli_asian  == 4 ~ 2,
                                   cli_asian  == 5 ~ 1))  # hostile

data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_sai  = case_when(cli_sai  == 1 ~ 5,   # welcoming
                                   cli_sai  == 2 ~ 4,
                                   cli_sai  == 3 ~ 3,
                                   cli_sai  == 4 ~ 2,
                                   cli_sai  == 5 ~ 1))  # hostile

data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_his  = case_when(cli_his  == 1 ~ 5,   # welcoming
                                   cli_his  == 2 ~ 4,
                                   cli_his  == 3 ~ 3,
                                   cli_his  == 4 ~ 2,
                                   cli_his  == 5 ~ 1))  # hostile

data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_mides  = case_when(cli_mides  == 1 ~ 5,   # welcoming
                                   cli_mides  == 2 ~ 4,
                                   cli_mides  == 3 ~ 3,
                                   cli_mides  == 4 ~ 2,
                                   cli_mides  == 5 ~ 1))  # hostile

data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_pi  = case_when(cli_pi  == 1 ~ 5,   # welcoming
                                   cli_pi  == 2 ~ 4,
                                   cli_pi  == 3 ~ 3,
                                   cli_pi  == 4 ~ 2,
                                   cli_pi  == 5 ~ 1))  # hostile

data.v6 <- data.v6 %>%   # fix directionality
  mutate(cli_white  = case_when(cli_white  == 1 ~ 5,   # welcoming
                                   cli_white  == 2 ~ 4,
                                   cli_white  == 3 ~ 3,
                                   cli_white  == 4 ~ 2,
                                   cli_white  == 5 ~ 1))  # hostile

table(data.v6$social_re, useNA = "always")
table(data.v6$cli_nonwhite, useNA = "always")
table(data.v6$cli_black, useNA = "always")
table(data.v6$cli_asian, useNA = "always")
table(data.v6$cli_his, useNA = "always")
table(data.v6$cli_white, useNA = "always")

```

## Interaction variables for identity'
``` {r dei_campus}
data.v6$hostile_friendly <- as.numeric(data.v6$hostile_friendly)
data.v6$uncoop_coop <- as.numeric(data.v6$uncoop_coop)
data.v6$notwelc_welc <- as.numeric(data.v6$notwelc_welc)
data.v6$disresp_resp <- as.numeric(data.v6$disresp_resp)
data.v6$uncomfort_comfort <- as.numeric(data.v6$uncomfort_comfort)

data.v6 <- data.v6 %>%   # fix directionality
  mutate(hostile_friendly = case_when(hostile_friendly == 1 ~ 5,   # very hostile
                                      hostile_friendly == 2 ~ 4,
                                      hostile_friendly == 3 ~ 3,
                                      hostile_friendly == 4 ~ 2,
                                      hostile_friendly == 5 ~ 1))  # very friendly

data.v6 <- data.v6 %>%   # fix directionality
  mutate(uncoop_coop = case_when(uncoop_coop == 1 ~ 5,   # very uncooperative
                                 uncoop_coop == 2 ~ 4,
                                 uncoop_coop == 3 ~ 3,
                                 uncoop_coop == 4 ~ 2,
                                 uncoop_coop == 5 ~ 1))  # very cooperative

data.v6 <- data.v6 %>%   # fix directionality
  mutate(notwelc_welc  = case_when(notwelc_welc == 1 ~ 5,   # not welcome
                                   notwelc_welc == 2 ~ 4,
                                   notwelc_welc == 3 ~ 3,
                                   notwelc_welc == 4 ~ 2,
                                   notwelc_welc == 5 ~ 1))  # very welcome

data.v6 <- data.v6 %>%   # fix directionality
  mutate(disresp_resp  = case_when(disresp_resp == 1 ~ 5,   # disrespectful
                                   disresp_resp == 2 ~ 4,
                                   disresp_resp == 3 ~ 3,
                                   disresp_resp == 4 ~ 2,
                                   disresp_resp == 5 ~ 1))  # very respectful

data.v6 <- data.v6 %>%   # fix directionality
  mutate(uncomfort_comfort   = case_when(uncomfort_comfort == 1 ~ 5,   # uncomfortable
                                         uncomfort_comfort == 2 ~ 4,
                                         uncomfort_comfort == 3 ~ 3,
                                         uncomfort_comfort == 4 ~ 2,
                                         uncomfort_comfort == 5 ~ 1))  # comfortable


# dei campus culture as a mediator
data.v6$dei_campus <- (data.v6$hostile_friendly + data.v6$uncoop_coop + data.v6$notwelc_welc + data.v6$disresp_resp + data.v6$uncomfort_comfort)/5

table(data.v6$dei_campus, useNA = "always")  # use for NA changes

```

## SIBs and frequency
``` {r sib_any}
data.v7 <- data.v6 %>%
  mutate(sib_freq = case_when(sib_none == 1 ~ 0,    # none
                              sib_freq == 1 ~ 0,    # 1-2x/yr
                              sib_freq == 2 ~ 1,    # <1x/mo
                              sib_freq == 3 ~ 1,    # 2-3x/mo
                              sib_freq == 4 ~ 2,    # 1-2x/wk
                              sib_freq == 5 ~ 2,    # 3-5x/wk
                              sib_freq == 6 ~ 3)) %>%  # almost everyday
  filter(!is.na(sib_freq))  # filter for NAs
#data.v7$sib_freq <- as.logical(data.v7$sib_freq)  # move frequency to numeric class

table(data.v7$sib_freq, useNA = "always")  # use for NA changes
data.v7 = subset(data.v7, select= -c(sib_none:sib_oth)) # clean up vars/columns
```


## Past finances
```{r finpast}
data.v7 <- data.v7 %>%
  mutate(finpast = case_when(finpast == 5 ~ 1,
                             finpast == 4 ~ 2,
                             finpast == 3 ~ 3,
                             finpast == 2 ~ 4,
                             finpast == 1 ~ 5)) %>%
  filter(!is.na(finpast))

table(data.v7$finpast, useNA = "always") # check output
```

## Co-occuring MH diagnoses
```{r dx_mh}
data.v8 <- data.v7

# To ensure those who skipped the question are not accidentally added to No MH dx category
data.v8$dx_dep[is.na(data.v8$dx_dep)] <- 0
data.v8$dx_anx[is.na(data.v8$dx_anx)] <- 0
data.v8$dx_bi[is.na(data.v8$dx_bi)] <- 0
data.v8$dx_psy[is.na(data.v8$dx_psy)] <- 0
data.v8$dx_ea[is.na(data.v8$dx_ea)] <- 0
data.v8$dx_tr[is.na(data.v8$dx_tr)] <- 0
data.v8$dx_sa[is.na(data.v8$dx_sa)] <- 0
data.v8$dx_neurodev_1[is.na(data.v8$dx_neurodev_1)] <- 0
data.v8$dx_pers[is.na(data.v8$dx_pers)] <- 0

data.v8$dx_adhd <- data.v8$dx_neurodev_1  # rename ADHD to a single category
data.v8$dx_adhd[is.na(data.v8$dx_adhd)] <- 0

data.v9 <- data.v8 %>%   # filters out any respondents who skipped the MH section 
  mutate(dx_mh = case_when(dx_dep == 1 ~ 1,
                           dx_anx == 1 ~ 1,
                           dx_bi == 1 ~ 1,
                           dx_psy == 1 ~ 1,
                           dx_ea == 1 ~ 1,
                           dx_tr == 1 ~ 1,
                           dx_sa == 1 ~ 1,
                           dx_adhd == 1 ~ 1,
                           dx_pers == 1 ~ 1,
                           dx_any == 1 ~ 1,
                           dx_none == 0 ~ 0)) %>%
  mutate(dx_mh = case_when(dx_mh == 1 ~ 1,         # creates dichotomous variable
                           dx_mh == 0 ~ 0,
                           is.na(dx_mh) ~ 0))
data.v9$dx_mh <- as.logical(data.v9$dx_mh)    # turns dx_mh into boolean

table(data.v9$dx_mh, useNA = "always") # Check output, skew=
```


# DATA DIVISION for final sample


## Data div and stats
```{r Data_div}
data.v10 <- as.data.frame(data.v9)

# Split data.v10 into two halves for training and testing datasets
set.seed(500) 
split = sample.split(data.v10, SplitRatio = 0.50)
 
# Create training and testing sets
traindf.v10 <- subset(data.v10, split == TRUE)  # train
testdf.v10 <- subset(data.v10, split == FALSE)  # test
 
#Check output
dim(data.v10)
dim(traindf.v10)
dim(testdf.v10)
```

## Eating disorder, any type
```{r train ed_any}
traindf.v10 <- traindf.v10 %>%
  filter(!is.na(ed_any))  # filter out all NAs for complete data

table(traindf.v10$ed_any, useNA = "always") # check output, confirms no NAs
```

## Medication use
```{r meds_any}
# Create stimulant
traindf.v11 <- traindf.v10 %>%
  mutate(meds_sti = case_when(meds_1 == 1 ~ 1,  # combine stimulant variables
                              meds_8 == 1 ~ 0,
                              meds_1 == 0 ~ 0)) 
      # Reconcile stimulant write-ins from meds_7_text
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[V|v]yvan[s|c]e")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[T|t]enex")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[C|c]oncerta")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[A|a]dderall")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[R|r]italin")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[P|p]rovigil")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[A|a]rmodafinil")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[F|f]ocalin")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[M|m]etadat")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[F|f]ocalin")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[N|n]uvigil")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "ADHD")] <- 1
      traindf.v11$meds_sti[str_detect(traindf.v11$meds_7_text, "[M|m]odafinil")] <- 1
      traindf.v11$meds_sti[traindf.v11$meds_7_text %in% c("Vyance", "Vivance adhd", "Stratera", "Aderol", "Aderal", "Adderal",
                                                    "Adderrall (for ADHD)", "Adderal, vyvance",  "Celltech")] <- 1
      
# Create antidepressant
traindf.v11 <- traindf.v11 %>%
  mutate(meds_dep = case_when(meds_2 == 1 ~ 1,    # combine depression var types
                              meds_8 == 1 ~ 0,
                              meds_2 == 0 ~ 0))
      # reconcile write-ins for depression from med_7_text
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[C|c]elexa")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[C|c]italopram")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[C|c]ymbalta")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[E|e]scitalopram")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[L|l]exapro")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[S|s]ertraline")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[Z|z]oloft")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "SSRI")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[E|e]lavil")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[P|p]aroxetine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[P|p]rozac")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[A|a]ntidepressant")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[A|a]mitriptyline")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[D|d]uloxetine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[C|c][e|i]pralex")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[W|w]ellbutrin")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[S|s]trattera")] <- 1 
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[A|a]tomoxetine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[F|f]luvoxamine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[V|v]enlafaxine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[P|p]ristiq")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[D|d]esipramine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[V|v]iibryd")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[V|v]enlafaxin")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[C|c]lomipramine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[D|d]esvenflaxine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[M|m]irtazapine")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[R|r][e|i]meron")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[T|t]raz[a|o|i]done")] <- 1
      traindf.v11$meds_dep[str_detect(traindf.v11$meds_7_text, "[N|n]ortriptyline")] <- 1
      traindf.v11$meds_dep[traindf.v11$meds_7_text %in% c("CYMBALTA", "Cymbolta", "Lexipro", "Lexxapro", "Sertaline",
                                                    "remiron", "Mirtazepene", "bupropin", "Lexapro, Wellbutrin",
                                                    "Lexapro and Paxil", "Fuoxetine", "Duluxotine", 
                                                    "Forgot the name, anti depressant for anxiety, daily med", 
                                                    "Atomoxitine (nonstimulant ADHD)", "Fluvoximine (luvox)",
                                                    "Anafranil", "amatryptaline for migraines", "amnitryptaline", 
                                                    "Buproprion (may or may not count as a psychostim?)", 
                                                    "amatryptaline for migraines", "Minipress")] <- 1
      
# Create antipsychotic
traindf.v11 <- traindf.v11 %>%
  mutate(meds_psy = case_when(meds_3 == 1 ~ 1,   # combine anti-psychotic med vars
                              meds_8 == 1 ~ 0,
                              meds_3 == 0 ~ 0))
      # Reconcile anti-psychotic entries from med_7_text
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[A|a]bilify")] <- 1
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[A|a]bility")] <- 1
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[V|v]raylar")] <- 1
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[O|o]lanzapine")] <- 1
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[A|a]ripiprazole")] <- 1
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[L|l]atuda")] <- 1
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[S|s]eroqu[e|o]l")] <- 1
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[G|g]eodon")] <- 1
      traindf.v11$meds_psy[str_detect(traindf.v11$meds_7_text, "[Q|q]uetiapine")] <- 1
      traindf.v11$meds_psy[traindf.v11$meds_7_text %in% c("Ziprazidone", "Quitiapin", "Latuda, Giadon")] <- 1 
      
# Create anti-anxiety  
traindf.v11 <- traindf.v11 %>%            
  mutate(meds_anx = case_when(meds_4 == 1 ~ 1,  # combine anti-anxiety var types
                              meds_8 == 1 ~ 0,
                              meds_4 == 0 ~ 0))
      # Reconcile all anti-anxiety drugs from the write-ins from meds_7_text
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[X|x]anax")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[V|v]alium")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[P|p]ropranolol")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[P|p]ropanol")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[L|l]orazepam")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[N|n]eurontin")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[A|a]tarax")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[L|l]yrica")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[A|a]tivan")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[C|c]lonidine")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[P|p]razosin")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[B|b]uspar")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[V|v]istaril")] <- 1  # antihistamine
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[I|i]nderal")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[H|h]ydroxyzine")] <- 1 # antihistamine
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[K|k]lonopin")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[D|d]iazepam")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[B|b]uspirone")] <- 1
      traindf.v11$meds_anx[str_detect(traindf.v11$meds_7_text, "[G|g]abapentin")] <- 1
      traindf.v11$meds_anx[traindf.v11$meds_7_text %in% c("Valuim", "you didnt list vallium under anti-anxiety", "Alphrazolam", 
                                                   "Hydroxizine--prescribed as needed for anxiety, only took one because of adverse reaction", 
                                                   "Hydrodoxine, a blood pressure medicine for anxiety that I don't remember the name of")] <- 1

# Create mood stabilizer
traindf.v11 <- traindf.v11 %>%
  mutate(meds_mood = case_when(meds_5 == 1 ~ 1,     # combine mood stabilizer vars
                               meds_8 == 1 ~ 0,
                               meds_5 == 0 ~ 0))
      # Reconcile mood stabilizers from write-in in med_7_text
      traindf.v11$meds_mood[str_detect(traindf.v11$meds_7_text, "[L|l]ithium")] <- 1
      traindf.v11$meds_mood[str_detect(traindf.v11$meds_7_text, "[L|l]amictal")] <- 1
      traindf.v11$meds_mood[str_detect(traindf.v11$meds_7_text, "[L|l]amotrigine")] <- 1
      traindf.v11$meds_mood[str_detect(traindf.v11$meds_7_text, "[D|d]epakote")] <- 1
      traindf.v11$meds_mood[str_detect(traindf.v11$meds_7_text, "[T|t]rileptal")] <- 1
      traindf.v11$meds_mood[str_detect(traindf.v11$meds_7_text, "[O|o]xcarbarzepine")] <- 1
      traindf.v11$meds_mood[traindf.v11$meds_7_text %in% c("Mood Stabilizer/Birth Control")] <- 1
      
# Create sleep med
traindf.v11 <- traindf.v11 %>%
  mutate(meds_sle = case_when(meds_6 == 1 ~ 1,     # combine sleep meds vars
                              meds_8 == 1 ~ 0,
                              meds_6 == 0 ~ 0))
      # Reconcile sleep medications from write-ins in meds_7_text
      traindf.v11$meds_sle[str_detect(traindf.v11$meds_7_text, "[X|x]yrem")] <- 1
      traindf.v11$meds_sle[str_detect(traindf.v11$meds_7_text, "[S|s]leep")] <- 1
      traindf.v11$meds_sle[str_detect(traindf.v11$meds_7_text, "[M|m]elatonin")] <- 1
      traindf.v11$meds_sle[str_detect(traindf.v11$meds_7_text, "[Z|z]quil")] <- 1
      traindf.v11$meds_sle[str_detect(traindf.v11$meds_7_text, "[N|n]yquil")] <- 1
      traindf.v11$meds_sle[str_detect(traindf.v11$meds_7_text, "[D|d]iphenhydramine")] <- 1
      traindf.v11$meds_sle[traindf.v11$meds_7_text %in% c("gabapentin, trazodone (both for sleep on separate occasions)", 
                                                    "generic sleep medication: melatonin supplements", 
                                                    "cold medicine to induce sleep")] <- 1
      
# Create "Othermeds
traindf.v11 <- traindf.v11 %>%
  mutate(meds_oth = case_when(meds_7 == 1 ~ 1,    # combine other meds vars
                              meds_8 == 1 ~ 0,
                              meds_7 == 0 ~ 0)) 
      # Reconcile "other" entries from med_7_text
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[C|c]annabis")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[M|m]arijuana")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[W|w]eed")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[N|n]altrexone")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[S|s]ynthroid")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[T|t]opomax")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[T|t]estosterone")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[T|t]hyroid")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[H|h]ydrodocone")] <- 1 
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[C|c]lonidine")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[G|g]uanfacine")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[K|k]etamine")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[F|f]lexeril")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[P|p]ant[o|a]loc")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[S|s]pironolactone")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[H|h]ormone")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[O|o]xycodone")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[C|c]annabic")] <- 1
      traindf.v11$meds_oth[str_detect(traindf.v11$meds_7_text, "[B|b]eta")] <- 1
      traindf.v11$meds_oth[traindf.v11$meds_7_text %in% c("Canabis", "Vistiril", "Vistral", "Thyroxine", "The Reefer",
                                                    "Topimitrate", "topiramate", "Estradiol, Spironactone", 
                                                    "muscle relaxants to help me sleep", "Ondansetron" ,
                                                    "Sumatriptan for migraines", "Psilocybin Mushrooms", "clonodine",
                                                    "Muscle Relaxers", "anti-siezure medication", "Codeine", 
                                                    "Androgen Blockers", "Anti-seizure to control racing thoughts",
                                                    "Anti seizure", "Buprenorphine (Suboxone) for opiate dependence",
                                                    "Hydroxine", "Hydroxcyzine", "Alyacen", "Mirapex", 
                                                    "hypothyroid medication", "Epilepsy drugs", "Birth control",
                                                    "Methadone", "Vimpat", "Contrave", "Benztropine", "Intuniv",
                                                    "Medicinal marijuana", "Pantaloc, for psychogenic vomiting",
                                                    "medicinal Cannabis", "Testosterone Enanthate", "testosterone",
                                                    "Cannabis", "Medical marijuana")] <- 1
      
# Create a group for students who do not take any psychotropic meds
traindf.v11 <- traindf.v11 %>%
  mutate(meds_none = case_when(meds_none == 1 ~ 1,    # filter for all meds w/ none
                               meds_none == 0 ~ 0,
                               meds_sti == 1 ~ 0,
                               meds_dep == 1 ~ 0,
                               meds_psy == 1 ~ 0,
                               meds_anx == 1 ~ 0,
                               meds_mood == 1 ~ 0,
                               meds_sle == 1 ~ 0,
                               meds_oth == 1 ~ 0)) %>%
  filter(!is.na(meds_any))
  
# tabulate and check outputs
table(traindf.v11$meds_sti)
table(traindf.v11$meds_dep)
table(traindf.v11$meds_psy)
table(traindf.v11$meds_anx)
table(traindf.v11$meds_mood)
table(traindf.v11$meds_sle)
table(traindf.v11$meds_oth)
table(traindf.v11$meds_none)

table(traindf.v11$meds_any, useNA = "always")
```

## Psychopharm medication class count
```{r train med_count}
# convert all med vars to numeric for future medcount var totaling
traindf.v11$meds_1 <- as.numeric(traindf.v11$meds_1)
traindf.v11$meds_2 <- as.numeric(traindf.v11$meds_2)
traindf.v11$meds_3 <- as.numeric(traindf.v11$meds_3)
traindf.v11$meds_4 <- as.numeric(traindf.v11$meds_4)
traindf.v11$meds_5 <- as.numeric(traindf.v11$meds_5)
traindf.v11$meds_6 <- as.numeric(traindf.v11$meds_6)
traindf.v11$meds_7 <- as.numeric(traindf.v11$meds_7)
traindf.v11$meds_8 <- as.numeric(traindf.v11$meds_8)

# set any NAs equal to zero
traindf.v11$meds_1[is.na(traindf.v11$meds_1)] <- 0
traindf.v11$meds_2[is.na(traindf.v11$meds_2)] <- 0
traindf.v11$meds_3[is.na(traindf.v11$meds_3)] <- 0
traindf.v11$meds_4[is.na(traindf.v11$meds_4)] <- 0
traindf.v11$meds_5[is.na(traindf.v11$meds_5)] <- 0
traindf.v11$meds_6[is.na(traindf.v11$meds_6)] <- 0
traindf.v11$meds_7[is.na(traindf.v11$meds_7)] <- 0

# create meds_count var
traindf.v11 <- traindf.v11 %>%
  mutate(meds_count = meds_1 + meds_2 + meds_3 + meds_4 + meds_5 + meds_6 + meds_7) %>%
  mutate(meds_count = case_when(meds_count == 0 ~ 0,
                                meds_count == 1 ~ 1,
                                meds_count == 2 ~ 2, 
                                meds_count == 3 ~ 3,
                                meds_count == 4 ~ 4,
                                meds_count == 5 ~ 5,
                                meds_count == 6 ~ 6))
traindf.v11$meds_count <- as.numeric(traindf.v11$meds_count) # return var to numeric cass

table(traindf.v11$meds_count, useNA = "always")  # check output
traindf.v11 = subset(traindf.v11, select= -c(meds_1:meds_7)) # clean up vars/columns
```

```{r environment vars}
traindf.v12 <- traindf.v11
```

## Discrimination
```{r train discrim}
traindf.v12$discrim<- as.numeric(traindf.v12$discrim)

traindf.v12 <- traindf.v12 %>%
  filter(!is.na(discrim))

table(traindf.v12$discrim, useNA = "always") # check output
```

## Religion
```{r train religios}
# Label levels of religious importance
traindf.v13 <- traindf.v12 %>%
  # flip coding
  mutate(religios = case_when(religios == 1 ~ 5,   # highly religious
                              religios == 2 ~ 4,
                              religios == 3 ~ 3,
                              religios == 4 ~ 2,
                              religios == 5 ~ 1)) %>%  # not at all religious
  filter(!is.na(religios))
traindf.v13$religios <- as.numeric(traindf.v13$religios)

table(traindf.v13$religios, useNA = "always")       # Check output
```

##  Religion interaction
``` {r religios_interxn}
table(traindf.v13$social_religid, useNA = "always")

traindf.v13 <- traindf.v13 %>%   # fix directionality
  mutate(cli_relig = case_when(cli_relig_nch  == 1 ~ 5,   # hostile
                              cli_relig_nch  == 2 ~ 4,
                              cli_relig_nch  == 3 ~ 3,
                              cli_relig_nch  == 4 ~ 2,
                              cli_relig_nch  == 5 ~ 1,  # welcoming
                              cli_relig_ch  == 1 ~ 5,   # hostile
                              cli_relig_ch  == 2 ~ 4,
                              cli_relig_ch  == 3 ~ 3,
                              cli_relig_ch  == 4 ~ 2,
                              cli_relig_ch  == 5 ~ 1))  # welcoming
table(traindf.v13$cli_relig, useNA = "always")
```

## Residence type
```{r train residenc}
# re-organize living situation into on-campus, off-campus, and at home
traindf.v13 <- traindf.v13 %>%
  mutate(residenc = case_when(residenc == 1 ~ 1,  # on-campus
                              residenc == 2 ~ 1,
                              residenc == 3 ~ 2,  # coop
                              residenc == 4 ~ 2, 
                              residenc == 5 ~ 3,  # off-campus
                              residenc == 6 ~ 4,  # with family
                              residenc == 7 ~ 3)) %>%
  filter(!is.na(residenc))

table(traindf.v13$residenc, useNA = "always")  # check output
```

## Overall school satisfaction
```{r train satisfied_overall}
traindf.v13 <- traindf.v13 %>%
  mutate(satisfied_overall = case_when(satisfied_overall == 1 ~ 6,  # reverse coding
                                       satisfied_overall == 2 ~ 5,
                                       satisfied_overall == 3 ~ 4,
                                       satisfied_overall == 4 ~ 3,
                                       satisfied_overall == 5 ~ 2,
                                       satisfied_overall == 6 ~ 1)) %>% 
  filter(!is.na(satisfied_overall))  # filters out NAs
traindf.v13satisfied_overall <- as.numeric(traindf.v13$satisfied_overall)

table(traindf.v13$satisfied_overall, useNA = "always")
```

## Insurance coverage
```{r train ins_cover}
# create one insurance var from related questions in 'ins_' module
traindf.v13 <- traindf.v13 %>% 
  mutate(ins_no = case_when((ins_1 == 1 | ins_mh == 4 | ins_mh == 5 | ins_ade == 3) ~ 1,   # inadequate coverage
                            (ins_1 == 0 | ins_mh == 1 | ins_mh == 2 | ins_ade == 2) ~ 0)) %>% # adequate MH coverage
  filter(!is.na(ins_no))   
traindf.v13$ins_no <- as.logical(traindf.v13$ins_no) # switch class to boolean
table(traindf.v13$ins_no, useNA = "always")   # check output, skew
```

## International student
```{r train international}
traindf.v14 <- traindf.v13 %>%
  mutate(international = case_when(international == 1 ~ 1,
                                   international == 0 ~ 0)) %>%
  filter(!is.na(international))

traindf.v14$international <- as.logical(traindf.v14$international)

table(traindf.v14$international, useNA = "always")
```

## Family support
```{r train fam_support_aca}
traindf.v14$fam_support_aca <- as.numeric(traindf.v14$fam_support_aca)
table(traindf.v14$fam_support_aca, useNA = "always")  # check output (excessive NAs)
```

## Activity Involvement
```{r train activities}
# set all NAs in activities equal to 0
traindf.v14$activ_ac[is.na(traindf.v14$activ_ac)] <- 1
traindf.v14$activ_athc[is.na(traindf.v14$activ_athc)] <- 1
traindf.v14$activ_athv[is.na(traindf.v14$activ_athv)] <- 1
traindf.v14$activ_athi[is.na(traindf.v14$activ_athi)] <- 1
traindf.v14$activ_cs[is.na(traindf.v14$activ_cs)] <- 1
traindf.v14$activ_cu[is.na(traindf.v14$activ_cu)] <- 1
traindf.v14$activ_da[is.na(traindf.v14$activ_da)] <- 1
traindf.v14$activ_fs[is.na(traindf.v14$activ_fs)] <- 1
traindf.v14$activ_gs[is.na(traindf.v14$activ_gs)] <- 1
traindf.v14$activ_gov[is.na(traindf.v14$activ_gov)] <- 1
traindf.v14$activ_mp[is.na(traindf.v14$activ_md)] <- 1
traindf.v14$activ_md[is.na(traindf.v14$activ_none)] <- 1
traindf.v14$activ_soc[is.na(traindf.v14$activ_soc)] <- 1
traindf.v14$activ_rel[is.na(traindf.v14$activ_rel)] <- 1
traindf.v14$activ_art[is.na(traindf.v14$activ_art)] <- 1
traindf.v14$activ_other[is.na(traindf.v14$activ_other)] <- 1

# Create one activity variable (dichotomous) based on involvement in campus activities
traindf.v14 <- traindf.v14 %>% 
  mutate(activ_no = case_when(activ_none == 1 ~ 1,
                              activ_ac == 1 ~ 0,
                              activ_athc == 1 ~ 0,
                              activ_athv == 1 ~ 0,
                              activ_athi == 1 ~ 0,
                              activ_cs == 1 ~ 0,
                              activ_cu == 1 ~ 0,
                              activ_da == 1 ~ 0,
                              activ_fs == 1 ~ 0,
                              activ_gs == 1 ~ 0,
                              activ_gov == 1 ~ 0,
                              activ_mp == 1 ~ 0,
                              activ_md == 1 ~ 0,
                              activ_rel == 1 ~ 0,
                              activ_soc == 1 ~ 0,
                              activ_art == 1 ~ 0,
                              activ_other == 1 ~ 0))
traindf.v14$activ_no <- as.logical(traindf.v14$activ_no)

table(traindf.v14$activ_no, useNA = "always")     # tabulate and check output
traindf.v14 = subset(traindf.v14, select= -c(activ_none, activ_ac:activ_other))    # clean up vars
```

## School variable
```{r train school2}
# insert each school as a dichotomous var
traindf.v14 <- traindf.v14 %>%
  mutate(var_AlbertaCAD = ifelse((school2 == "AlbertaCAD"), 1, 0)) %>%
  mutate(var_Boston = ifelse((school2 == "Boston"), 1, 0)) %>%
  mutate(var_CIA = ifelse((school2 == "CIA"), 1, 0)) %>%
  mutate(var_CalPoly = ifelse((school2 == "CalPoly"), 1, 0)) %>%
  mutate(var_ColoradoCollege = ifelse((school2 == "ColoradoCollege"), 1, 0)) %>%
  mutate(var_ColoradoMountain = ifelse((school2 == "ColoradoMountain"), 1, 0)) %>%
  mutate(var_ColumbusCAD = ifelse((school2 == "ColumbusCAD"), 1, 0)) %>%
  mutate(var_Delaware = ifelse((school2 == "Delaware"), 1, 0)) %>%
  mutate(var_DetroitMercy = ifelse((school2 == "DetroitMercy"), 1, 0)) %>%
  mutate(var_Emerson = ifelse((school2 == "Emerson"), 1, 0)) %>%
  mutate(var_GeorgeMason = ifelse((school2 == "GeorgeMason"), 1, 0)) %>%
  mutate(var_GeorgiaTech = ifelse((school2 == "GeorgiaTech"), 1, 0)) %>%
  mutate(var_Kalamazoo = ifelse((school2 == "Kalamazoo"), 1, 0)) %>%
  mutate(var_Kansas = ifelse((school2 == "Kansas"), 1, 0)) %>%
  mutate(var_MDInstituteCollegeArt = ifelse((school2 == "MDInstituteCollegeArt"), 1, 0)) %>%
  mutate(var_MassArt = ifelse((school2 == "MassArt"), 1, 0)) %>%
  mutate(var_Merrimack = ifelse((school2 == "Merrimack"), 1, 0)) %>%
  mutate(var_MichiganState = ifelse((school2 == "MichiganState"), 1, 0)) %>%
  mutate(var_MinnesotaCAD = ifelse((school2 == "MinnesotaCAD"), 1, 0)) %>%
  mutate(var_MontclairState = ifelse((school2 == "MontclairState"), 1, 0)) %>%
  mutate(var_NHInstituteArt = ifelse((school2 == "NHInstituteArt"), 1, 0)) %>%
  mutate(var_NevadaReno = ifelse((school2 == "NevadaReno"), 1, 0)) %>%
  mutate(var_OaklandCC = ifelse((school2 == "OaklandCC"), 1, 0)) %>%
  mutate(var_OklahomaCityCC = ifelse((school2 == "OklahomaCityCC"), 1, 0)) %>%
  mutate(var_PaloAltoCollege = ifelse((school2 == "PaloAltoCollege"), 1, 0)) %>%
  mutate(var_PennCollegeTech = ifelse((school2 == "PennCollegeTech"), 1, 0)) %>%
  mutate(var_Pratt = ifelse((school2 == "RedlandsCC"), 1, 0)) %>%
  mutate(var_RhodeIsland = ifelse((school2 == "RhodeIsland"), 1, 0)) %>%
  mutate(var_RedlandsCC = ifelse((school2 == "RedlandsCC"), 1, 0)) %>%
  mutate(var_Ringling = ifelse((school2 == "Ringling"), 1, 0)) %>%
  mutate(var_Rollins = ifelse((school2 == "Rollins"), 1, 0)) %>%
  mutate(var_SAIC = ifelse((school2 == "SAIC"), 1, 0)) %>%
  mutate(var_Sewanee = ifelse((school2 == "Sewanee"), 1, 0)) %>%
  mutate(var_Smith = ifelse((school2 == "Smith"), 1, 0)) %>%
  mutate(var_SouthernNazarene = ifelse((school2 == "SouthernNazarene"), 1, 0)) %>%
  mutate(var_SouthwesternOklahomaState = ifelse((school2 == "SouthwesternOklahomaState"), 1, 0)) %>%
  mutate(var_StJohns = ifelse((school2 == "StJohns"), 1, 0)) %>%
  mutate(var_StMarys = ifelse((school2 == "StMarys"), 1, 0)) %>%
  mutate(var_StRose = ifelse((school2 == "StRose"), 1, 0)) %>%
  mutate(var_TrumanState = ifelse((school2 == "TrumanState"), 1, 0)) %>%
  mutate(var_TuftsHealthSciences = ifelse((school2 == "TuftsHealthSciences"), 1, 0)) %>%
  mutate(var_TuftsMainCampus = ifelse((school2 == "TuftsMainCampus"), 1, 0)) %>%
  mutate(var_UChicago = ifelse((school2 == "UChicago"), 1, 0)) %>%
  mutate(var_UFlorida = ifelse((school2 == "UFlorida"), 1, 0)) %>%
  mutate(var_UMDearborn = ifelse((school2 == "UMDearborn"), 1, 0)) %>%
  mutate(var_UMich = ifelse((school2 == "UMich"), 1, 0)) %>%
  mutate(var_UNCSchoolArt = ifelse((school2 == "UNCSchoolArt"), 1, 0)) %>%
  mutate(var_UTKnoxville = ifelse((school2 == "UTKnoxville"), 1, 0)) %>%
  mutate(var_UniversityofSouthernCalifornia = ifelse((school2 == "UniversityofSouthernCalifornia"), 1, 0)) %>%  
  mutate(var_Utah = ifelse((school2 == "Utah"), 1, 0)) %>%
  mutate(var_VATech = ifelse((school2 == "VATech"), 1, 0)) %>%
  mutate(var_VirginiaCommonwealth = ifelse((school2 == "VirginiaCommonwealth"), 1, 0)) %>%
  mutate(var_WakeForest = ifelse((school2 == "WakeForest"), 1, 0)) %>%
  mutate(var_Watkins = ifelse((school2 == "Watkins"), 1, 0)) %>%
  mutate(var_WestVirginia = ifelse((school2 == "WestVirginia"), 1, 0)) %>%
  mutate(var_WesternCarolina = ifelse((school2 == "WesternCarolina"), 1, 0)) %>%
  mutate(var_WesternMichigan = ifelse((school2 == "WesternMichigan"), 1, 0)) %>%
  mutate(var_WesternWA = ifelse((school2 == "WesternWA"), 1, 0)) %>%
  mutate(var_Xavier = ifelse((school2 == "Xavier"), 1, 0))
```

## MH campus environment
```{r train env_mh}
traindf.v14$env_mh <- as.factor(traindf.v14$env_mh)

traindf.v14 <- traindf.v14 %>%
  mutate(env_mh = case_when(env_mh == 5 ~ 1,
                            env_mh == 4 ~ 2,
                            env_mh == 3 ~ 3,
                            env_mh == 2 ~ 4,
                            env_mh == 1 ~ 5)) %>%
    filter(!is.na(env_mh))

table(traindf.v14$env_mh, useNA = "always")  # check output (excessive NAs)
```

### School type levels

(1) 4-year: var_Boston, var_CalPoly, var_ColoradoCollege, var_ColoradoMountain, var_Delaware, var_DetroitMercy, var_Emerson, var_GeorgeMason, var_GeorgiaTech, var_Kalamazoo, var_Kansas, var_Merrimack, var_MichiganState, var_MontclairState, var_NevadaReno, var_PennCollegeTech, var_RhodeIsland, var_Rollins, var_Sewanee, var_Smith, var_SouthernNazarene, var_SouthwesternOklahomaState, var_StJohns, var_StMarys, var_StRose, var_TrumanState, var_TuftsHealthSciences, var_TuftsMainCampus, var_UChicago, var_UFlorida, var_UMDearborn, var_UMich, var_UTKnoxville,  var_UniversityofSouthernCalifornia, var_Utah, var_VATech, var_VirginiaCommonwealth, var_WakeForest,var_WestVirginia, var_WesternCarolina, var_WesternMichigan, var_WesternWA, var_Xavier

(2) Community College: var_OaklandCC, var_OklahomaCityCC, var_PaloAltoCollege, var_RedlandsCC 

(3) Art & Design, Culinary: var_AlbertaCAD, var_CIA, var_ColumbusCAD, var_MDInstituteCollegeArt, var_MassArt, var_MinnesotaCAD, var_NHInstituteArt, var_Pratt, , var_Ringling, var_SAIC, var_UNCSchoolArt, var_Watkins, 

```{r train school2_type}
traindf.v14 <- traindf.v14 %>%
  # 4-year college
  mutate(school2_4yr = ifelse(var_Boston + var_CalPoly + var_ColoradoCollege + var_ColoradoMountain + var_Delaware +
                                var_DetroitMercy + var_Emerson + var_GeorgeMason + var_GeorgiaTech + var_Kalamazoo + 
                                var_Kansas + var_Merrimack + var_MichiganState + var_MontclairState + var_NevadaReno +
                                var_PennCollegeTech + var_RhodeIsland + var_Rollins + var_Sewanee + var_Smith +
                                var_SouthernNazarene + var_SouthwesternOklahomaState + var_StJohns + var_StMarys + var_StRose +
                                var_TrumanState + var_TuftsHealthSciences + var_TuftsMainCampus + var_UChicago + var_UFlorida +
                                var_UMDearborn + var_UMich + var_UTKnoxville + var_UniversityofSouthernCalifornia + var_Utah +
                                var_VATech + var_VirginiaCommonwealth + var_WakeForest + var_WestVirginia + 
                                var_WesternCarolina + var_WesternMichigan + var_WesternWA + var_Xavier == 1, TRUE,
                              ifelse(
                                var_Boston + var_CalPoly + var_ColoradoCollege + var_ColoradoMountain + var_Delaware +
                                  var_DetroitMercy + var_Emerson + var_GeorgeMason + var_GeorgiaTech + var_Kalamazoo +
                                  var_Kansas + var_Merrimack + var_MichiganState + var_MontclairState + var_NevadaReno +
                                  var_PennCollegeTech + var_RhodeIsland + var_Rollins + var_Sewanee + var_Smith +
                                  var_SouthernNazarene + var_SouthwesternOklahomaState + var_StJohns + var_StMarys + 
                                  var_StRose + var_TrumanState + var_TuftsHealthSciences + var_TuftsMainCampus + var_UChicago +
                                  var_UFlorida + var_UMDearborn + var_UMich + var_UTKnoxville +
                                  var_UniversityofSouthernCalifornia + var_Utah + var_VATech + var_VirginiaCommonwealth +
                                  var_WakeForest + var_WestVirginia + var_WesternCarolina + var_WesternMichigan +
                                  var_WesternWA + var_Xavier == 0, FALSE, NA))) %>%
    
  # Community colleges
    mutate(school2_cc = ifelse(var_OaklandCC + var_OklahomaCityCC + var_PaloAltoCollege + var_RedlandsCC == 1, TRUE, 
                               ifelse(var_OaklandCC + var_OklahomaCityCC + var_PaloAltoCollege + var_RedlandsCC == 0, FALSE, NA))) %>%
    
  # Art, design, culinary
    mutate(school2_ad = ifelse(var_AlbertaCAD + var_CIA + var_ColumbusCAD + var_MDInstituteCollegeArt + 
                                 var_MassArt + var_MinnesotaCAD + var_NHInstituteArt + var_Pratt + var_Ringling +
                                 var_SAIC + var_UNCSchoolArt + var_Watkins == 1, TRUE, 
                               ifelse(
                                 var_AlbertaCAD + var_CIA + var_ColumbusCAD + var_MDInstituteCollegeArt +
                                   var_MassArt + var_MinnesotaCAD + var_NHInstituteArt + var_Pratt + 
                                   var_Ringling + var_SAIC + var_UNCSchoolArt + var_Watkins == 0, FALSE, NA)))

# Binary variable for school type
table(traindf.v14$school2_4yr)
table(traindf.v14$school2_cc)
table(traindf.v14$school2_ad)

#  create one school type variables
traindf.v14 <- traindf.v14 %>%
  mutate(school2_type = case_when(school2_4yr == TRUE ~ 1,
                                  school2_cc == TRUE ~ 2,
                                  school2_ad == TRUE ~ 3)) %>%
  filter(!is.na(school2_type))
traindf.v14$school2_type <- as.factor(traindf.v14$school2_type)

table(traindf.v14$school2_type, useNA = "always") # check output
```

## PREMOTIVATION ANALYSES
```{r train env analysis}
traindf.v15 <- traindf.v14  # new dataframe for analysis
```

Premotivation correlation
```{r train results_prem}
# Define diathesis vars for correlation matrix
traindf_prem <- traindf.v15 %>% select(si_type, age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh,
                                       international, ins_no, satisfied_overall, residenc, religios, meds_count, dx_mh, 
                                       meds_any, ed_any, finpast, body_sr, days_work_paid, children_dep, discrim, activ_no)

# Corr_simple function
corr_simple <- function(traindf=traindf_prem, sig=0.6){
  # convert traindf to numeric in order to run correlations 
  traindf_prem <- traindf_prem %>% mutate_if(is.character, as.factor)
  traindf_prem <-  traindf_prem %>% mutate_if(is.factor, as.numeric)
  # run a correlation and drop the insignificant ones
  corr <- cor(traindf_prem, use = "pairwise.complete.obs")                               
  corr[lower.tri(corr,diag=TRUE)] <- NA                   # prepare to drop duplicates and correlations of 1    
  corr[corr %in% c(-1, 1)] <- NA                          # drop perfect correlations
  corr <- as.data.frame(as.table(corr))                   # turn into a 3-column table
  corr <- na.omit(corr)                                   # remove the NA values from above 
  corr <- corr[order(-abs(corr$Freq)),]                   # sort by highest correlation
  print(corr)
  
  #turn corr back into matrix in order to plot with corrplot
  mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
  corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
}
corr_simple()

```

## PCA PREMOTIVATION
```{r train prem_pca}
# Define diathesis vars for correlation matrix
traindf_prem <- traindf.v15 %>% select(age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, international, ins_no, 
                                       satisfied_overall, residenc, religios, meds_count, dx_mh, meds_any, ed_any, finpast, activ_no,
                                       body_sr, days_work_paid, children_dep, discrim)
traindf_prem <- na.omit(traindf_prem)

# create corr matrix, with dummy vars
traindf_prem <- traindf_prem %>% 
  mutate_if(is.numeric, as.factor) %>% 
  dummy_cols(remove_first_dummy = TRUE) %>% 
  data.matrix()
# traindf_prem   # check output

results_prem <- dummy_cols(traindf_prem, select_columns = c("age", "race", "sexual", "gender", "gender_tgd", "sib_freq", "school2_type", 
                                                            "env_mh", "international", "ins_no", "satisfied_overall", "residenc", "religios", 
                                                            "meds_count", "dx_mh", "meds_any", "ed_any", "finpast", "body_sr", "activ_no",
                                                            "days_work_paid", "children_dep", "discrim"),
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)

prem_pca <- PCA(results_prem, graph=FALSE)  # apply PCA
prem_pca$eig   # output matrix with eigenvalues

eigval_prem <- get_eigenvalue(prem_pca)
# eigval_prem

# visualization for PCA, FAMD
fviz_screeplot(prem_pca, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(prem_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_famd_var(prem_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_cos2(prem_pca, choice = "var", axes = 1,
          fill = "steelblue", color = "steelblue",
          sort.val = c("desc", "asc", "none"),
          top = 40,
          xtickslab.rt = 45,
          ggtheme = theme_minimal())
```

## GLM Premotivation regression
```{r train clm_prem}
glm_prem <- traindf.v15 %>% select(si_type, age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, international, ins_no, 
                                       satisfied_overall, residenc, religios, meds_count, dx_mh, meds_any, ed_any, finpast, activ_no,
                                       body_sr, days_work_paid, children_dep, discrim)
glm_prem <- na.omit(glm_prem)

# run regression
glm_prem <- glm(si_type ~ age + race + sexual + gender + gender_tgd + sib_freq + school2_type + env_mh + international + ins_no + 
                  satisfied_overall + residenc + religios + meds_count + dx_mh + meds_any + ed_any + finpast + body_sr + activ_no +
                  days_work_paid + children_dep + discrim,
              data = glm_prem)
summary(glm_prem)
coef(glm_prem)   # retrieve coefficients

ci_prem <- confint(glm_prem)  # retrieve confidence intervals
ci_prem

model.prem <- tidy(glm_prem)  # Convert model to dataframe
model.prem
model.prem  %>%
   mutate(or = exp(estimate),               # Odds ratio/gradient
          var.diag = diag(vcov(glm_prem)),  # Variance of each coefficient
          or.se = sqrt(or^2 * var.diag))    # Odds-ratio adjusted
```


# LIFE EVENTS


```{r train LE frame}
traindf.v15 <- traindf.v14 
```

## Illicit drug use
Creates illicit drug use var (limitation -- 30 days reflection)
```{r train drugs_yn}
## adjusted for nested question status 
traindf.v15$drug_coc[is.na(traindf.v15$drug_coc)] <- 0
traindf.v15$drug_her[is.na(traindf.v15$drug_her)] <- 0
traindf.v15$drug_met[is.na(traindf.v15$drug_met)] <- 0
traindf.v15$drug_stim[is.na(traindf.v15$drug_stim)] <- 0
traindf.v15$drug_ect[is.na(traindf.v15$drug_ect)] <- 0
traindf.v15$drug_opi[is.na(traindf.v15$drug_opi)] <- 0
traindf.v15$drug_other[is.na(traindf.v15$drug_other)] <- 0

# visualize current output before transformation
table(traindf.v15$drug_coc)
table(traindf.v15$drug_her)     # too small
table(traindf.v15$drug_met)     # too small
table(traindf.v15$drug_stim)
table(traindf.v15$drug_ect)     # too small
table(traindf.v15$drug_opi)     # too small
table(traindf.v15$drug_other)   # too vague, small

# Sample is too small to analyze individual drugs, except for marijuana. 
# Transform to illicit drug y/n
traindf.v15 <- traindf.v15 %>%
  mutate(drugs_yn = case_when(drug_coc == 1 ~ 1,
                              drug_her == 1 ~ 1,
                              drug_met == 1 ~ 1,
                              drug_stim == 1 ~ 1,
                              drug_ect == 1 ~ 1,
                              drug_opi == 1 ~ 1,
                              drug_other == 1 ~ 1))
traindf.v15$drugs_yn[is.na(traindf.v15$drugs_yn)] <- 0
traindf.v15$drugs_yn <- as.logical(traindf.v15$drugs_yn)

table(traindf.v15$drugs_yn, useNA = "always")
```

## Marijuana use
```{r train drug_mar}
traindf.v15$drug_mar[is.na(traindf.v15$drug_mar)] <- 0

traindf.v15 <- traindf.v15 %>%
  mutate(drug_mar = case_when(drug_mar == 1 ~ 1, 
                              drug_mar == 0 ~ 0)) %>%
  filter(!is.na(drug_mar))  # filters out NAs
traindf.v15$drug_mar <- as.logical(traindf.v15$drug_mar)

table(traindf.v15$drug_mar, useNA = "always")
```

## Current financial stressors
```{r train fincur}
traindf.v16 <- traindf.v15 %>% 
  # make dichotomous
  mutate(fincur = case_when(fincur == 3 ~ 0,  # sometimes
                            fincur == 4 ~ 0,  # rarely or never
                            fincur == 5 ~ 0,
                            fincur == 1 ~ 1,  # always or often stressful
                            fincur == 2 ~ 1)) %>%
  filter(!is.na(fincur))                      # filters for NAs
traindf.v16$fincur <- as.logical(traindf.v16$fincur)

table(traindf.v16$fincur, useNA = "always")  # check output, skew
```

## ISI scale
```{r train isi_tot}

# something weird is going on here, too.


traindf.v16$isi_1 <- as.numeric(traindf.v16$isi_1)
traindf.v16$isi_2 <- as.numeric(traindf.v16$isi_2)
traindf.v16$isi_3 <- as.numeric(traindf.v16$isi_3)
traindf.v16$isi_4 <- as.numeric(traindf.v16$isi_4)
traindf.v16$isi_5 <- as.numeric(traindf.v16$isi_5)
traindf.v16$isi_6 <- as.numeric(traindf.v16$isi_6)
traindf.v16$isi_7 <- as.numeric(traindf.v16$isi_7)
traindf.v16$isi_total <- as.numeric(traindf.v16$isi_total)

table(traindf.v16$isi_1)
table(traindf.v16$isi_2)
table(traindf.v16$isi_3)
table(traindf.v16$isi_4)
table(traindf.v16$isi_5)
table(traindf.v16$isi_6)
table(traindf.v16$isi_7)

traindf.v16$isi_tot <- traindf.v16$isi_1 + traindf.v16$isi_2 + traindf.v16$isi_3 + traindf.v16$isi_4 + traindf.v16$isi_5 + traindf.v16$isi_6 + traindf.v16$isi_7

table(traindf.v16$isi_tot, useNA = "always")
table(traindf.v16$isi_total)
```

## Abuse or assault, in the last year only
```{r train assault}
table(traindf.v16$abuse_life)
table(traindf.v16$abuse_recent) 

# create dichotomous variable called 'abuse_year' to reflect abuse that occurred in last 12 months
traindf.v17 <- traindf.v16 %>%
  mutate(abuse_year = case_when(abuse_recent == 1 ~ 1,
                                abuse_recent == 2 ~ 1,
                                abuse_recent == 3 ~ 1,
                                abuse_recent == 4 ~ 0,
                                abuse_recent == 5 ~ 0,
                                abuse_life == 0 ~ 0)) %>%
  filter(!is.na(abuse_life))
table(traindf.v17$abuse_year)   # check output

# restructure sexual assault var
traindf.v17 <- traindf.v17 %>%
  mutate(assault = case_when(
                             assault_sex == 1 ~ 1,
                             assault_emo == 1 ~ 1,
                             assault_phys == 1 ~ 1, 
                             abuse_year == 1 ~ 1,
                             abuse_year == 0 ~ 0,
                             assault_sex == 2 ~ 0,
                             assault_emo == 0 ~ 0,
                             assault_phys == 1 ~ 0)) %>%
  mutate(assault = case_when(assault == 1 ~ 1,
                             assault == 0 ~ 0)) %>%
  filter(!is.na(assault))
traindf.v17$assault <- as.logical(traindf.v17$assault)

# tabulate and check output
table(traindf.v17$assault, useNA = "always") 
```

## Binging frequency
```{r train binge}
# set all binge_fr values equal to 0
traindf.v17$binge_fr_f[is.na(traindf.v17$binge_fr_f)] <- 0
traindf.v17$binge_fr_m[is.na(traindf.v17$binge_fr_m)] <- 0
traindf.v17$binge_fr_o[is.na(traindf.v17$binge_fr_o)] <- 0 

# create one binge var
traindf.v18 <- traindf.v17 %>% 
  mutate(binge_fr = as.numeric(binge_fr_f) + as.numeric(binge_fr_m) + as.numeric(binge_fr_o))
table(traindf.v18$binge_fr)

traindf.v18 <- traindf.v18 %>%
  mutate(binge = case_when(binge_fr >= 4 ~ 1,
                           binge_fr < 4 ~ 0)) %>%
  filter(!is.na(binge))
traindf.v18$binge <-as.logical(traindf.v18$binge)

table(traindf.v18$binge, useNA = "always") # check output

traindf.v18 = subset(traindf.v18, select= -c(binge_fr_f, binge_fr_m, binge_fr_o)) # clean up var
```

## Recent Psychiatric Hospitalization, last 12 months
```{r train psyhx}
# Create variable for any psychiatric hospitalization in the last 12 months
traindf.v18 <- traindf.v18 %>% 
  mutate(psyhx = case_when((prov_pes == 1 | prov_inp == 1 | prov_par == 1) ~ 1, # inpatient, IOPs, etc.
                           (prov_pes == 0 & prov_inp == 0 & prov_par == 0) ~ 0, # no crises intervened on
                           ther_ever == 0 ~ 0)) %>%
  filter(!is.na(psyhx))  # filter out NAs
traindf.v18$psyhx <- as.logical(traindf.v18$psyhx)  # change class to boolean

table(traindf.v18$psyhx, useNA = "always")   # check output, skew
```

## Current GPA
```{r train gpa_sr}
traindf.v18 <- traindf.v18 %>% 
# bin grades to As, Bs, Cs, and D+ and below
  mutate(gpa_sr = case_when(gpa_sr == 0 ~ 1,   # A+
                            gpa_sr == 1 ~ 1,   # A
                            gpa_sr == 2 ~ 1,   # A-
                            gpa_sr == 3 ~ 2,   # B+
                            gpa_sr == 4 ~ 2,   # B
                            gpa_sr == 5 ~ 2,   # B-
                            gpa_sr == 6 ~ 3,   # C+
                            gpa_sr == 7 ~ 3,   # C
                            gpa_sr == 8 ~ 3,   # C-
                            gpa_sr == 9 ~ 4,   # D+ and below
                            gpa_sr == 10 ~ 5)) %>%  # Don't know
      filter(!is.na(gpa_sr))  # filter out NAs
traindf.v18$gpa_sr <- as.numeric(traindf.v18$gpa_sr) # change to numeric scale

table(traindf.v18$gpa_sr, useNA = "always")  # check output, skew
jarque.bera.test(traindf.v18$gpa_sr)
```
 
 ## Academic failure
```{r train failed}
table(traindf.v18$failed, useNA = "always")
```
 
 
## Life events analyses 
```{r train LE analysis}
traindf.v19 <- traindf.v18
``` 
 
### LE correlation
```{r train LE correlation}
# Define life event var candidates for correlation matrix
traindf_le <- traindf.v19 %>% select(gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx)   # still missing isi_tot

# convert traindf to numeric in order to run correlations
traindf_le <- traindf_le %>% mutate_if(is.character, as.factor)
traindf_le <-  traindf_le %>% mutate_if(is.factor, as.numeric)

# run a correlation and drop the insignificant ones
corr <- cor(traindf_le, use = "pairwise.complete.obs")                               
corr[lower.tri(corr,diag=TRUE)] <- NA                   # prepare to drop dups and correlations of 1    
corr[corr %in% c(-1, 1)] <- NA                          # drop perfect correlations
corr <- as.data.frame(as.table(corr))                   #turn into a 3-column table
corr <- na.omit(corr)                                   #remove the NA values from above 
corr <- corr[order(-abs(corr$Freq)),]                   #sort by highest correlation
print(corr)
  
#turn corr back into matrix in order to plot with corrplot
mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
```

### PCA LE
```{r train le_pca}
traindf_le <- traindf.v19 %>% select(gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx, discrim)   # missing isi_tot
traindf_le <- na.omit(traindf_le)

# create corr matrix, with dummy vars
traindf_le <- traindf_le %>% 
  mutate_if(is.numeric, as.factor) %>% 
  dummy_cols(remove_first_dummy = TRUE) %>% 
  data.matrix()
# traindf_le   # check output

results_le <- dummy_cols(traindf_le, select_columns = c("gpa_sr", "fincur", "binge", "assault", "drugs_yn", "drug_mar", "psyhx", "discrim"),      # missing isi_tot
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)

le_pca <- PCA(results_le, graph=FALSE)  # apply PCA
le_pca$eig   # output matrix with eigenvalues

eigval_le <- get_eigenvalue(le_pca)
eigval_le

# visualization for PCA, FAMD
fviz_screeplot(le_pca, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(le_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_famd_var(le_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_cos2(le_pca, choice = "var", axes = 1,
          fill = "steelblue", color = "steelblue",
          sort.val = c("desc", "asc", "none"),
          top = 40,
          xtickslab.rt = 45,
          ggtheme = theme_minimal())
```

### GLM Life event regression
```{r train glm_LE}
# prepare dataframe for regression
glm_le <- traindf.v19 %>% select(si_type, gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx, discrim)  # missing isi_tot
glm_le <- na.omit(glm_le)

# run regression
glm_le <- glm(si_type ~ gpa_sr + fincur + binge + assault + drugs_yn + drug_mar + psyhx + discrim,
              data = glm_le)
summary(glm_le)
coef(glm_le)

ci_le <- confint(glm_le)
ci_le

model.le <- tidy(glm_le)  # Convert model to dataframe for easy manipulation
model.le
model.le  %>%
   mutate(or = exp(estimate),  # Odds ratio/gradient
          var.diag = diag(vcov(glm_le)),  # Variance of each coefficient
          or.se = sqrt(or^2 * var.diag))  # Odds-ratio adjusted
```


# DEFEAT-ENTRAPMENT


```{r train Defeat frame}
traindf.v19 <- traindf.v18
```

## PHQ risk/severity
```{r train deprawsc}
traindf.v19$deprawsc <- as.numeric(traindf.v19$deprawsc)

traindf.v19 <- traindf.v19 %>%
  filter(!is.na(deprawsc))  # filters out NAs

table(traindf.v19$deprawsc, useNA ="always")


# Categorize by clinical translation for later --
traindf.v19 <- traindf.v19 %>%
  mutate(dep_none = case_when(deprawsc < 5 ~ 1,   # creates bin for no/minimal depression
                              deprawsc > 4 ~ 0)) %>%
  mutate(dep_mild = case_when((deprawsc > 4 & deprawsc < 10) ~ 1,  # bin for mild depression
                              (deprawsc < 5 | deprawsc > 9) ~ 0)) %>%
  mutate(dep_mod = case_when((deprawsc > 9 & deprawsc < 15) ~ 1,    # bin for moderate depression
                             (deprawsc > 14 | deprawsc < 10) ~ 0)) %>%
  mutate(dep_modsev = case_when((deprawsc > 14 & deprawsc < 20) ~ 1,   # bin for mod-severe depression
                               (deprawsc > 19 | deprawsc < 15) ~ 0)) %>%
  mutate(dep_sev = case_when(deprawsc > 19 ~ 1,    # bin for severe depression
                             deprawsc < 20 ~ 0)) %>%
  mutate(dep_na = case_when(is.na(deprawsc) ~ 1,   #  filter out any NAs
                            !is.na(deprawsc) ~ 0))
traindf.v19$deprawsc <- as.numeric(traindf.v19$deprawsc)

# Check outputs
table(traindf.v19$dep_none)
table(traindf.v19$dep_mild)
table(traindf.v19$dep_mod)
table(traindf.v19$dep_modsev)
table(traindf.v19$dep_sev)
table(traindf.v19$dep_na)

traindf.v19 <- traindf.v19 %>%
  mutate(dep_type = case_when(dep_none == 1 ~ 1,
                              dep_mild == 1 ~ 2,
                              dep_mod == 1 ~ 3,
                              dep_modsev == 1 ~ 4,
                              dep_sev == 1 ~ 5))

table(traindf.v19$dep_type, useNA = "always")
```

## GAD7 total
```{r train anx_score}
traindf.v19$anx_score <- as.numeric(traindf.v19$anx_score)

# Convert to severity
traindf.v20 <- traindf.v19 %>%
  mutate(anx_type = case_when(anx_score > 14 ~ 4,
                              anx_score < 5 ~ 1,      # abing for no/minimal anxiety
                              anx_score < 10 ~ 2,     # bin for mild anxiety
                              anx_score < 15 ~ 3))  %>%  # bin for severe anxiety
  filter(!is.na(anx_type))   # filters out all NAs

traindf.v20$anx_type <- as.numeric(traindf.v20$anx_type)   # check output, skew

table(traindf.v20$anx_type, useNA = "always") # check output
table(traindf.v20$anx_score, useNA = "always")
```

## Academic impact
```{r train aca_impa}
traindf.v20 <- traindf.v20 %>%
  filter(!is.na(aca_impa)) # filter for NAs
traindf.v20$aca_impa <- as.numeric(traindf.v20$aca_impa)

traindf.v20 <- traindf.v20 %>%
  mutate(aca_mh_impa = case_when(aca_anx_1 == 1 ~ 0,
                               aca_anx_2 == 2 ~ 0,
                               aca_anx_3 == 3 ~ 0,
                               aca_anx_4 == 4 ~ 1,
                               aca_anx_5 == 5 ~ 1,
                               aca_anx_6 == 6 ~ 1,
                               aca_dep_1 == 1 ~ 0,
                               aca_dep_2 == 2 ~ 0,
                               aca_dep_3 == 3 ~ 0,
                               aca_dep_4 == 4 ~ 1,
                               aca_dep_5 == 5 ~ 1,
                               aca_dep_6 == 6 ~ 1,
                               aca_eat_1 == 1 ~ 0,
                               aca_eat_2 == 2 ~ 0,
                               aca_eat_3 == 3 ~ 0,
                               aca_eat_4 == 4 ~ 1,
                               aca_eat_5 == 5 ~ 1,
                               aca_eat_6 == 6 ~ 1,
                               aca_add_1 == 1 ~ 0,
                               aca_add_2 == 2 ~ 0,
                               aca_add_3 == 3 ~ 0,
                               aca_add_4 == 4 ~ 1,
                               aca_add_5 == 5 ~ 1,
                               aca_add_6 == 6 ~ 1,
                               aca_substance_1 == 1 ~ 0,
                               aca_substance_2 == 2 ~ 0,
                               aca_substance_3 == 3 ~ 0,
                               aca_substance_4 == 4 ~ 1,
                               aca_substance_5 == 5 ~ 1,
                               aca_substance_6 == 6 ~ 1,
                               aca_phys_health_1 == 1 ~ 0,
                               aca_phys_health_2 == 2 ~ 0,
                               aca_phys_health_3 == 3 ~ 0,
                               aca_phys_health_4 == 4 ~ 1,
                               aca_phys_health_5 == 5 ~ 1,
                               aca_phys_health_6 == 6 ~ 1,
                               aca_phys_assault_1 == 1 ~ 0,
                               aca_phys_assault_2 == 2 ~ 0,
                               aca_phys_assault_3 == 3 ~ 0,
                               aca_phys_assault_4 == 4 ~ 1,
                               aca_phys_assault_5 == 5 ~ 1,
                               aca_phys_assault_6 == 6 ~ 1,
                               aca_sex_assault_1 == 1 ~ 0,
                               aca_sex_assault_2 == 2 ~ 0,
                               aca_sex_assault_3 == 3 ~ 0,
                               aca_sex_assault_4 == 4 ~ 1,
                               aca_sex_assault_5 == 5 ~ 1,
                               aca_sex_assault_6 == 6 ~ 1))

table(traindf.v20$aca_mh_impa, useNA = "always")
table(traindf.v20$aca_impa, useNA = "always") # check output, skew
```


## Depression impact
```{r train dep_impa}
traindf.v20 <- traindf.v20 %>%
  filter(!is.na(dep_impa))  # filters out NAs
traindf.v20$dep_impa <- as.numeric(traindf.v20$dep_impa)

table(traindf.v20$dep_impa, useNA = "always")  # check output, NAs, skew
```

## Anxiety impact
```{r train gad7_impa}
traindf.v20$gad7_impa <- as.numeric(traindf.v20$gad7_impa)

traindf.v20 <- traindf.v20 %>%
  filter(!is.na(gad7_impa))  # filters out NAs

table(traindf.v20$gad7_impa, useNA = "always") # check output, skew, NAs
```

# Perceived MH needs
```{r perneed}
traindf.v20 <- traindf.v20 %>%
  # reverse coding
  mutate(percneed = case_when(percneed == 1 ~ 6,  # strongly agrees that needs help
                             percneed == 2 ~ 5,
                             percneed == 3 ~ 4,
                             percneed == 4 ~ 3,
                             percneed == 5 ~ 2,
                             percneed == 6 ~ 1)) %>%  # strongly disagree that needs help
  filter(!is.na(percneed))  # filters for NAs

table(traindf.v20$percneed, useNA = "always") # check output, NAs
```

## Defeat-entrapment analysis
```{r train defeat analyses}
traindf.v21 <- traindf.v20
```

### Defeat-entrapment correlation
```{r train defeat cor}
# Define defeat variable candidates for correlation matrix
traindf_def <- traindf.v21 %>% select(aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_mh_impa, aca_impa)

 # convert traindf to numeric in order to run correlations
traindf_def <- traindf_def %>% mutate_if(is.character, as.factor)
traindf_def <-  traindf_def %>% mutate_if(is.factor, as.numeric)

# run a correlation and drop the insignificant ones
corr <- cor(traindf_def, use = "pairwise.complete.obs")                               
corr[lower.tri(corr, diag=TRUE)] <- NA        # prepare to drop duplicates and correlations of 1    
corr[corr %in% c(-1, 1)] <- NA                # drop perfect correlations
corr <- as.data.frame(as.table(corr))         # turn into a 3-column table
corr <- na.omit(corr)                         # remove the NA values from above 
corr <- corr[order(-abs(corr$Freq)),]         # sort by highest correlation
print(corr)
  
#turn corr back into matrix in order to plot with corrplot
mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
```

### PCA defeat-entrapment
```{r train PCA_def}
traindf_def <- traindf.v21 %>% select(aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, 
                                      aca_mh_impa, aca_impa)
traindf_def <- na.omit(traindf_def)

# create corr matrix, with dummy vars 
traindf_def <- traindf_def %>% 
  mutate_if(is.numeric, as.factor) %>% 
  dummy_cols(remove_first_dummy = TRUE) %>% 
  data.matrix()
# traindf_def   # check output

results_def <- dummy_cols(traindf_def, select_columns = c("aca_impa", "anx_score", "deprawsc", "percneed", "gad7_impa", 
                                                          "dep_impa", "dep_type", "anx_type", "aca_mh_impa", "aca_impa"),
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)

def_pca <- PCA(results_def, graph=FALSE)  # apply PCA
def_pca$eig   # output matrix with eigenvalues

eigval_def <- get_eigenvalue(def_pca)
# eigval_def

# visualization for PCA, FAMD
fviz_screeplot(def_pca, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(def_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_famd_var(def_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_cos2(def_pca, choice = "var", axes = 1, 
          fill = "steelblue", color = "steelblue",
          sort.val = c("desc", "asc", "none"),
          top = 40,
          xtickslab.rt = 45,
          ggtheme = theme_minimal())
```

### GLM defeat-entrapment
```{r train GLM defeat}
# prepare regression analysis
results2_def <- traindf.v21 %>% select(si_type, aca_impa, anx_score, deprawsc, percneed, 
                                       gad7_impa, dep_impa, dep_type, anx_type, aca_mh_impa, aca_impa)
glm_def <- na.omit(results2_def)

# run defeat regression
glm_def <- glm(si_type ~ aca_impa + anx_score + deprawsc + percneed + gad7_impa + 
                 dep_impa + dep_type + anx_type + aca_mh_impa + aca_impa, 
               data = glm_def)

summary(glm_def)
coef(glm_def)   # retrieve coefficients

ci_def <- confint(glm_def) # retrieve confidence intervals
ci_def

model.def <- tidy(glm_def)  # Convert model to dataframe for easy manipulation
model.def
model.def  %>%
   mutate(or = exp(estimate),  # Odds ratio/gradient
          var.diag = diag(vcov(glm_def)),  # Variance of each coefficient
          or.se = sqrt(or^2 * var.diag))  # Odds-ratio adjusted
```


# THREATS

```{r train TSM frame}
traindf.v21 <- traindf.v20
```

## Depression secret
```{r train dep_secret}
## Secretive MH
traindf.v21$dep_secret <- as.numeric(traindf.v21$dep_secret)
table(traindf.v21$dep_secret, useNA = "always")

traindf.v21 <- traindf.v21 %>%
      mutate(dep_secret = case_when(dep_secret == 6 ~ 1,
                            dep_secret == 5 ~ 2,
                            dep_secret == 4 ~ 3,
                            dep_secret == 3 ~ 4,
                            dep_secret == 2 ~ 5,
                            dep_secret == 1 ~ 6)) %>%
    filter(!is.na(dep_secret))  # filters for NAs

table(traindf.v21$dep_secret, useNA = "always")
```

## AAQ total
```{r train aaq_dum}

# create AAQ_tot variable to sum up imputed AAQ questions
traindf.v22 <- traindf.v21 %>%
  mutate(aaq_tot = as.numeric(AAQ_1) + as.numeric(AAQ_2) + as.numeric(AAQ_3) + as.numeric(AAQ_4) + 
           as.numeric(AAQ_5) + as.numeric(AAQ_6) + as.numeric(AAQ_7)) %>%
    filter(!is.na(aaq_tot))  # filters for NAs

table(traindf.v22$aaq_tot, useNA = "always") # check output
```

## Persist
```{r train persist}
traindf.v22 <- traindf.v22 %>%
# review levels
  mutate(persist = case_when(persist == 1 ~ 1,         # confident
                             persist == 2 ~ 2, 
                             persist == 3 ~ 3, 
                             persist == 4 ~ 4, 
                             persist == 5 ~ 5, 
                             persist == 6 ~ 6)) %>%    # not confident
  filter(!is.na(persist))     
traindf.v22$persist <- as.numeric(traindf.v22$persist) 

table(traindf.v22$persist, useNA = "always") # check output, skew
```

## Belonging
```{r train belong}
traindf.v22 <- traindf.v22 %>%
  filter(!is.na(belong1))  # filters out NAs
table(traindf.v22$belong1, useNA = "always")

traindf.v22 <- traindf.v22 %>%
  filter(!is.na(belong2))  # filters out NAs
table(traindf.v22$belong2, useNA = "always")

traindf.v22 <- traindf.v22 %>%
  mutate(belong8 = case_when(belong8 == 6 ~ 1,
                            belong8 == 5 ~ 2,
                            belong8 == 4 ~ 3,
                            belong8 == 3 ~ 4,
                            belong8 == 2 ~ 5,
                            belong8 == 1 ~ 6)) %>%
  filter(!is.na(belong8))  # filters out NAs

table(traindf.v22$belong8, useNA = "always")

```

## Flourishing Scale
```{r train flourish}
traindf.v22$flourish <- as.numeric(traindf.v22$flourish)

#  for loop for predictive cutoff point needed
rs_df <- data.frame("cutoff" = c(), "rs" = c())
for (i in 9:55) {
  flourish_bin <- ifelse(traindf.v22$flourish >= i, TRUE, FALSE)
  model = lm(traindf.v22$sui_idea ~ flourish_bin)
  rs_df <- rbind(rs_df, c(i, summary(model)$r.squared))

}
names(rs_df) <- c("cutoff", "rs")
rs_df_arranged <- rs_df %>% 
  arrange(desc(rs)) 
rs_df_arranged[1,1] # chi-squared high

# reverse levels for scoring
traindf.v23 <- traindf.v22 %>%
  mutate(flourish = case_when(flourish == 56 ~ 8,
                              flourish == 55 ~ 9,
                              flourish == 54 ~ 10,
                              flourish == 53 ~ 11,
                              flourish == 52 ~ 12,
                              flourish == 51 ~ 13,
                              flourish == 50 ~ 14,
                              flourish == 49 ~ 15,
                              flourish == 48 ~ 16,
                              flourish == 47 ~ 17,
                              flourish == 46 ~ 18,
                              flourish == 45 ~ 19,
                              flourish == 44 ~ 20,
                              flourish == 43 ~ 21,
                              flourish == 42 ~ 22,
                              flourish == 41 ~ 23,
                              flourish == 40 ~ 24,
                              flourish == 39 ~ 25,
                              flourish == 38 ~ 26,
                              flourish == 37 ~ 27,
                              flourish == 36 ~ 28,
                              flourish == 35 ~ 29,
                              flourish == 34 ~ 30,
                              flourish == 33 ~ 31,
                              flourish == 32 ~ 32,
                              flourish == 31 ~ 33,
                              flourish == 30 ~ 34,
                              flourish == 29 ~ 35,
                              flourish == 28 ~ 36,
                              flourish == 27 ~ 37,
                              flourish == 26 ~ 38,
                              flourish == 25 ~ 39,
                              flourish == 24 ~ 40,
                              flourish == 23 ~ 41,
                              flourish == 22 ~ 42,
                              flourish == 21 ~ 43,
                              flourish == 20 ~ 44,
                              flourish == 19 ~ 45,
                              flourish == 18 ~ 46,
                              flourish == 17 ~ 47,
                              flourish == 16 ~ 48,
                              flourish == 15 ~ 49,
                              flourish == 14 ~ 50,
                              flourish == 13 ~ 51,
                              flourish == 12 ~ 52,
                              flourish == 11 ~ 53,
                              flourish == 10 ~ 54,
                              flourish == 9 ~ 55,
                              flourish == 8 ~ 56)) %>%
  filter(!is.na(flourish))

traindf.v23$flourish <- as.numeric(traindf.v23$flourish)
table(traindf.v23$flourish, useNA = "always")

```

## Informal Mental Health Support
```{r train inf}
traindf.v23$inf_1[is.na(traindf.v23$inf_1)] <- 0
traindf.v23$inf_2[is.na(traindf.v23$inf_2)] <- 0
traindf.v23$inf_3[is.na(traindf.v23$inf_3)] <- 0
traindf.v23$inf_4[is.na(traindf.v23$inf_4)] <- 0
traindf.v23$inf_5[is.na(traindf.v23$inf_5)] <- 0
traindf.v23$inf_6[is.na(traindf.v23$inf_6)] <- 0
traindf.v23$inf_7[is.na(traindf.v23$inf_7)] <- 0

# change inf_ var to numeric
traindf.v24 <- traindf.v23 %>% 
  # create dichotomous variable for support
  mutate(inf = case_when(inf_8 == 1 ~ 0, # no informal support
                         inf_1 == 1 ~ 1, # support
                         inf_2 == 1 ~ 1,
                         inf_3 == 1 ~ 1,
                         inf_4 == 1 ~ 1,
                         inf_5 == 1 ~ 1,
                         inf_6 == 1 ~ 1,
                         inf_7 == 1 ~ 1)) %>%
  filter(!is.na(inf))  # filtters out all NAs
traindf.v24$inf <- as.logical(traindf.v24$inf)

table(traindf.v24$inf, useNA ="always") # check output, skew
```

## BRS
```{r train BRS_tot}
traindf.v24 <- traindf.v24 %>%
    mutate(BRS_1 = case_when(BRS_1 == 5 ~ 1,
                            BRS_1 == 4 ~ 2,
                            BRS_1 == 3 ~ 3,
                            BRS_1 == 2 ~ 4,
                            BRS_1 == 1 ~ 5)) %>%
    mutate(BRS_2 = case_when(BRS_2 == 5 ~ 1,
                            BRS_2 == 4 ~ 2,
                            BRS_2 == 3 ~ 3,
                            BRS_2 == 2 ~ 4,
                            BRS_2 == 1 ~ 5)) %>%
    mutate(BRS_3 = case_when(BRS_3 == 5 ~ 1,
                            BRS_3 == 4 ~ 2,
                            BRS_3 == 3 ~ 3,
                            BRS_3 == 2 ~ 4,
                            BRS_3 == 1 ~ 5)) %>%
    mutate(BRS_4 = case_when(BRS_4 == 5 ~ 1,
                            BRS_4 == 4 ~ 2,
                            BRS_4 == 3 ~ 3,
                            BRS_4 == 2 ~ 4,
                            BRS_4 == 1 ~ 5)) %>%
   mutate(BRS_5 = case_when(BRS_5 == 5 ~ 1,
                            BRS_5 == 4 ~ 2,
                            BRS_5 == 3 ~ 3,
                            BRS_5 == 2 ~ 4,
                            BRS_5 == 1 ~ 5))

traindf.v24 <- traindf.v24 %>%
  mutate(brs_tot = as.integer(BRS_1) + as.integer(BRS_2) + as.integer(BRS_3) + as.integer(BRS_4) + as.integer(BRS_5))

traindf.v24$brs_tot <- as.numeric(traindf.v24$brs_tot)

traindf.v24 <- traindf.v24 %>%
    filter(!is.na(brs_tot))  # filters out all NAs

table(traindf.v24$brs_tot, useNA = "always")
```

## Distress & social support
```{r train talk}
traindf.v24$talk1_1[is.na(traindf.v24$talk1_1)] <- 1
traindf.v24$talk1_2[is.na(traindf.v24$talk1_2)] <- 1
traindf.v24$talk1_3[is.na(traindf.v24$talk1_3)] <- 1
traindf.v24$talk1_4[is.na(traindf.v24$talk1_4)] <- 1
traindf.v24$talk1_5[is.na(traindf.v24$talk1_5)] <- 1
traindf.v24$talk1_6[is.na(traindf.v24$talk1_6)] <- 1
traindf.v24$talk1_7[is.na(traindf.v24$talk1_7)] <- 1
traindf.v24$talk1_8[is.na(traindf.v24$talk1_8)] <- 1

traindf.v25 <- traindf.v24 %>% 
  # create dictomous variable for no talking or talking to support systems
  mutate(talk = case_when((talk1_9 == 1 | talk1no == 1) ~ 1,                                    # no support
                          (talk1_2 == 1 | talk1_3 == 1 | talk1_4 == 1 | talk1_5 == 1) ~ 0,      # informal support
                          (talk1_1 == 1 | talk1_6 == 1 | talk1_7 == 1 | talk1_8 == 1) ~ 0)) %>%    # formal and informal
  filter(!is.na(talk))  # filtters out all NAs
traindf.v25$talk <- as.logical(traindf.v25$talk)

table(traindf.v25$talk, useNA = "always") # check output
```

## Perceived MH as failure, stigma
```{r train mh_stigma}
# original likert
table(traindf.v25$stig_pcv_2)
table(traindf.v25$stig_pcv_3)
table(traindf.v25$stig_per_2)
table(traindf.v25$stig_per_3)

# transform into y/n 
traindf.v26 <- traindf.v25 %>%
  mutate(stig_pcv2 = case_when((stig_pcv_2 == 1 | stig_pcv_2 == 2 | stig_pcv_2 == 3) ~ 1,
                                (stig_pcv_2 == 4 | stig_pcv_2 == 5 | stig_pcv_2 == 6) ~ 0)) %>%
  mutate(stig_pcv3 = case_when((stig_pcv_3 == 1 | stig_pcv_3 == 2 | stig_pcv_3 == 3) ~ 1,
                                (stig_pcv_3 == 4 | stig_pcv_3 == 5 | stig_pcv_3 == 6) ~ 0)) %>%  
  mutate(stig_per2 = case_when((stig_per_2 == 1 | stig_per_2 == 2 | stig_per_2 == 3) ~ 1,
                                (stig_per_2 == 4 | stig_per_2 == 5 | stig_per_2 == 6) ~ 0)) %>%
  mutate(stig_per3 = case_when((stig_per_3 == 1 | stig_per_3 == 2 | stig_per_3 == 3) ~ 1,
                                (stig_per_3 == 4 | stig_per_3 == 5 | stig_per_3 == 6) ~ 0)) 

traindf.v26$stig_pcv2 <- as.logical(traindf.v26$stig_pcv2)
traindf.v26$stig_pcv3 <- as.logical(traindf.v26$stig_pcv3)
traindf.v26$stig_per2 <- as.logical(traindf.v26$stig_per2)
traindf.v26$stig_per3 <- as.logical(traindf.v26$stig_per3)

table(traindf.v26$stig_pcv2)  # Most people feel that MH tx is a sign of personal failure.
table(traindf.v26$stig_pcv3)  # Most people think less of a person who has received MH tx.
table(traindf.v26$stig_per2)  # I feel that receiving MH tx is a sign of personal failure.
table(traindf.v26$stig_per3)  # I would think less of a person who has received MH tx.

# combine sstigma questions into one binary variable
traindf.v26 <- traindf.v26 %>%
  mutate(stig_pcv = case_when(stig_pcv2 == 1 ~ 1,
                               stig_pcv3 == 1 ~ 1,
                               stig_pcv2 == 0 ~ 0,
                               stig_pcv3 == 0 ~ 0)) %>%
  filter(!is.na(stig_pcv))  # filters out NAs
table(traindf.v26$stig_pcv, useNA = "always") # check out, NAs
                               
traindf.v26 <- traindf.v26 %>%
  mutate(stig_per = case_when(stig_per2 == 0 ~ 0,
                              stig_per3 == 0 ~ 0,
                              stig_per2 == 1 ~ 1,
                              stig_per3 == 1 ~ 1)) %>%
  filter(!is.na(stig_per))  # filters out NAs
table(traindf.v26$stig_per, useNA = "always") # check out, NAs
```

## Therapy
```{r ther}
# create new var for medication and/or therapy utilization
traindf.v26 <- traindf.v26 %>%
  mutate(ther = case_when(ther_cur == 1 ~ 1,
                          ther_cur1 == 1 ~ 1,
                          ther_ever == 3 ~ 1,
                          ther_ever == 4 ~ 1,
                              ther_cur == 0 ~ 0,
                              ther_ever == 0 ~ 0)) %>%
    filter(!is.na(ther))
traindf.v26$ther <- as.logical(traindf.v26$ther)

table(traindf.v26$ther, useNA = "always")
```

## Threats analyses
```{r train MM var analyses}
traindf.v27 <- traindf.v26
```

### Threats correlation
```{r train MMTSM_corr}
# Define MM variable candidates for correlation matrix
traindf_mm <- traindf.v27 %>% select(persist, belong1, belong2, belong8, flourish, inf, brs_tot, talk, stig_per, stig_pcv, ther, aaq_tot, dep_secret)

 # convert traindf to numeric in order to run correlations
traindf_mm <- traindf_mm %>% mutate_if(is.character, as.factor)
traindf_mm <-  traindf_mm %>% mutate_if(is.factor, as.numeric)

# run a correlation and drop the insignificant ones
corr <- cor(traindf_mm, use = "pairwise.complete.obs")                               
corr[lower.tri(corr,diag=TRUE)] <- NA                   # prepare to drop duplicates and correlations of 1    
corr[corr %in% c(-1, 1)] <- NA                          # drop perfect correlations
corr <- as.data.frame(as.table(corr))                   # turn into a 3-column table
corr <- na.omit(corr)                                   # remove the NA values from above 
corr <- corr[order(-abs(corr$Freq)),]                   # sort by highest correlation
print(corr)

mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")

```

### PCA MMTSM
```{r train PCA MMTSM}
traindf_mmtsm <- traindf.v27 %>% select(persist, belong1, belong2, belong8, flourish, inf, stig_pcv, 
                                        brs_tot, talk, stig_per, ther, aaq_tot, dep_secret)
traindf_mmtsm <- na.omit(traindf_mmtsm)

# create corr matrix, with dummy vars 
traindf_mmtsm <- traindf_mmtsm %>% 
  mutate_if(is.numeric, as.factor) %>% 
  dummy_cols(remove_first_dummy = TRUE) %>% 
  data.matrix()
# traindf_mmtsm   # check output
results_mmtsm <- dummy_cols(traindf_mmtsm, select_columns = c("persist", "belong1", "belong2", "belong8", "stig_pcv",
                                                              "flourish", "inf", "brs_tot", "talk", "ther",
                                                               "aaq_tot", "dep_secret", "stig_per"),
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)
mmtsm_pca <- PCA(results_mmtsm, graph=FALSE)  # apply PCA
eigval_mmtsm <- get_eigenvalue(mmtsm_pca)
# eigval_mmtsm

# Visualization of PCA, FAMD
fviz_screeplot(mmtsm_pca, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(mmtsm_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_famd_var(mmtsm_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_cos2(mmtsm_pca, choice = "var", axes = 1, 
          fill = "steelblue", color = "steelblue",
          sort.val = c("desc", "asc", "none"),
          top = 40,
          xtickslab.rt = 45,
          ggtheme = theme_minimal())
```

### GLM Threats regression
```{r train GLM mmtsm}
# prepare data for regression
glm_mmtsm <- traindf.v27 %>% select(si_type, persist, belong1, belong2, belong8, flourish, inf, 
                                    brs_tot, talk, stig_pcv, stig_per, ther, aaq_tot, dep_secret)
glm_mmtsm <- na.omit(glm_mmtsm)

# run MM regression
glm_mmtsm <- glm(si_type ~ persist + belong1 + belong2 + belong8 + flourish + inf + brs_tot + 
                   talk + stig_pcv + stig_per + ther + aaq_tot + dep_secret, 
              data = glm_mmtsm)

summary(glm_mmtsm)
coef_mmtsm <- coef(summary(glm_mmtsm))  # retrieve coefficients

ci_mmtsm <- confint(glm_mmtsm)  # retrieve confidence intervals
ci_mmtsm

model.mmtsm <- tidy(glm_mmtsm)  # Convert model to dataframe for easy manipulation
model.mmtsm

model.mmtsm  %>%
  mutate(or = exp(estimate),  # Odds ratio/gradient
        var.diag = diag(vcov(glm_mmtsm)),  # Variance of each coefficient
        or.se = sqrt(or^2 * var.diag))  # Odds-ratio adjusted

```

### ALL regression
```{r train GLM mm}
# prepare data for regression
glm_all <- traindf.v27 %>% select(
  # outcome
  si_type,
  # premotivation
  age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, activ_no,
  international, ins_no, satisfied_overall, residenc, religios, meds_count, dx_mh, 
  meds_any, ed_any, finpast, body_sr, days_work_paid, children_dep, discrim,
  # life events
  gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx,   # missing isi_tot
  # defeat-entrapment
  aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_impa,
  # threats to internal/external moderation
  persist, belong1, belong2, belong8, flourish, inf, brs_tot, talk, 
  stig_pcv, stig_per, ther, aaq_tot, dep_secret)

glm_all2 <- na.omit(glm_all)


# run MM regression
glm_all2 <- glm(si_type ~ ., 
              data = glm_all2)

summary(glm_all)
coef_all <- coef(summary(glm_all2))  # retrieve coefficients

ci_all <- confint(glm_all2)  # retrieve confidence intervals
ci_all

model.all <- tidy(glm_all2)  # Convert model to dataframe for easy manipulation
model.all

model.all  %>%
  mutate(or = exp(estimate),  # Odds ratio/gradient
        var.diag = diag(vcov(glm_all2)),  # Variance of each coefficient
        or.se = sqrt(or^2 * var.diag))  # Odds-ratio adjusted
```


# MISSINGNESS


## Absolute missingness, by school
```{r train structural missingness, by school}
traindf.v28 <- traindf.v26
# school structural analysis
var_names <- c(
  # outcome
  "si_type",
  # premotivation
  "age", "race", "sexual", "gender", "gender_tgd", "sib_freq", "school2_type", "env_mh", "activ_no",
  "international", "ins_no", "satisfied_overall", "residenc", "religios", "meds_count", "dx_mh", 
  "meds_any", "ed_any", "finpast", "body_sr", "days_work_paid", "children_dep", "discrim",
  # life events
  "gpa_sr", "fincur", "binge", "assault", "drugs_yn", "drug_mar", "psyhx",   # missing isi_tot
  # defeat-entrapment
  "aca_impa", "anx_score", "deprawsc", "percneed", "gad7_impa", "dep_impa", "dep_type", "anx_type", "aca_impa",
  # threats to internal/external moderation
  "persist", "belong1", "belong2", "belong8", "flourish", "inf", "brs_tot", "talk", 
  "stig_pcv", "stig_per", "ther", "aaq_tot", "dep_secret")

var_names <- sort(var_names)

# build table for absolute missingness based on school2
school2 <- count(traindf.v28, school2)
school2_ncol <- ncol(school2)

for (j in 1:length(var_names)) {
  school2[, school2_ncol + j] <- 999
}

# create column headers and vectors for school, total students, then each variable count
names <- c("school2_values", "total", var_names)
names(school2) <- names

# input values for each school missingness across all variables
for (j in 1:(length(var_names))) {
for (i in 1:nrow(school2)) {   # i corresponds to rows, j to columns
  school2[i, 2 + j] <- sum(!is.na(traindf.v28[traindf.v28$school2 == school2[[i,1]], var_names[j]]))
}
}
# add percentage in each column
school2_m <- as.matrix(school2[-1]) 
props <- school2_m[,2:ncol(school2_m)] / school2_m[,1]
school2 <- data.frame(school2[, 1:2], props)

# view missingness matrix
view(school2)

# save matrix
#write_xlsx(school2, path = "sch2_missing.xlsx", col_names = TRUE, format_headers = TRUE)
```


# DATA PREP


## Select all vars for SEM
```{r train_df_sem2}
# Prep SEM data vars
traindf_sem <- traindf.v28 %>% select(
  # outcome
  si_type, si_activ,
  # premotivation
  age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, activ_no,
  international, ins_no, satisfied_overall, residenc, religios, meds_count, dx_mh, 
  meds_any, ed_any, finpast, body_sr, days_work_paid, children_dep, discrim,
  # life events
  gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx,   # missing isi_tot
  # defeat-entrapment
  aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_impa,
  # threats to internal/external moderation
  persist, belong1, belong2, belong8, flourish, inf, brs_tot, talk, 
  stig_pcv, stig_per, ther, aaq_tot, dep_secret)  

# create sem matrix 
traindf_sem <- traindf_sem %>% 
  # mutate_if(is.numeric, as.factor) %>% 
  data.matrix()
# traindf_sem <- na.omit(traindf_sem)
# view(traindf_sem)   # check output

# # xlsx output
traindf_sem_out <- as.data.frame(traindf_sem)
save(traindf_sem_out , file = "traindf_nondummy.RData")
load("traindf_nondummy.RData")
write_xlsx(traindf_sem_out, path = "traindf_nondummy.xls", col_names = TRUE, format_headers = TRUE)
```


# SUMMARY STATISTICS


## Descriptive stats
```{r train var_sum}
data <- traindf_sem_out %>% 
  pivot_longer(cols = everything())

ggplot(data, aes(x = value)) + 
  geom_density() +
  facet_wrap(~name)

ggplot(data, aes(x = value)) + 
  geom_histogram() +
  facet_wrap(~name)

ggplot(data, aes(sample = value)) + 
  geom_qq() +
  facet_wrap(~name)

# demographics
table(traindf.v28$age)
table(traindf.v28$si_type)
table(traindf.v28$gender_tgd)
table(traindf.v28$sexual)
table(traindf.v28$race)
table(traindf.v28$dx_mh)

# training data
var_desc <- describe(traindf_sem)
view(var_desc)

# xlsx output
save(var_desc, file = "var_desc.RData")
load("var_desc.RData")
write_xlsx(var_desc, path = "var_desc.xls", col_names = TRUE, format_headers = TRUE)


# something funky is goiung on with aca_mh_impa
```

## Model w/ levels correlations
```{r train model_lev_corr}
results_corr <- NA_preproc(traindf_sem)
sig <- 0.4

# run a correlation and drop the insignificant ones 
corr <- cor(results_corr, use = "pairwise.complete.obs")                               
corr[lower.tri(corr,diag=TRUE)] <- NA                   # prepare to drop duplicates and correlations of 1    
corr[corr %in% c(-1, 1)] <- NA                          # drop perfect correlations
corr <- as.data.frame(as.table(corr))                   # turn into a 3-column table
corr <- na.omit(corr)                                   # remove the NA values from above  
corr <- subset(corr, abs(Freq) > sig)                   # select significant values  
corr <- corr[order(-abs(corr$Freq)),]                   # sort by highest correlation
print(corr)
  
#turn corr back into matrix in order to plot with corrplot
mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
```


# SEM ANALYSIS


## PLS output model
```{r amended}
# Prep SEM data vars
traindf_sem1 <- traindf.v28 %>% select(
  # outcome
  si_type, si_activ,
  # premotivation
  age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, activ_no,
  international, ins_no, satisfied_overall, residenc, religios, meds_count, dx_mh, 
  meds_any, ed_any, finpast, body_sr, days_work_paid, children_dep, discrim,
  # life events
  gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx,   # missing isi_tot
  # defeat-entrapment
  aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_impa,
  # threats to internal/external moderation
  persist, belong1, belong2, belong8, flourish, inf, brs_tot, talk, 
  stig_pcv, stig_per, ther, aaq_tot, dep_secret) 

# create sem matrix 
traindf_sem1 <- data.matrix(traindf_sem1)
  
## Dummy col SEM w/ continuous
results_tr_com1 <- dummy_cols(traindf_sem1, select_columns = c("school2_type", "residenc", "race"),
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)

# xlsx output
save(results_tr_com1, file = "traindf_pls.RData")
load("traindf_pls.RData")
write_xlsx(results_tr_com1, path = "traindf_pls_FINAL.xlsx", col_names = TRUE, format_headers = TRUE)
```



TESTING DATA


## Eating disorder, any type
```{r test ed_any}
testdf.v10 <- testdf.v10 %>%
  filter(!is.na(ed_any))  # filter out all NAs for complete data

table(testdf.v10$ed_any, useNA = "always") # check output, confirms no NAs
```

## Medication use
```{r meds_any}
# Create stimulant
testdf.v11 <- testdf.v10 %>%
  mutate(meds_sti = case_when(meds_1 == 1 ~ 1,  # combine stimulant variables
                              meds_8 == 1 ~ 0,
                              meds_1 == 0 ~ 0)) 
      # Reconcile stimulant write-ins from meds_7_text
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[V|v]yvan[s|c]e")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[T|t]enex")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[C|c]oncerta")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[A|a]dderall")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[R|r]italin")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[P|p]rovigil")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[A|a]rmodafinil")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[F|f]ocalin")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[M|m]etadat")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[F|f]ocalin")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[N|n]uvigil")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "ADHD")] <- 1
      testdf.v11$meds_sti[str_detect(testdf.v11$meds_7_text, "[M|m]odafinil")] <- 1
      testdf.v11$meds_sti[testdf.v11$meds_7_text %in% c("Vyance", "Vivance adhd", "Stratera", "Aderol", "Aderal", "Adderal",
                                                    "Adderrall (for ADHD)", "Adderal, vyvance",  "Celltech")] <- 1
      
# Create antidepressant
testdf.v11 <- testdf.v11 %>%
  mutate(meds_dep = case_when(meds_2 == 1 ~ 1,    # combine depression var types
                              meds_8 == 1 ~ 0,
                              meds_2 == 0 ~ 0))
      # reconcile write-ins for depression from med_7_text
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[C|c]elexa")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[C|c]italopram")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[C|c]ymbalta")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[E|e]scitalopram")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[L|l]exapro")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[S|s]ertraline")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[Z|z]oloft")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "SSRI")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[E|e]lavil")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[P|p]aroxetine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[P|p]rozac")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[A|a]ntidepressant")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[A|a]mitriptyline")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[D|d]uloxetine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[C|c][e|i]pralex")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[W|w]ellbutrin")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[S|s]trattera")] <- 1 
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[A|a]tomoxetine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[F|f]luvoxamine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[V|v]enlafaxine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[P|p]ristiq")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[D|d]esipramine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[V|v]iibryd")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[V|v]enlafaxin")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[C|c]lomipramine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[D|d]esvenflaxine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[M|m]irtazapine")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[R|r][e|i]meron")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[T|t]raz[a|o|i]done")] <- 1
      testdf.v11$meds_dep[str_detect(testdf.v11$meds_7_text, "[N|n]ortriptyline")] <- 1
      testdf.v11$meds_dep[testdf.v11$meds_7_text %in% c("CYMBALTA", "Cymbolta", "Lexipro", "Lexxapro", "Sertaline",
                                                    "remiron", "Mirtazepene", "bupropin", "Lexapro, Wellbutrin",
                                                    "Lexapro and Paxil", "Fuoxetine", "Duluxotine", 
                                                    "Forgot the name, anti depressant for anxiety, daily med", 
                                                    "Atomoxitine (nonstimulant ADHD)", "Fluvoximine (luvox)",
                                                    "Anafranil", "amatryptaline for migraines", "amnitryptaline", 
                                                    "Buproprion (may or may not count as a psychostim?)", 
                                                    "amatryptaline for migraines", "Minipress")] <- 1
      
# Create antipsychotic
testdf.v11 <- testdf.v11 %>%
  mutate(meds_psy = case_when(meds_3 == 1 ~ 1,   # combine anti-psychotic med vars
                              meds_8 == 1 ~ 0,
                              meds_3 == 0 ~ 0))
      # Reconcile anti-psychotic entries from med_7_text
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[A|a]bilify")] <- 1
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[A|a]bility")] <- 1
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[V|v]raylar")] <- 1
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[O|o]lanzapine")] <- 1
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[A|a]ripiprazole")] <- 1
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[L|l]atuda")] <- 1
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[S|s]eroqu[e|o]l")] <- 1
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[G|g]eodon")] <- 1
      testdf.v11$meds_psy[str_detect(testdf.v11$meds_7_text, "[Q|q]uetiapine")] <- 1
      testdf.v11$meds_psy[testdf.v11$meds_7_text %in% c("Ziprazidone", "Quitiapin", "Latuda, Giadon")] <- 1 
      
# Create anti-anxiety  
testdf.v11 <- testdf.v11 %>%            
  mutate(meds_anx = case_when(meds_4 == 1 ~ 1,  # combine anti-anxiety var types
                              meds_8 == 1 ~ 0,
                              meds_4 == 0 ~ 0))
      # Reconcile all anti-anxiety drugs from the write-ins from meds_7_text
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[X|x]anax")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[V|v]alium")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[P|p]ropranolol")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[P|p]ropanol")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[L|l]orazepam")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[N|n]eurontin")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[A|a]tarax")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[L|l]yrica")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[A|a]tivan")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[C|c]lonidine")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[P|p]razosin")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[B|b]uspar")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[V|v]istaril")] <- 1  # antihistamine
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[I|i]nderal")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[H|h]ydroxyzine")] <- 1 # antihistamine
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[K|k]lonopin")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[D|d]iazepam")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[B|b]uspirone")] <- 1
      testdf.v11$meds_anx[str_detect(testdf.v11$meds_7_text, "[G|g]abapentin")] <- 1
      testdf.v11$meds_anx[testdf.v11$meds_7_text %in% c("Valuim", "you didnt list vallium under anti-anxiety", "Alphrazolam", 
                                                   "Hydroxizine--prescribed as needed for anxiety, only took one because of adverse reaction", 
                                                   "Hydrodoxine, a blood pressure medicine for anxiety that I don't remember the name of")] <- 1

# Create mood stabilizer
testdf.v11 <- testdf.v11 %>%
  mutate(meds_mood = case_when(meds_5 == 1 ~ 1,     # combine mood stabilizer vars
                               meds_8 == 1 ~ 0,
                               meds_5 == 0 ~ 0))
      # Reconcile mood stabilizers from write-in in med_7_text
      testdf.v11$meds_mood[str_detect(testdf.v11$meds_7_text, "[L|l]ithium")] <- 1
      testdf.v11$meds_mood[str_detect(testdf.v11$meds_7_text, "[L|l]amictal")] <- 1
      testdf.v11$meds_mood[str_detect(testdf.v11$meds_7_text, "[L|l]amotrigine")] <- 1
      testdf.v11$meds_mood[str_detect(testdf.v11$meds_7_text, "[D|d]epakote")] <- 1
      testdf.v11$meds_mood[str_detect(testdf.v11$meds_7_text, "[T|t]rileptal")] <- 1
      testdf.v11$meds_mood[str_detect(testdf.v11$meds_7_text, "[O|o]xcarbarzepine")] <- 1
      testdf.v11$meds_mood[testdf.v11$meds_7_text %in% c("Mood Stabilizer/Birth Control")] <- 1
      
# Create sleep med
testdf.v11 <- testdf.v11 %>%
  mutate(meds_sle = case_when(meds_6 == 1 ~ 1,     # combine sleep meds vars
                              meds_8 == 1 ~ 0,
                              meds_6 == 0 ~ 0))
      # Reconcile sleep medications from write-ins in meds_7_text
      testdf.v11$meds_sle[str_detect(testdf.v11$meds_7_text, "[X|x]yrem")] <- 1
      testdf.v11$meds_sle[str_detect(testdf.v11$meds_7_text, "[S|s]leep")] <- 1
      testdf.v11$meds_sle[str_detect(testdf.v11$meds_7_text, "[M|m]elatonin")] <- 1
      testdf.v11$meds_sle[str_detect(testdf.v11$meds_7_text, "[Z|z]quil")] <- 1
      testdf.v11$meds_sle[str_detect(testdf.v11$meds_7_text, "[N|n]yquil")] <- 1
      testdf.v11$meds_sle[str_detect(testdf.v11$meds_7_text, "[D|d]iphenhydramine")] <- 1
      testdf.v11$meds_sle[testdf.v11$meds_7_text %in% c("gabapentin, trazodone (both for sleep on separate occasions)", 
                                                    "generic sleep medication: melatonin supplements", 
                                                    "cold medicine to induce sleep")] <- 1
      
# Create "Othermeds
testdf.v11 <- testdf.v11 %>%
  mutate(meds_oth = case_when(meds_7 == 1 ~ 1,    # combine other meds vars
                              meds_8 == 1 ~ 0,
                              meds_7 == 0 ~ 0)) 
      # Reconcile "other" entries from med_7_text
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[C|c]annabis")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[M|m]arijuana")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[W|w]eed")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[N|n]altrexone")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[S|s]ynthroid")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[T|t]opomax")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[T|t]estosterone")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[T|t]hyroid")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[H|h]ydrodocone")] <- 1 
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[C|c]lonidine")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[G|g]uanfacine")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[K|k]etamine")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[F|f]lexeril")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[P|p]ant[o|a]loc")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[S|s]pironolactone")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[H|h]ormone")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[O|o]xycodone")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[C|c]annabic")] <- 1
      testdf.v11$meds_oth[str_detect(testdf.v11$meds_7_text, "[B|b]eta")] <- 1
      testdf.v11$meds_oth[testdf.v11$meds_7_text %in% c("Canabis", "Vistiril", "Vistral", "Thyroxine", "The Reefer",
                                                    "Topimitrate", "topiramate", "Estradiol, Spironactone", 
                                                    "muscle relaxants to help me sleep", "Ondansetron" ,
                                                    "Sumatriptan for migraines", "Psilocybin Mushrooms", "clonodine",
                                                    "Muscle Relaxers", "anti-siezure medication", "Codeine", 
                                                    "Androgen Blockers", "Anti-seizure to control racing thoughts",
                                                    "Anti seizure", "Buprenorphine (Suboxone) for opiate dependence",
                                                    "Hydroxine", "Hydroxcyzine", "Alyacen", "Mirapex", 
                                                    "hypothyroid medication", "Epilepsy drugs", "Birth control",
                                                    "Methadone", "Vimpat", "Contrave", "Benztropine", "Intuniv",
                                                    "Medicinal marijuana", "Pantaloc, for psychogenic vomiting",
                                                    "medicinal Cannabis", "Testosterone Enanthate", "testosterone",
                                                    "Cannabis", "Medical marijuana")] <- 1
      
# Create a group for students who do not take any psychotropic meds
testdf.v11 <- testdf.v11 %>%
  mutate(meds_none = case_when(meds_none == 1 ~ 1,    # filter for all meds w/ none
                               meds_none == 0 ~ 0,
                               meds_sti == 1 ~ 0,
                               meds_dep == 1 ~ 0,
                               meds_psy == 1 ~ 0,
                               meds_anx == 1 ~ 0,
                               meds_mood == 1 ~ 0,
                               meds_sle == 1 ~ 0,
                               meds_oth == 1 ~ 0)) %>%
  filter(!is.na(meds_any))
  
# tabulate and check outputs
table(testdf.v11$meds_sti)
table(testdf.v11$meds_dep)
table(testdf.v11$meds_psy)
table(testdf.v11$meds_anx)
table(testdf.v11$meds_mood)
table(testdf.v11$meds_sle)
table(testdf.v11$meds_oth)
table(testdf.v11$meds_none)

table(testdf.v11$meds_any, useNA = "always")
```

## Psychopharm medication class count
```{r test med_count}
# convert all med vars to numeric for future medcount var totaling
testdf.v11$meds_1 <- as.numeric(testdf.v11$meds_1)
testdf.v11$meds_2 <- as.numeric(testdf.v11$meds_2)
testdf.v11$meds_3 <- as.numeric(testdf.v11$meds_3)
testdf.v11$meds_4 <- as.numeric(testdf.v11$meds_4)
testdf.v11$meds_5 <- as.numeric(testdf.v11$meds_5)
testdf.v11$meds_6 <- as.numeric(testdf.v11$meds_6)
testdf.v11$meds_7 <- as.numeric(testdf.v11$meds_7)
testdf.v11$meds_8 <- as.numeric(testdf.v11$meds_8)

# set any NAs equal to zero
testdf.v11$meds_1[is.na(testdf.v11$meds_1)] <- 0
testdf.v11$meds_2[is.na(testdf.v11$meds_2)] <- 0
testdf.v11$meds_3[is.na(testdf.v11$meds_3)] <- 0
testdf.v11$meds_4[is.na(testdf.v11$meds_4)] <- 0
testdf.v11$meds_5[is.na(testdf.v11$meds_5)] <- 0
testdf.v11$meds_6[is.na(testdf.v11$meds_6)] <- 0
testdf.v11$meds_7[is.na(testdf.v11$meds_7)] <- 0

# create meds_count var
testdf.v11 <- testdf.v11 %>%
  mutate(meds_count = meds_1 + meds_2 + meds_3 + meds_4 + meds_5 + meds_6 + meds_7) %>%
  mutate(meds_count = case_when(meds_count == 0 ~ 0,
                                meds_count == 1 ~ 1,
                                meds_count == 2 ~ 2, 
                                meds_count == 3 ~ 3,
                                meds_count == 4 ~ 4,
                                meds_count == 5 ~ 5,
                                meds_count == 6 ~ 6))
testdf.v11$meds_count <- as.numeric(testdf.v11$meds_count) # return var to numeric cass

table(testdf.v11$meds_count, useNA = "always")  # check output
testdf.v11 = subset(testdf.v11, select= -c(meds_1:meds_7)) # clean up vars/columns
```

```{r environment vars}
testdf.v12 <- testdf.v11
```

## Discrimination
```{r test discrim}
testdf.v12$discrim<- as.numeric(testdf.v12$discrim)

testdf.v12 <- testdf.v12 %>%
  filter(!is.na(discrim))

table(testdf.v12$discrim, useNA = "always") # check output (lots of NAs)
```

## Religion
```{r test religios}
# Label levels of religious importance
testdf.v13 <- testdf.v12 %>%
  # flip coding
  mutate(religios = case_when(religios == 1 ~ 5,   # highly religious
                              religios == 2 ~ 4,
                              religios == 3 ~ 3,
                              religios == 4 ~ 2,
                              religios == 5 ~ 1)) %>%  # not at all religious
  filter(!is.na(religios))
testdf.v13$religios <- as.numeric(testdf.v13$religios)

table(testdf.v13$religios, useNA = "always")       # Check output
```

##  Religion interaction
``` {r religios_interxn}
table(testdf.v13$social_religid, useNA = "always")

testdf.v13 <- testdf.v13 %>%   # fix directionality
  mutate(cli_relig = case_when(cli_relig_nch  == 1 ~ 5,   # hostile
                              cli_relig_nch  == 2 ~ 4,
                              cli_relig_nch  == 3 ~ 3,
                              cli_relig_nch  == 4 ~ 2,
                              cli_relig_nch  == 5 ~ 1,  # welcoming
                              cli_relig_ch  == 1 ~ 5,   # hostile
                              cli_relig_ch  == 2 ~ 4,
                              cli_relig_ch  == 3 ~ 3,
                              cli_relig_ch  == 4 ~ 2,
                              cli_relig_ch  == 5 ~ 1))  # welcoming
table(testdf.v13$cli_relig, useNA = "always")
```

## Residence type
```{r test residenc}
# re-organize living situation into on-campus, off-campus, and at home
testdf.v13 <- testdf.v13 %>%
  mutate(residenc = case_when(residenc == 1 ~ 1,  # on-campus
                              residenc == 2 ~ 1,
                              residenc == 3 ~ 2,  # coop
                              residenc == 4 ~ 2, 
                              residenc == 5 ~ 3,  # off-campus
                              residenc == 6 ~ 4,  # with family
                              residenc == 7 ~ 3)) %>%
  filter(!is.na(residenc))

table(testdf.v13$residenc, useNA = "always")  # check output
```

## Overall school satisfaction
```{r test satisfied_overall}
testdf.v13 <- testdf.v13 %>%
  mutate(satisfied_overall = case_when(satisfied_overall == 1 ~ 6,  # reverse coding
                                       satisfied_overall == 2 ~ 5,
                                       satisfied_overall == 3 ~ 4,
                                       satisfied_overall == 4 ~ 3,
                                       satisfied_overall == 5 ~ 2,
                                       satisfied_overall == 6 ~ 1)) %>% 
  filter(!is.na(satisfied_overall))  # filters out NAs
testdf.v13satisfied_overall <- as.numeric(testdf.v13$satisfied_overall)

table(testdf.v13$satisfied_overall, useNA = "always")
```
=
## Insurance coverage
```{r test ins_cover}
# create one insurance var from related questions in 'ins_' module
testdf.v13 <- testdf.v13 %>% 
  mutate(ins_no = case_when((ins_1 == 1 | ins_mh == 4 | ins_mh == 5 | ins_ade == 3) ~ 1,   # inadequate coverage
                            (ins_1 == 0 | ins_mh == 1 | ins_mh == 2 | ins_ade == 2) ~ 0)) %>% # adequate MH coverage
  filter(!is.na(ins_no))   
testdf.v13$ins_no <- as.logical(testdf.v13$ins_no) # switch class to boolean
table(testdf.v13$ins_no, useNA = "always")   # check output, skew
```

## International student
```{r test international}
testdf.v14 <- testdf.v13 %>%
  mutate(international = case_when(international == 1 ~ 1,
                                   international == 0 ~ 0)) %>%
  filter(!is.na(international))

testdf.v14$international <- as.logical(testdf.v14$international)

table(testdf.v14$international, useNA = "always")
```

## Family support
```{r test fam_support_aca}
testdf.v14$fam_support_aca <- as.numeric(testdf.v14$fam_support_aca)
table(testdf.v14$fam_support_aca, useNA = "always")  # check output (excessive NAs)
```

## Activity Involvement
```{r test activities}
# set all NAs in activities equal to 0
testdf.v14$activ_ac[is.na(testdf.v14$activ_ac)] <- 1
testdf.v14$activ_athc[is.na(testdf.v14$activ_athc)] <- 1
testdf.v14$activ_athv[is.na(testdf.v14$activ_athv)] <- 1
testdf.v14$activ_athi[is.na(testdf.v14$activ_athi)] <- 1
testdf.v14$activ_cs[is.na(testdf.v14$activ_cs)] <- 1
testdf.v14$activ_cu[is.na(testdf.v14$activ_cu)] <- 1
testdf.v14$activ_da[is.na(testdf.v14$activ_da)] <- 1
testdf.v14$activ_fs[is.na(testdf.v14$activ_fs)] <- 1
testdf.v14$activ_gs[is.na(testdf.v14$activ_gs)] <- 1
testdf.v14$activ_gov[is.na(testdf.v14$activ_gov)] <- 1
testdf.v14$activ_mp[is.na(testdf.v14$activ_md)] <- 1
testdf.v14$activ_md[is.na(testdf.v14$activ_none)] <- 1
testdf.v14$activ_soc[is.na(testdf.v14$activ_soc)] <- 1
testdf.v14$activ_rel[is.na(testdf.v14$activ_rel)] <- 1
testdf.v14$activ_art[is.na(testdf.v14$activ_art)] <- 1
testdf.v14$activ_other[is.na(testdf.v14$activ_other)] <- 1

# Create one activity variable (dichotomous) based on involvement in campus activities
testdf.v14 <- testdf.v14 %>% 
  mutate(activ_no = case_when(activ_none == 1 ~ 1,
                              activ_ac == 1 ~ 0,
                              activ_athc == 1 ~ 0,
                              activ_athv == 1 ~ 0,
                              activ_athi == 1 ~ 0,
                              activ_cs == 1 ~ 0,
                              activ_cu == 1 ~ 0,
                              activ_da == 1 ~ 0,
                              activ_fs == 1 ~ 0,
                              activ_gs == 1 ~ 0,
                              activ_gov == 1 ~ 0,
                              activ_mp == 1 ~ 0,
                              activ_md == 1 ~ 0,
                              activ_rel == 1 ~ 0,
                              activ_soc == 1 ~ 0,
                              activ_art == 1 ~ 0,
                              activ_other == 1 ~ 0))
testdf.v14$activ_no <- as.logical(testdf.v14$activ_no)

table(testdf.v14$activ_no, useNA = "always")     # tabulate and check output
testdf.v14 = subset(testdf.v14, select= -c(activ_none, activ_ac:activ_other))    # clean up vars
```

## School variable
```{r test school2}
# insert each school as a dichotomous var
testdf.v14 <- testdf.v14 %>%
  mutate(var_AlbertaCAD = ifelse((school2 == "AlbertaCAD"), 1, 0)) %>%
  mutate(var_Boston = ifelse((school2 == "Boston"), 1, 0)) %>%
  mutate(var_CIA = ifelse((school2 == "CIA"), 1, 0)) %>%
  mutate(var_CalPoly = ifelse((school2 == "CalPoly"), 1, 0)) %>%
  mutate(var_ColoradoCollege = ifelse((school2 == "ColoradoCollege"), 1, 0)) %>%
  mutate(var_ColoradoMountain = ifelse((school2 == "ColoradoMountain"), 1, 0)) %>%
  mutate(var_ColumbusCAD = ifelse((school2 == "ColumbusCAD"), 1, 0)) %>%
  mutate(var_Delaware = ifelse((school2 == "Delaware"), 1, 0)) %>%
  mutate(var_DetroitMercy = ifelse((school2 == "DetroitMercy"), 1, 0)) %>%
  mutate(var_Emerson = ifelse((school2 == "Emerson"), 1, 0)) %>%
  mutate(var_GeorgeMason = ifelse((school2 == "GeorgeMason"), 1, 0)) %>%
  mutate(var_GeorgiaTech = ifelse((school2 == "GeorgiaTech"), 1, 0)) %>%
  mutate(var_Kalamazoo = ifelse((school2 == "Kalamazoo"), 1, 0)) %>%
  mutate(var_Kansas = ifelse((school2 == "Kansas"), 1, 0)) %>%
  mutate(var_MDInstituteCollegeArt = ifelse((school2 == "MDInstituteCollegeArt"), 1, 0)) %>%
  mutate(var_MassArt = ifelse((school2 == "MassArt"), 1, 0)) %>%
  mutate(var_Merrimack = ifelse((school2 == "Merrimack"), 1, 0)) %>%
  mutate(var_MichiganState = ifelse((school2 == "MichiganState"), 1, 0)) %>%
  mutate(var_MinnesotaCAD = ifelse((school2 == "MinnesotaCAD"), 1, 0)) %>%
  mutate(var_MontclairState = ifelse((school2 == "MontclairState"), 1, 0)) %>%
  mutate(var_NHInstituteArt = ifelse((school2 == "NHInstituteArt"), 1, 0)) %>%
  mutate(var_NevadaReno = ifelse((school2 == "NevadaReno"), 1, 0)) %>%
  mutate(var_OaklandCC = ifelse((school2 == "OaklandCC"), 1, 0)) %>%
  mutate(var_OklahomaCityCC = ifelse((school2 == "OklahomaCityCC"), 1, 0)) %>%
  mutate(var_PaloAltoCollege = ifelse((school2 == "PaloAltoCollege"), 1, 0)) %>%
  mutate(var_PennCollegeTech = ifelse((school2 == "PennCollegeTech"), 1, 0)) %>%
  mutate(var_Pratt = ifelse((school2 == "RedlandsCC"), 1, 0)) %>%
  mutate(var_RhodeIsland = ifelse((school2 == "RhodeIsland"), 1, 0)) %>%
  mutate(var_RedlandsCC = ifelse((school2 == "RedlandsCC"), 1, 0)) %>%
  mutate(var_Ringling = ifelse((school2 == "Ringling"), 1, 0)) %>%
  mutate(var_Rollins = ifelse((school2 == "Rollins"), 1, 0)) %>%
  mutate(var_SAIC = ifelse((school2 == "SAIC"), 1, 0)) %>%
  mutate(var_Sewanee = ifelse((school2 == "Sewanee"), 1, 0)) %>%
  mutate(var_Smith = ifelse((school2 == "Smith"), 1, 0)) %>%
  mutate(var_SouthernNazarene = ifelse((school2 == "SouthernNazarene"), 1, 0)) %>%
  mutate(var_SouthwesternOklahomaState = ifelse((school2 == "SouthwesternOklahomaState"), 1, 0)) %>%
  mutate(var_StJohns = ifelse((school2 == "StJohns"), 1, 0)) %>%
  mutate(var_StMarys = ifelse((school2 == "StMarys"), 1, 0)) %>%
  mutate(var_StRose = ifelse((school2 == "StRose"), 1, 0)) %>%
  mutate(var_TrumanState = ifelse((school2 == "TrumanState"), 1, 0)) %>%
  mutate(var_TuftsHealthSciences = ifelse((school2 == "TuftsHealthSciences"), 1, 0)) %>%
  mutate(var_TuftsMainCampus = ifelse((school2 == "TuftsMainCampus"), 1, 0)) %>%
  mutate(var_UChicago = ifelse((school2 == "UChicago"), 1, 0)) %>%
  mutate(var_UFlorida = ifelse((school2 == "UFlorida"), 1, 0)) %>%
  mutate(var_UMDearborn = ifelse((school2 == "UMDearborn"), 1, 0)) %>%
  mutate(var_UMich = ifelse((school2 == "UMich"), 1, 0)) %>%
  mutate(var_UNCSchoolArt = ifelse((school2 == "UNCSchoolArt"), 1, 0)) %>%
  mutate(var_UTKnoxville = ifelse((school2 == "UTKnoxville"), 1, 0)) %>%
  mutate(var_UniversityofSouthernCalifornia = ifelse((school2 == "UniversityofSouthernCalifornia"), 1, 0)) %>%  
  mutate(var_Utah = ifelse((school2 == "Utah"), 1, 0)) %>%
  mutate(var_VATech = ifelse((school2 == "VATech"), 1, 0)) %>%
  mutate(var_VirginiaCommonwealth = ifelse((school2 == "VirginiaCommonwealth"), 1, 0)) %>%
  mutate(var_WakeForest = ifelse((school2 == "WakeForest"), 1, 0)) %>%
  mutate(var_Watkins = ifelse((school2 == "Watkins"), 1, 0)) %>%
  mutate(var_WestVirginia = ifelse((school2 == "WestVirginia"), 1, 0)) %>%
  mutate(var_WesternCarolina = ifelse((school2 == "WesternCarolina"), 1, 0)) %>%
  mutate(var_WesternMichigan = ifelse((school2 == "WesternMichigan"), 1, 0)) %>%
  mutate(var_WesternWA = ifelse((school2 == "WesternWA"), 1, 0)) %>%
  mutate(var_Xavier = ifelse((school2 == "Xavier"), 1, 0))
```

## MH campus environment
```{r test env_mh}
testdf.v14$env_mh <- as.factor(testdf.v14$env_mh)

testdf.v14 <- testdf.v14 %>%
  mutate(env_mh = case_when(env_mh == 5 ~ 1,
                            env_mh == 4 ~ 2,
                            env_mh == 3 ~ 3,
                            env_mh == 2 ~ 4,
                            env_mh == 1 ~ 5)) %>%
    filter(!is.na(env_mh))

table(testdf.v14$env_mh, useNA = "always")  # check output (excessive NAs)
```

### School type levels

(1) 4-year: var_Boston, var_CalPoly, var_ColoradoCollege, var_ColoradoMountain, var_Delaware, var_DetroitMercy, var_Emerson, var_GeorgeMason, var_GeorgiaTech, var_Kalamazoo, var_Kansas, var_Merrimack, var_MichiganState, var_MontclairState, var_NevadaReno, var_PennCollegeTech, var_RhodeIsland, var_Rollins, var_Sewanee, var_Smith, var_SouthernNazarene, var_SouthwesternOklahomaState, var_StJohns, var_StMarys, var_StRose, var_TrumanState, var_TuftsHealthSciences, var_TuftsMainCampus, var_UChicago, var_UFlorida, var_UMDearborn, var_UMich, var_UTKnoxville,  var_UniversityofSouthernCalifornia, var_Utah, var_VATech, var_VirginiaCommonwealth, var_WakeForest,var_WestVirginia, var_WesternCarolina, var_WesternMichigan, var_WesternWA, var_Xavier

(2) Community College: var_OaklandCC, var_OklahomaCityCC, var_PaloAltoCollege, var_RedlandsCC 

(3) Art & Design, Culinary: var_AlbertaCAD, var_CIA, var_ColumbusCAD, var_MDInstituteCollegeArt, var_MassArt, var_MinnesotaCAD, var_NHInstituteArt, var_Pratt, , var_Ringling, var_SAIC, var_UNCSchoolArt, var_Watkins, 

```{r test school2_type}
testdf.v14 <- testdf.v14 %>%
  # 4-year college
  mutate(school2_4yr = ifelse(var_Boston + var_CalPoly + var_ColoradoCollege + var_ColoradoMountain + var_Delaware +
                                var_DetroitMercy + var_Emerson + var_GeorgeMason + var_GeorgiaTech + var_Kalamazoo + 
                                var_Kansas + var_Merrimack + var_MichiganState + var_MontclairState + var_NevadaReno +
                                var_PennCollegeTech + var_RhodeIsland + var_Rollins + var_Sewanee + var_Smith +
                                var_SouthernNazarene + var_SouthwesternOklahomaState + var_StJohns + var_StMarys + var_StRose +
                                var_TrumanState + var_TuftsHealthSciences + var_TuftsMainCampus + var_UChicago + var_UFlorida +
                                var_UMDearborn + var_UMich + var_UTKnoxville + var_UniversityofSouthernCalifornia + var_Utah +
                                var_VATech + var_VirginiaCommonwealth + var_WakeForest + var_WestVirginia + 
                                var_WesternCarolina + var_WesternMichigan + var_WesternWA + var_Xavier == 1, TRUE,
                              ifelse(
                                var_Boston + var_CalPoly + var_ColoradoCollege + var_ColoradoMountain + var_Delaware +
                                  var_DetroitMercy + var_Emerson + var_GeorgeMason + var_GeorgiaTech + var_Kalamazoo +
                                  var_Kansas + var_Merrimack + var_MichiganState + var_MontclairState + var_NevadaReno +
                                  var_PennCollegeTech + var_RhodeIsland + var_Rollins + var_Sewanee + var_Smith +
                                  var_SouthernNazarene + var_SouthwesternOklahomaState + var_StJohns + var_StMarys + 
                                  var_StRose + var_TrumanState + var_TuftsHealthSciences + var_TuftsMainCampus + var_UChicago +
                                  var_UFlorida + var_UMDearborn + var_UMich + var_UTKnoxville +
                                  var_UniversityofSouthernCalifornia + var_Utah + var_VATech + var_VirginiaCommonwealth +
                                  var_WakeForest + var_WestVirginia + var_WesternCarolina + var_WesternMichigan +
                                  var_WesternWA + var_Xavier == 0, FALSE, NA))) %>%
    
  # Community colleges
    mutate(school2_cc = ifelse(var_OaklandCC + var_OklahomaCityCC + var_PaloAltoCollege + var_RedlandsCC == 1, TRUE, 
                               ifelse(var_OaklandCC + var_OklahomaCityCC + var_PaloAltoCollege + var_RedlandsCC == 0, FALSE, NA))) %>%
    
  # Art, design, culinary
    mutate(school2_ad = ifelse(var_AlbertaCAD + var_CIA + var_ColumbusCAD + var_MDInstituteCollegeArt + 
                                 var_MassArt + var_MinnesotaCAD + var_NHInstituteArt + var_Pratt + var_Ringling +
                                 var_SAIC + var_UNCSchoolArt + var_Watkins == 1, TRUE, 
                               ifelse(
                                 var_AlbertaCAD + var_CIA + var_ColumbusCAD + var_MDInstituteCollegeArt +
                                   var_MassArt + var_MinnesotaCAD + var_NHInstituteArt + var_Pratt + 
                                   var_Ringling + var_SAIC + var_UNCSchoolArt + var_Watkins == 0, FALSE, NA)))

# Binary variable for school type
table(testdf.v14$school2_4yr)
table(testdf.v14$school2_cc)
table(testdf.v14$school2_ad)

#  create one school type variables
testdf.v14 <- testdf.v14 %>%
  mutate(school2_type = case_when(school2_4yr == TRUE ~ 1,
                                  school2_cc == TRUE ~ 2,
                                  school2_ad == TRUE ~ 3)) %>%
  filter(!is.na(school2_type))
testdf.v14$school2_type <- as.factor(testdf.v14$school2_type)

table(testdf.v14$school2_type, useNA = "always") # check output
```

## PREMOTIVATION ANALYSES
```{r test env analysis}
testdf.v15 <- testdf.v14  # new dataframe for analysis
```

Premotivation correlation
```{r test results_prem}
# Define diathesis vars for correlation matrix
testdf_prem <- testdf.v15 %>% select(si_type, age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh,
                                       international, ins_no, satisfied_overall, residenc, religios, meds_count, dx_mh, 
                                       meds_any, ed_any, finpast, body_sr, days_work_paid, children_dep, discrim, activ_no)

# Corr_simple function
corr_simple <- function(testdf=testdf_prem, sig=0.6){
  # convert testdf to numeric in order to run correlations 
  testdf_prem <- testdf_prem %>% mutate_if(is.character, as.factor)
  testdf_prem <-  testdf_prem %>% mutate_if(is.factor, as.numeric)
  # run a correlation and drop the insignificant ones
  corr <- cor(testdf_prem, use = "pairwise.complete.obs")                               
  corr[lower.tri(corr,diag=TRUE)] <- NA                   # prepare to drop duplicates and correlations of 1    
  corr[corr %in% c(-1, 1)] <- NA                          # drop perfect correlations
  corr <- as.data.frame(as.table(corr))                   # turn into a 3-column table
  corr <- na.omit(corr)                                   # remove the NA values from above 
  corr <- corr[order(-abs(corr$Freq)),]                   # sort by highest correlation
  print(corr)
  
  #turn corr back into matrix in order to plot with corrplot
  mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
  corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
}
corr_simple()

```

## PCA PREMOTIVATION
```{r test prem_pca}
# Define diathesis vars for correlation matrix
testdf_prem <- testdf.v15 %>% select(age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, international, ins_no, 
                                       satisfied_overall, residenc, religios, meds_count, dx_mh, meds_any, ed_any, finpast, activ_no,
                                       body_sr, days_work_paid, children_dep, discrim)
testdf_prem <- na.omit(testdf_prem)

# create corr matrix, with dummy vars
testdf_prem <- testdf_prem %>% 
  mutate_if(is.numeric, as.factor) %>% 
  dummy_cols(remove_first_dummy = TRUE) %>% 
  data.matrix()
# testdf_prem   # check output

results_prem <- dummy_cols(testdf_prem, select_columns = c("age", "race", "sexual", "gender", "gender_tgd", "sib_freq", "school2_type", 
                                                            "env_mh", "international", "ins_no", "satisfied_overall", "residenc", "religios", 
                                                            "meds_count", "dx_mh", "meds_any", "ed_any", "finpast", "body_sr", "activ_no",
                                                            "days_work_paid", "children_dep", "discrim"),
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)

prem_pca <- PCA(results_prem, graph=FALSE)  # apply PCA
prem_pca$eig   # output matrix with eigenvalues

eigval_prem <- get_eigenvalue(prem_pca)
# eigval_prem

# visualization for PCA, FAMD
fviz_screeplot(prem_pca, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(prem_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_famd_var(prem_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_cos2(prem_pca, choice = "var", axes = 1,
          fill = "steelblue", color = "steelblue",
          sort.val = c("desc", "asc", "none"),
          top = 40,
          xtickslab.rt = 45,
          ggtheme = theme_minimal())
```

## GLM Premotivation regression
```{r test clm_prem}
glm_prem <- testdf.v15 %>% select(si_type, age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, international, ins_no, 
                                       satisfied_overall, residenc, religios, meds_count, dx_mh, meds_any, ed_any, finpast, activ_no,
                                       body_sr, days_work_paid, children_dep, discrim)
glm_prem <- na.omit(glm_prem)

# run regression
glm_prem <- glm(si_type ~ age + race + sexual + gender + gender_tgd + sib_freq + school2_type + env_mh + international + ins_no + 
                  satisfied_overall + residenc + religios + meds_count + dx_mh + meds_any + ed_any + finpast + body_sr + activ_no +
                  days_work_paid + children_dep + discrim,
              data = glm_prem)
summary(glm_prem)
coef(glm_prem)   # retrieve coefficients

ci_prem <- confint(glm_prem)  # retrieve confidence intervals
ci_prem

model.prem <- tidy(glm_prem)  # Convert model to dataframe
model.prem
model.prem  %>%
   mutate(or = exp(estimate),               # Odds ratio/gradient
          var.diag = diag(vcov(glm_prem)),  # Variance of each coefficient
          or.se = sqrt(or^2 * var.diag))    # Odds-ratio adjusted
```


# LIFE EVENTS


```{r test LE frame}
testdf.v15 <- testdf.v14 
```

## Illicit drug use
Creates illicit drug use var (limitation -- 30 days reflection)
```{r test drugs_yn}
## adjusted for nested question status 
testdf.v15$drug_coc[is.na(testdf.v15$drug_coc)] <- 0
testdf.v15$drug_her[is.na(testdf.v15$drug_her)] <- 0
testdf.v15$drug_met[is.na(testdf.v15$drug_met)] <- 0
testdf.v15$drug_stim[is.na(testdf.v15$drug_stim)] <- 0
testdf.v15$drug_ect[is.na(testdf.v15$drug_ect)] <- 0
testdf.v15$drug_opi[is.na(testdf.v15$drug_opi)] <- 0
testdf.v15$drug_other[is.na(testdf.v15$drug_other)] <- 0

# visualize current output before transformation
table(testdf.v15$drug_coc)
table(testdf.v15$drug_her)     # too small
table(testdf.v15$drug_met)     # too small
table(testdf.v15$drug_stim)
table(testdf.v15$drug_ect)     # too small
table(testdf.v15$drug_opi)     # too small
table(testdf.v15$drug_other)   # too vague, small

# Sample is too small to analyze individual drugs, except for marijuana. 
# Transform to illicit drug y/n
testdf.v15 <- testdf.v15 %>%
  mutate(drugs_yn = case_when(drug_coc == 1 ~ 1,
                              drug_her == 1 ~ 1,
                              drug_met == 1 ~ 1,
                              drug_stim == 1 ~ 1,
                              drug_ect == 1 ~ 1,
                              drug_opi == 1 ~ 1,
                              drug_other == 1 ~ 1))
testdf.v15$drugs_yn[is.na(testdf.v15$drugs_yn)] <- 0
testdf.v15$drugs_yn <- as.logical(testdf.v15$drugs_yn)

table(testdf.v15$drugs_yn, useNA = "always")
```

## Marijuana use
```{r test drug_mar}
testdf.v15$drug_mar[is.na(testdf.v15$drug_mar)] <- 0

testdf.v15 <- testdf.v15 %>%
  mutate(drug_mar = case_when(drug_mar == 1 ~ 1, 
                              drug_mar == 0 ~ 0)) %>%
  filter(!is.na(drug_mar))  # filters out NAs
testdf.v15$drug_mar <- as.logical(testdf.v15$drug_mar)

table(testdf.v15$drug_mar, useNA = "always")
```

## Current financial stressors
```{r test fincur}
testdf.v16 <- testdf.v15 %>% 
  # make dichotomous
  mutate(fincur = case_when(fincur == 3 ~ 0,  # sometimes
                            fincur == 4 ~ 0,  # rarely or never
                            fincur == 5 ~ 0,
                            fincur == 1 ~ 1,  # always or often stressful
                            fincur == 2 ~ 1)) %>%
  filter(!is.na(fincur))                      # filters for NAs
testdf.v16$fincur <- as.logical(testdf.v16$fincur)

table(testdf.v16$fincur, useNA = "always")  # check output, skew
```

## ISI scale
```{r test isi_tot}

# something weird is going on here, too.


testdf.v16$isi_1 <- as.numeric(testdf.v16$isi_1)
testdf.v16$isi_2 <- as.numeric(testdf.v16$isi_2)
testdf.v16$isi_3 <- as.numeric(testdf.v16$isi_3)
testdf.v16$isi_4 <- as.numeric(testdf.v16$isi_4)
testdf.v16$isi_5 <- as.numeric(testdf.v16$isi_5)
testdf.v16$isi_6 <- as.numeric(testdf.v16$isi_6)
testdf.v16$isi_7 <- as.numeric(testdf.v16$isi_7)
testdf.v16$isi_total <- as.numeric(testdf.v16$isi_total)

table(testdf.v16$isi_1)
table(testdf.v16$isi_2)
table(testdf.v16$isi_3)
table(testdf.v16$isi_4)
table(testdf.v16$isi_5)
table(testdf.v16$isi_6)
table(testdf.v16$isi_7)

testdf.v16$isi_tot <- testdf.v16$isi_1 + testdf.v16$isi_2 + testdf.v16$isi_3 + testdf.v16$isi_4 + testdf.v16$isi_5 + testdf.v16$isi_6 + testdf.v16$isi_7

table(testdf.v16$isi_tot, useNA = "always")
table(testdf.v16$isi_total)
```

## Abuse or assault, in the last year only
```{r test assault}
table(testdf.v16$abuse_life)
table(testdf.v16$abuse_recent) 

# create dichotomous variable called 'abuse_year' to reflect abuse that occurred in last 12 months
testdf.v17 <- testdf.v16 %>%
  mutate(abuse_year = case_when(abuse_recent == 1 ~ 1,
                                abuse_recent == 2 ~ 1,
                                abuse_recent == 3 ~ 1,
                                abuse_recent == 4 ~ 0,
                                abuse_recent == 5 ~ 0,
                                abuse_life == 0 ~ 0)) %>%
  filter(!is.na(abuse_life))
table(testdf.v17$abuse_year)   # check output

# restructure sexual assault var
testdf.v17 <- testdf.v17 %>%
  mutate(assault = case_when(
                             assault_sex == 1 ~ 1,
                             assault_emo == 1 ~ 1,
                             assault_phys == 1 ~ 1, 
                             abuse_year == 1 ~ 1,
                             abuse_year == 0 ~ 0,
                             assault_sex == 2 ~ 0,
                             assault_emo == 0 ~ 0,
                             assault_phys == 1 ~ 0)) %>%
  mutate(assault = case_when(assault == 1 ~ 1,
                             assault == 0 ~ 0)) %>%
  filter(!is.na(assault))
testdf.v17$assault <- as.logical(testdf.v17$assault)

# tabulate and check output
table(testdf.v17$assault, useNA = "always") 
```

## Binging frequency
```{r test binge}
# set all binge_fr values equal to 0
testdf.v17$binge_fr_f[is.na(testdf.v17$binge_fr_f)] <- 0
testdf.v17$binge_fr_m[is.na(testdf.v17$binge_fr_m)] <- 0
testdf.v17$binge_fr_o[is.na(testdf.v17$binge_fr_o)] <- 0 

# create one binge var
testdf.v18 <- testdf.v17 %>% 
  mutate(binge_fr = as.numeric(binge_fr_f) + as.numeric(binge_fr_m) + as.numeric(binge_fr_o))
table(testdf.v18$binge_fr)

testdf.v18 <- testdf.v18 %>%
  mutate(binge = case_when(binge_fr >= 4 ~ 1,
                           binge_fr < 4 ~ 0)) %>%
  filter(!is.na(binge))
testdf.v18$binge <-as.logical(testdf.v18$binge)

table(testdf.v18$binge, useNA = "always") # check output

testdf.v18 = subset(testdf.v18, select= -c(binge_fr_f, binge_fr_m, binge_fr_o)) # clean up var
```

## Recent Psychiatric Hospitalization, last 12 months
```{r test psyhx}
# Create variable for any psychiatric hospitalization in the last 12 months
testdf.v18 <- testdf.v18 %>% 
  mutate(psyhx = case_when((prov_pes == 1 | prov_inp == 1 | prov_par == 1) ~ 1, # inpatient, IOPs, etc.
                           (prov_pes == 0 & prov_inp == 0 & prov_par == 0) ~ 0, # no crises intervened on
                           ther_ever == 0 ~ 0)) %>%
  filter(!is.na(psyhx))  # filter out NAs
testdf.v18$psyhx <- as.logical(testdf.v18$psyhx)  # change class to boolean

table(testdf.v18$psyhx, useNA = "always")   # check output, skew
```

## Current GPA
```{r test gpa_sr}
testdf.v18 <- testdf.v18 %>% 
# bin grades to As, Bs, Cs, and D+ and below
  mutate(gpa_sr = case_when(gpa_sr == 0 ~ 1,   # A+
                            gpa_sr == 1 ~ 1,   # A
                            gpa_sr == 2 ~ 1,   # A-
                            gpa_sr == 3 ~ 2,   # B+
                            gpa_sr == 4 ~ 2,   # B
                            gpa_sr == 5 ~ 2,   # B-
                            gpa_sr == 6 ~ 3,   # C+
                            gpa_sr == 7 ~ 3,   # C
                            gpa_sr == 8 ~ 3,   # C-
                            gpa_sr == 9 ~ 4,   # D+ and below
                            gpa_sr == 10 ~ 5)) %>%  # Don't know
      filter(!is.na(gpa_sr))  # filter out NAs
testdf.v18$gpa_sr <- as.numeric(testdf.v18$gpa_sr) # change to numeric scale

table(testdf.v18$gpa_sr, useNA = "always")  # check output, skew
jarque.bera.test(testdf.v18$gpa_sr)
```
 
 ## Academic failure
```{r test failed}
table(testdf.v18$failed, useNA = "always")
```
 
 
## Life events analyses 
```{r test LE analysis}
testdf.v19 <- testdf.v18
``` 
 
### LE correlation
```{r test LE correlation}
# Define life event var candidates for correlation matrix
testdf_le <- testdf.v19 %>% select(gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx)   # still missing isi_tot

# convert testdf to numeric in order to run correlations
testdf_le <- testdf_le %>% mutate_if(is.character, as.factor)
testdf_le <-  testdf_le %>% mutate_if(is.factor, as.numeric)

# run a correlation and drop the insignificant ones
corr <- cor(testdf_le, use = "pairwise.complete.obs")                               
corr[lower.tri(corr,diag=TRUE)] <- NA                   # prepare to drop dups and correlations of 1    
corr[corr %in% c(-1, 1)] <- NA                          # drop perfect correlations
corr <- as.data.frame(as.table(corr))                   #turn into a 3-column table
corr <- na.omit(corr)                                   #remove the NA values from above 
corr <- corr[order(-abs(corr$Freq)),]                   #sort by highest correlation
print(corr)
  
#turn corr back into matrix in order to plot with corrplot
mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
```

### PCA LE
```{r test le_pca}
testdf_le <- testdf.v19 %>% select(gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx, discrim)   # missing isi_tot
testdf_le <- na.omit(testdf_le)

# create corr matrix, with dummy vars
testdf_le <- testdf_le %>% 
  mutate_if(is.numeric, as.factor) %>% 
  dummy_cols(remove_first_dummy = TRUE) %>% 
  data.matrix()
# testdf_le   # check output

results_le <- dummy_cols(testdf_le, select_columns = c("gpa_sr", "fincur", "binge", "assault", "drugs_yn", "drug_mar", "psyhx", "discrim"),      # missing isi_tot
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)

le_pca <- PCA(results_le, graph=FALSE)  # apply PCA
le_pca$eig   # output matrix with eigenvalues

eigval_le <- get_eigenvalue(le_pca)
eigval_le

# visualization for PCA, FAMD
fviz_screeplot(le_pca, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(le_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_famd_var(le_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_cos2(le_pca, choice = "var", axes = 1,
          fill = "steelblue", color = "steelblue",
          sort.val = c("desc", "asc", "none"),
          top = 40,
          xtickslab.rt = 45,
          ggtheme = theme_minimal())
```

### GLM Life event regression
```{r test glm_LE}
# prepare dataframe for regression
glm_le <- testdf.v19 %>% select(si_type, gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx, discrim)  # missing isi_tot
glm_le <- na.omit(glm_le)

# run regression
glm_le <- glm(si_type ~ gpa_sr + fincur + binge + assault + drugs_yn + drug_mar + psyhx + discrim,
              data = glm_le)
summary(glm_le)
coef(glm_le)

ci_le <- confint(glm_le)
ci_le

model.le <- tidy(glm_le)  # Convert model to dataframe for easy manipulation
model.le
model.le  %>%
   mutate(or = exp(estimate),  # Odds ratio/gradient
          var.diag = diag(vcov(glm_le)),  # Variance of each coefficient
          or.se = sqrt(or^2 * var.diag))  # Odds-ratio adjusted
```


# DEFEAT-ENTRAPMENT


```{r test Defeat frame}
testdf.v20 <- testdf.v18
```

## PHQ risk/severity
```{r test deprawsc}
testdf.v20$deprawsc <- as.numeric(testdf.v20$deprawsc)

testdf.v20 <- testdf.v20 %>%
  filter(!is.na(deprawsc))  # filters out NAs

table(testdf.v20$deprawsc, useNA ="always")


# Categorize by clinical translation for later --
testdf.v20 <- testdf.v20 %>%
  mutate(dep_none = case_when(deprawsc < 5 ~ 1,   # creates bin for no/minimal depression
                              deprawsc > 4 ~ 0)) %>%
  mutate(dep_mild = case_when((deprawsc > 4 & deprawsc < 10) ~ 1,  # bin for mild depression
                              (deprawsc < 5 | deprawsc > 9) ~ 0)) %>%
  mutate(dep_mod = case_when((deprawsc > 9 & deprawsc < 15) ~ 1,    # bin for moderate depression
                             (deprawsc > 14 | deprawsc < 10) ~ 0)) %>%
  mutate(dep_modsev = case_when((deprawsc > 14 & deprawsc < 20) ~ 1,   # bin for mod-severe depression
                               (deprawsc > 19 | deprawsc < 15) ~ 0)) %>%
  mutate(dep_sev = case_when(deprawsc > 19 ~ 1,    # bin for severe depression
                             deprawsc < 20 ~ 0)) %>%
  mutate(dep_na = case_when(is.na(deprawsc) ~ 1,   #  filter out any NAs
                            !is.na(deprawsc) ~ 0))
testdf.v20$deprawsc <- as.numeric(testdf.v20$deprawsc)

# Check outputs
table(testdf.v20$dep_none)
table(testdf.v20$dep_mild)
table(testdf.v20$dep_mod)
table(testdf.v20$dep_modsev)
table(testdf.v20$dep_sev)
table(testdf.v20$dep_na)

testdf.v20 <- testdf.v20 %>%
  mutate(dep_type = case_when(dep_none == 1 ~ 1,
                              dep_mild == 1 ~ 2,
                              dep_mod == 1 ~ 3,
                              dep_modsev == 1 ~ 4,
                              dep_sev == 1 ~ 5))

table(testdf.v20$dep_type, useNA = "always")
```

## GAD7 total
```{r test anx_score}
testdf.v20$anx_score <- as.numeric(testdf.v20$anx_score)

# Convert to severity
testdf.v20 <- testdf.v20 %>%
  mutate(anx_type = case_when(anx_score > 14 ~ 4,
                              anx_score < 5 ~ 1,      # abing for no/minimal anxiety
                              anx_score < 10 ~ 2,     # bin for mild anxiety
                              anx_score < 15 ~ 3))  %>%  # bin for severe anxiety
  filter(!is.na(anx_type))   # filters out all NAs

testdf.v20$anx_type <- as.numeric(testdf.v20$anx_type)   # check output, skew

table(testdf.v20$anx_type, useNA = "always") # check output
table(testdf.v20$anx_score, useNA = "always")
```

## Academic impact
```{r test aca_impa}
testdf.v20 <- testdf.v20 %>%
  filter(!is.na(aca_impa)) # filter for NAs
testdf.v20$aca_impa <- as.numeric(testdf.v20$aca_impa)

testdf.v20 <- testdf.v20 %>%
  mutate(aca_mh_impa = case_when(aca_anx_1 == 1 ~ 0,
                               aca_anx_2 == 2 ~ 0,
                               aca_anx_3 == 3 ~ 0,
                               aca_anx_4 == 4 ~ 1,
                               aca_anx_5 == 5 ~ 1,
                               aca_anx_6 == 6 ~ 1,
                               aca_dep_1 == 1 ~ 0,
                               aca_dep_2 == 2 ~ 0,
                               aca_dep_3 == 3 ~ 0,
                               aca_dep_4 == 4 ~ 1,
                               aca_dep_5 == 5 ~ 1,
                               aca_dep_6 == 6 ~ 1,
                               aca_eat_1 == 1 ~ 0,
                               aca_eat_2 == 2 ~ 0,
                               aca_eat_3 == 3 ~ 0,
                               aca_eat_4 == 4 ~ 1,
                               aca_eat_5 == 5 ~ 1,
                               aca_eat_6 == 6 ~ 1,
                               aca_add_1 == 1 ~ 0,
                               aca_add_2 == 2 ~ 0,
                               aca_add_3 == 3 ~ 0,
                               aca_add_4 == 4 ~ 1,
                               aca_add_5 == 5 ~ 1,
                               aca_add_6 == 6 ~ 1,
                               aca_substance_1 == 1 ~ 0,
                               aca_substance_2 == 2 ~ 0,
                               aca_substance_3 == 3 ~ 0,
                               aca_substance_4 == 4 ~ 1,
                               aca_substance_5 == 5 ~ 1,
                               aca_substance_6 == 6 ~ 1,
                               aca_phys_health_1 == 1 ~ 0,
                               aca_phys_health_2 == 2 ~ 0,
                               aca_phys_health_3 == 3 ~ 0,
                               aca_phys_health_4 == 4 ~ 1,
                               aca_phys_health_5 == 5 ~ 1,
                               aca_phys_health_6 == 6 ~ 1,
                               aca_phys_assault_1 == 1 ~ 0,
                               aca_phys_assault_2 == 2 ~ 0,
                               aca_phys_assault_3 == 3 ~ 0,
                               aca_phys_assault_4 == 4 ~ 1,
                               aca_phys_assault_5 == 5 ~ 1,
                               aca_phys_assault_6 == 6 ~ 1,
                               aca_sex_assault_1 == 1 ~ 0,
                               aca_sex_assault_2 == 2 ~ 0,
                               aca_sex_assault_3 == 3 ~ 0,
                               aca_sex_assault_4 == 4 ~ 1,
                               aca_sex_assault_5 == 5 ~ 1,
                               aca_sex_assault_6 == 6 ~ 1))

table(testdf.v20$aca_mh_impa, useNA = "always")
table(testdf.v20$aca_impa, useNA = "always") # check output, skew
```


## Depression impact
```{r test dep_impa}
testdf.v20 <- testdf.v20 %>%
  filter(!is.na(dep_impa))  # filters out NAs
testdf.v20$dep_impa <- as.numeric(testdf.v20$dep_impa)

table(testdf.v20$dep_impa, useNA = "always")  # check output, NAs, skew
```

## Anxiety impact
```{r test gad7_impa}
testdf.v20$gad7_impa <- as.numeric(testdf.v20$gad7_impa)

testdf.v20 <- testdf.v20 %>%
  filter(!is.na(gad7_impa))  # filters out NAs

table(testdf.v20$gad7_impa, useNA = "always") # check output, skew, NAs
```

# Perceived MH needs
```{r perneed}
testdf.v20 <- testdf.v20 %>%
  # reverse coding
  mutate(percneed = case_when(percneed == 1 ~ 6,  # strongly agrees that needs help
                             percneed == 2 ~ 5,
                             percneed == 3 ~ 4,
                             percneed == 4 ~ 3,
                             percneed == 5 ~ 2,
                             percneed == 6 ~ 1)) %>%  # strongly disagree that needs help
  filter(!is.na(percneed))  # filters for NAs

table(testdf.v20$percneed, useNA = "always") # check output, NAs
```

## Defeat-entrapment analysis
```{r test defeat analyses}
testdf.v21 <- testdf.v20
```

### Defeat-entrapment correlation
```{r test defeat cor}
# Define defeat variable candidates for correlation matrix
testdf_def <- testdf.v21 %>% select(aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_impa)

 # convert testdf to numeric in order to run correlations
testdf_def <- testdf_def %>% mutate_if(is.character, as.factor)
testdf_def <-  testdf_def %>% mutate_if(is.factor, as.numeric)

# run a correlation and drop the insignificant ones
corr <- cor(testdf_def, use = "pairwise.complete.obs")                               
corr[lower.tri(corr, diag=TRUE)] <- NA        # prepare to drop duplicates and correlations of 1    
corr[corr %in% c(-1, 1)] <- NA                # drop perfect correlations
corr <- as.data.frame(as.table(corr))         # turn into a 3-column table
corr <- na.omit(corr)                         # remove the NA values from above 
corr <- corr[order(-abs(corr$Freq)),]         # sort by highest correlation
print(corr)
  
#turn corr back into matrix in order to plot with corrplot
mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
```

### PCA defeat-entrapment
```{r test PCA_def}
testdf_def <- testdf.v21 %>% select(aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_impa)
testdf_def <- na.omit(testdf_def)

# create corr matrix, with dummy vars 
testdf_def <- testdf_def %>% 
  mutate_if(is.numeric, as.factor) %>% 
  dummy_cols(remove_first_dummy = TRUE) %>% 
  data.matrix()
# testdf_def   # check output

results_def <- dummy_cols(testdf_def, select_columns = c("aca_impa", "anx_score", "deprawsc", "percneed", "gad7_impa", 
                                                          "dep_impa", "dep_type", "anx_type", "aca_impa"),
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)

def_pca <- PCA(results_def, graph=FALSE)  # apply PCA
def_pca$eig   # output matrix with eigenvalues

eigval_def <- get_eigenvalue(def_pca)
# eigval_def

# visualization for PCA, FAMD
fviz_screeplot(def_pca, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(def_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_famd_var(def_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_cos2(def_pca, choice = "var", axes = 1, 
          fill = "steelblue", color = "steelblue",
          sort.val = c("desc", "asc", "none"),
          top = 40,
          xtickslab.rt = 45,
          ggtheme = theme_minimal())
```

### GLM defeat-entrapment
```{r test GLM defeat}
# prepare regression analysis
results2_def <- testdf.v21 %>% select(si_type, aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_impa)
glm_def <- na.omit(results2_def)

# run defeat regression
glm_def <- glm(si_type ~ aca_impa + anx_score + deprawsc + percneed + gad7_impa + dep_impa + dep_type + anx_type + aca_impa, 
               data = glm_def)

summary(glm_def)
coef(glm_def)   # retrieve coefficients

ci_def <- confint(glm_def) # retrieve confidence intervals
ci_def

model.def <- tidy(glm_def)  # Convert model to dataframe for easy manipulation
model.def
model.def  %>%
   mutate(or = exp(estimate),  # Odds ratio/gradient
          var.diag = diag(vcov(glm_def)),  # Variance of each coefficient
          or.se = sqrt(or^2 * var.diag))  # Odds-ratio adjusted
```


# THREATS

```{r test TSM frame}
testdf.v21 <- testdf.v20
```

## Depression secret
```{r test dep_secret}
## Secretive MH
testdf.v21$dep_secret <- as.numeric(testdf.v21$dep_secret)
table(testdf.v21$dep_secret, useNA = "always")

testdf.v21 <- testdf.v21 %>%
    mutate(dep_secret = case_when(dep_secret == 6 ~ 1,
                            dep_secret == 5 ~ 2,
                            dep_secret == 4 ~ 3,
                            dep_secret == 3 ~ 4,
                            dep_secret == 2 ~ 5,
                            dep_secret == 1 ~ 6)) %>%
    filter(!is.na(dep_secret))  # filters for NAs

table(testdf.v21$dep_secret, useNA = "always")
```

## AAQ total
```{r test aaq_dum}

# create AAQ_tot variable to sum up imputed AAQ questions
testdf.v22 <- testdf.v21 %>%
  mutate(aaq_tot = as.numeric(AAQ_1) + as.numeric(AAQ_2) + as.numeric(AAQ_3) + as.numeric(AAQ_4) + 
           as.numeric(AAQ_5) + as.numeric(AAQ_6) + as.numeric(AAQ_7)) %>%
    filter(!is.na(aaq_tot))  # filters for NAs

table(testdf.v22$aaq_tot, useNA = "always") # check output
```

## Persist
```{r test persist}
testdf.v22 <- testdf.v22 %>%
# review levels
  mutate(persist = case_when(persist == 1 ~ 1,         # confident
                             persist == 2 ~ 2, 
                             persist == 3 ~ 3, 
                             persist == 4 ~ 4, 
                             persist == 5 ~ 5, 
                             persist == 6 ~ 6)) %>%    # not confident
  filter(!is.na(persist))     
testdf.v22$persist <- as.numeric(testdf.v22$persist) 

table(testdf.v22$persist, useNA = "always") # check output, skew
```

## Belonging
```{r test belong}
testdf.v22 <- testdf.v22 %>%
  filter(!is.na(belong1))  # filters out NAs
table(testdf.v22$belong1, useNA = "always")

testdf.v22 <- testdf.v22 %>%
  filter(!is.na(belong2))  # filters out NAs
table(testdf.v22$belong2, useNA = "always")

testdf.v22 <- testdf.v22 %>%
    mutate(belong8 = case_when(belong8 == 6 ~ 1,
                            belong8 == 5 ~ 2,
                            belong8 == 4 ~ 3,
                            belong8 == 3 ~ 4,
                            belong8 == 2 ~ 5,
                            belong8 == 1 ~ 6)) %>%
  filter(!is.na(belong8))  # filters out NAs
table(testdf.v22$belong8, useNA = "always")

```

## Flourishing Scale
```{r test flourish}
testdf.v22$flourish <- as.numeric(testdf.v22$flourish)

#  for loop for predictive cutoff point needed
rs_df <- data.frame("cutoff" = c(), "rs" = c())
for (i in 9:55) {
  flourish_bin <- ifelse(testdf.v22$flourish >= i, TRUE, FALSE)
  model = lm(testdf.v22$sui_idea ~ flourish_bin)
  rs_df <- rbind(rs_df, c(i, summary(model)$r.squared))

}
names(rs_df) <- c("cutoff", "rs")
rs_df_arranged <- rs_df %>% 
  arrange(desc(rs)) 
rs_df_arranged[1,1] # chi-squared high

# reverse levels for scoring
testdf.v23 <- testdf.v22 %>%
  mutate(flourish = case_when(flourish == 56 ~ 8,
                              flourish == 55 ~ 9,
                              flourish == 54 ~ 10,
                              flourish == 53 ~ 11,
                              flourish == 52 ~ 12,
                              flourish == 51 ~ 13,
                              flourish == 50 ~ 14,
                              flourish == 49 ~ 15,
                              flourish == 48 ~ 16,
                              flourish == 47 ~ 17,
                              flourish == 46 ~ 18,
                              flourish == 45 ~ 19,
                              flourish == 44 ~ 20,
                              flourish == 43 ~ 21,
                              flourish == 42 ~ 22,
                              flourish == 41 ~ 23,
                              flourish == 40 ~ 24,
                              flourish == 39 ~ 25,
                              flourish == 38 ~ 26,
                              flourish == 37 ~ 27,
                              flourish == 36 ~ 28,
                              flourish == 35 ~ 29,
                              flourish == 34 ~ 30,
                              flourish == 33 ~ 31,
                              flourish == 32 ~ 32,
                              flourish == 31 ~ 33,
                              flourish == 30 ~ 34,
                              flourish == 29 ~ 35,
                              flourish == 28 ~ 36,
                              flourish == 27 ~ 37,
                              flourish == 26 ~ 38,
                              flourish == 25 ~ 39,
                              flourish == 24 ~ 40,
                              flourish == 23 ~ 41,
                              flourish == 22 ~ 42,
                              flourish == 21 ~ 43,
                              flourish == 20 ~ 44,
                              flourish == 19 ~ 45,
                              flourish == 18 ~ 46,
                              flourish == 17 ~ 47,
                              flourish == 16 ~ 48,
                              flourish == 15 ~ 49,
                              flourish == 14 ~ 50,
                              flourish == 13 ~ 51,
                              flourish == 12 ~ 52,
                              flourish == 11 ~ 53,
                              flourish == 10 ~ 54,
                              flourish == 9 ~ 55,
                              flourish == 8 ~ 56)) %>%
  filter(!is.na(flourish))

testdf.v23$flourish <- as.numeric(testdf.v23$flourish)
table(testdf.v23$flourish, useNA = "always")
```

## Informal Mental Health Support
```{r test inf}
testdf.v23$inf_1[is.na(testdf.v23$inf_1)] <- 0
testdf.v23$inf_2[is.na(testdf.v23$inf_2)] <- 0
testdf.v23$inf_3[is.na(testdf.v23$inf_3)] <- 0
testdf.v23$inf_4[is.na(testdf.v23$inf_4)] <- 0
testdf.v23$inf_5[is.na(testdf.v23$inf_5)] <- 0
testdf.v23$inf_6[is.na(testdf.v23$inf_6)] <- 0
testdf.v23$inf_7[is.na(testdf.v23$inf_7)] <- 0

# change inf_ var to numeric
testdf.v24 <- testdf.v23 %>% 
  # create dichotomous variable for support
  mutate(inf = case_when(inf_8 == 1 ~ 0, # no informal support
                         inf_1 == 1 ~ 1, # support
                         inf_2 == 1 ~ 1,
                         inf_3 == 1 ~ 1,
                         inf_4 == 1 ~ 1,
                         inf_5 == 1 ~ 1,
                         inf_6 == 1 ~ 1,
                         inf_7 == 1 ~ 1)) %>%
  filter(!is.na(inf))  # filtters out all NAs
testdf.v24$inf <- as.logical(testdf.v24$inf)

table(testdf.v24$inf, useNA ="always") # check output, skew
```

## BRS
```{r test BRS_tot}
testdf.v24 <- testdf.v24 %>%
    mutate(BRS_1 = case_when(BRS_1 == 5 ~ 1,
                            BRS_1 == 4 ~ 2,
                            BRS_1 == 3 ~ 3,
                            BRS_1 == 2 ~ 4,
                            BRS_1 == 1 ~ 5)) %>%
    mutate(BRS_2 = case_when(BRS_2 == 5 ~ 1,
                            BRS_2 == 4 ~ 2,
                            BRS_2 == 3 ~ 3,
                            BRS_2 == 2 ~ 4,
                            BRS_2 == 1 ~ 5)) %>%
    mutate(BRS_3 = case_when(BRS_3 == 5 ~ 1,
                            BRS_3 == 4 ~ 2,
                            BRS_3 == 3 ~ 3,
                            BRS_3 == 2 ~ 4,
                            BRS_3 == 1 ~ 5)) %>%
    mutate(BRS_4 = case_when(BRS_4 == 5 ~ 1,
                            BRS_4 == 4 ~ 2,
                            BRS_4 == 3 ~ 3,
                            BRS_4 == 2 ~ 4,
                            BRS_4 == 1 ~ 5)) %>%
   mutate(BRS_5 = case_when(BRS_5 == 5 ~ 1,
                            BRS_5 == 4 ~ 2,
                            BRS_5 == 3 ~ 3,
                            BRS_5 == 2 ~ 4,
                            BRS_5 == 1 ~ 5))

testdf.v24 <- testdf.v24 %>%
  mutate(brs_tot = as.integer(BRS_1) + as.integer(BRS_2) + as.integer(BRS_3) + as.integer(BRS_4) + as.integer(BRS_5))

testdf.v24$brs_tot <- as.numeric(testdf.v24$brs_tot)

testdf.v24 <- testdf.v24 %>%
    filter(!is.na(brs_tot))  # filters out all NAs

table(testdf.v24$brs_tot, useNA = "always")
```

## Distress & social support
```{r test talk}
testdf.v24$talk1_1[is.na(testdf.v24$talk1_1)] <- 1
testdf.v24$talk1_2[is.na(testdf.v24$talk1_2)] <- 1
testdf.v24$talk1_3[is.na(testdf.v24$talk1_3)] <- 1
testdf.v24$talk1_4[is.na(testdf.v24$talk1_4)] <- 1
testdf.v24$talk1_5[is.na(testdf.v24$talk1_5)] <- 1
testdf.v24$talk1_6[is.na(testdf.v24$talk1_6)] <- 1
testdf.v24$talk1_7[is.na(testdf.v24$talk1_7)] <- 1
testdf.v24$talk1_8[is.na(testdf.v24$talk1_8)] <- 1

testdf.v25 <- testdf.v24 %>% 
  # create dictomous variable for no talking or talking to support systems
  mutate(talk = case_when((talk1_9 == 1 | talk1no == 1) ~ 1,                                    # no support
                          (talk1_2 == 1 | talk1_3 == 1 | talk1_4 == 1 | talk1_5 == 1) ~ 0,      # informal support
                          (talk1_1 == 1 | talk1_6 == 1 | talk1_7 == 1 | talk1_8 == 1) ~ 0)) %>%    # formal and informal
  filter(!is.na(talk))  # filtters out all NAs
testdf.v25$talk <- as.logical(testdf.v25$talk)

table(testdf.v25$talk, useNA = "always") # check output
```

## Perceived MH as failure, stigma
```{r test mh_stigma}
# original likert
table(testdf.v25$stig_pcv_2)
table(testdf.v25$stig_pcv_3)
table(testdf.v25$stig_per_2)
table(testdf.v25$stig_per_3)

# transform into y/n 
testdf.v26 <- testdf.v25 %>%
  mutate(stig_pcv2 = case_when((stig_pcv_2 == 1 | stig_pcv_2 == 2 | stig_pcv_2 == 3) ~ 1,
                                (stig_pcv_2 == 4 | stig_pcv_2 == 5 | stig_pcv_2 == 6) ~ 0)) %>%
  mutate(stig_pcv3 = case_when((stig_pcv_3 == 1 | stig_pcv_3 == 2 | stig_pcv_3 == 3) ~ 1,
                                (stig_pcv_3 == 4 | stig_pcv_3 == 5 | stig_pcv_3 == 6) ~ 0)) %>%  
  mutate(stig_per2 = case_when((stig_per_2 == 1 | stig_per_2 == 2 | stig_per_2 == 3) ~ 1,
                                (stig_per_2 == 4 | stig_per_2 == 5 | stig_per_2 == 6) ~ 0)) %>%
  mutate(stig_per3 = case_when((stig_per_3 == 1 | stig_per_3 == 2 | stig_per_3 == 3) ~ 1,
                                (stig_per_3 == 4 | stig_per_3 == 5 | stig_per_3 == 6) ~ 0)) 

testdf.v26$stig_pcv2 <- as.logical(testdf.v26$stig_pcv2)
testdf.v26$stig_pcv3 <- as.logical(testdf.v26$stig_pcv3)
testdf.v26$stig_per2 <- as.logical(testdf.v26$stig_per2)
testdf.v26$stig_per3 <- as.logical(testdf.v26$stig_per3)

table(testdf.v26$stig_pcv2)  # Most people feel that MH tx is a sign of personal failure.
table(testdf.v26$stig_pcv3)  # Most people think less of a person who has received MH tx.
table(testdf.v26$stig_per2)  # I feel that receiving MH tx is a sign of personal failure.
table(testdf.v26$stig_per3)  # I would think less of a person who has received MH tx.

# combine sstigma questions into one binary variable
testdf.v26 <- testdf.v26 %>%
  mutate(stig_pcv = case_when(stig_pcv2 == 1 ~ 1,
                               stig_pcv3 == 1 ~ 1,
                               stig_pcv2 == 0 ~ 0,
                               stig_pcv3 == 0 ~ 0)) %>%
  filter(!is.na(stig_pcv))  # filters out NAs
table(testdf.v26$stig_pcv, useNA = "always") # check out, NAs
                               
testdf.v26 <- testdf.v26 %>%
  mutate(stig_per = case_when(stig_per2 == 0 ~ 0,
                              stig_per3 == 0 ~ 0,
                              stig_per2 == 1 ~ 1,
                              stig_per3 == 1 ~ 1)) %>%
  filter(!is.na(stig_per))  # filters out NAs
table(testdf.v26$stig_per, useNA = "always") # check out, NAs
```

## Therapy
```{r ther}
# create new var for medication and/or therapy utilization
testdf.v26 <- testdf.v26 %>%
  mutate(ther = case_when(ther_cur == 1 ~ 1,
                          ther_cur1 == 1 ~ 1,
                          ther_ever == 3 ~ 1,
                          ther_ever == 4 ~ 1,
                              ther_cur == 0 ~ 0,
                              ther_ever == 0 ~ 0)) %>%
    filter(!is.na(ther))
testdf.v26$ther <- as.logical(testdf.v26$ther)

table(testdf.v26$ther, useNA = "always")
```

## Threats analyses
```{r test MM var analyses}
testdf.v27 <- testdf.v26
```

### Threats correlation
```{r test MMTSM_corr}
# Define MM variable candidates for correlation matrix
testdf_mm <- testdf.v27 %>% select(persist, belong1, belong2, belong8, flourish, inf, brs_tot, talk, stig_per, stig_pcv, ther, aaq_tot, dep_secret)

 # convert testdf to numeric in order to run correlations
testdf_mm <- testdf_mm %>% mutate_if(is.character, as.factor)
testdf_mm <-  testdf_mm %>% mutate_if(is.factor, as.numeric)

# run a correlation and drop the insignificant ones
corr <- cor(testdf_mm, use = "pairwise.complete.obs")                               
corr[lower.tri(corr,diag=TRUE)] <- NA                   # prepare to drop duplicates and correlations of 1    
corr[corr %in% c(-1, 1)] <- NA                          # drop perfect correlations
corr <- as.data.frame(as.table(corr))                   # turn into a 3-column table
corr <- na.omit(corr)                                   # remove the NA values from above 
corr <- corr[order(-abs(corr$Freq)),]                   # sort by highest correlation
print(corr)

mtx_corr <- acast(corr, Var1~Var2, value.var="Freq")  
corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")

```

### PCA MMTSM
```{r test PCA MMTSM}
testdf_mmtsm <- testdf.v27 %>% select(persist, belong1, belong2, belong8, flourish, inf, stig_pcv, 
                                        brs_tot, talk, stig_per, ther, aaq_tot, dep_secret)
testdf_mmtsm <- na.omit(testdf_mmtsm)

# create corr matrix, with dummy vars 
testdf_mmtsm <- testdf_mmtsm %>% 
  mutate_if(is.numeric, as.factor) %>% 
  dummy_cols(remove_first_dummy = TRUE) %>% 
  data.matrix()
# testdf_mmtsm   # check output
results_mmtsm <- dummy_cols(testdf_mmtsm, select_columns = c("persist", "belong1", "belong2", "belong8", "stig_pcv",
                                                              "flourish", "inf", "brs_tot", "talk", "ther",
                                                               "aaq_tot", "dep_secret", "stig_per"),
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)
mmtsm_pca <- PCA(results_mmtsm, graph=FALSE)  # apply PCA
eigval_mmtsm <- get_eigenvalue(mmtsm_pca)
# eigval_mmtsm

# Visualization of PCA, FAMD
fviz_screeplot(mmtsm_pca, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_var(mmtsm_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_famd_var(mmtsm_pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
fviz_cos2(mmtsm_pca, choice = "var", axes = 1, 
          fill = "steelblue", color = "steelblue",
          sort.val = c("desc", "asc", "none"),
          top = 40,
          xtickslab.rt = 45,
          ggtheme = theme_minimal())
```

### GLM Threats regression
```{r test GLM mmtsm}
# prepare data for regression
glm_mmtsm <- testdf.v27 %>% select(si_type, persist, belong1, belong2, belong8, flourish, inf, 
                                    brs_tot, talk, stig_pcv, stig_per, ther, aaq_tot, dep_secret)
glm_mmtsm <- na.omit(glm_mmtsm)

# run MM regression
glm_mmtsm <- glm(si_type ~ persist + belong1 + belong2 + belong8 + flourish + inf + brs_tot + 
                   talk + stig_pcv + stig_per + ther + aaq_tot + dep_secret, 
              data = glm_mmtsm)

summary(glm_mmtsm)
coef_mmtsm <- coef(summary(glm_mmtsm))  # retrieve coefficients

ci_mmtsm <- confint(glm_mmtsm)  # retrieve confidence intervals
ci_mmtsm

model.mmtsm <- tidy(glm_mmtsm)  # Convert model to dataframe for easy manipulation
model.mmtsm

model.mmtsm  %>%
  mutate(or = exp(estimate),  # Odds ratio/gradient
        var.diag = diag(vcov(glm_mmtsm)),  # Variance of each coefficient
        or.se = sqrt(or^2 * var.diag))  # Odds-ratio adjusted

```



# TESTING DATA PREP


## Select all vars for SEM
```{r testdf_sem}
# Prep SEM data vars
testdf_sem <- testdf.v26 %>% select(
  # outcome
  si_type, si_activ,
  # premotivation
  age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, activ_no,
  international, ins_no, satisfied_overall, residenc, religios, meds_count, dx_mh, 
  meds_any, ed_any, finpast, body_sr, days_work_paid, children_dep, discrim,
  # life events
  gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx,   # missing isi_tot
  # defeat-entrapment
  aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_impa,
  # threats to internal/external moderation
  persist, belong1, belong2, belong8, flourish, inf, brs_tot, talk, 
  stig_pcv, stig_per, ther, aaq_tot, dep_secret)  

# create sem matrix 
testdf_sem <- testdf_sem %>% 
  # mutate_if(is.numeric, as.factor) %>% 
  data.matrix()
# testdf_sem <- na.omit(testdf_sem)
# view(testdf_sem)   # check output

# # xlsx output
testdf_sem_out <- as.data.frame(testdf_sem)
save(testdf_sem_out , file = "testdf_nondummy.RData")
load("testdf_nondummy.RData")
write_xlsx(testdf_sem_out, path = "testdf_nondummy.xls", col_names = TRUE, format_headers = TRUE)
```



# SUMMARY STATISTICS


## Descriptive stats
```{r var_sum_test}
# demographics
table(testdf.v26$age)
table(testdf.v26$si_type)
table(testdf.v26$gender_tgd)
table(testdf.v26$sexual)
table(testdf.v26$race)
table(testdf.v26$dx_mh)

# training data
var_desc_test <- describe(testdf_sem)
view(var_desc_test)

# xlsx output
save(var_desc_test, file = "var_desc_test.RData")
load("var_desc_test.RData")
write_xlsx(var_desc_test, path = "var_desc_test.xls", col_names = TRUE, format_headers = TRUE)
```


# SEM ANALYSIS


## PLS output model
```{r results_test}
# Prep SEM data vars
testdf_sem1 <- testdf.v26 %>% select(
  # outcome
  si_type, si_activ,
  # premotivation
  age, race, sexual, gender, gender_tgd, sib_freq, school2_type, env_mh, activ_no,
  international, ins_no, satisfied_overall, residenc, religios, meds_count, dx_mh, 
  meds_any, ed_any, finpast, body_sr, days_work_paid, children_dep, discrim,
  # life events
  gpa_sr, fincur, binge, assault, drugs_yn, drug_mar, psyhx,   # missing isi_tot
  # defeat-entrapment
  aca_impa, anx_score, deprawsc, percneed, gad7_impa, dep_impa, dep_type, anx_type, aca_impa,
  # threats to internal/external moderation
  persist, belong1, belong2, belong8, flourish, inf, brs_tot, talk, 
  stig_pcv, stig_per, ther, aaq_tot, dep_secret)  

# create sem matrix 
testdf_sem1 <- data.matrix(testdf_sem1)
  
## Dummy col SEM w/ continuous
results_test <- dummy_cols(testdf_sem1, select_columns = c("race", "residenc", "school2_type"),
                         remove_first_dummy = TRUE, remove_selected_columns = TRUE)

# xlsx output
save(results_test, file = "testdf_pls.RData")
load("testdf_pls.RData")
write_xlsx(results_test, path = "testdf_pls_FINAL.xlsx", col_names = TRUE, format_headers = TRUE)
```


```{r review}
class(aaq_tot)

```